<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Joe&#39;s blog</title>
  
  <subtitle>emmmmm</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://joeljt.top/"/>
  <updated>2019-04-15T09:24:13.834Z</updated>
  <id>http://joeljt.top/</id>
  
  <author>
    <name>joe</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ä¸€ä¸ªè‡ªå®šä¹‰ View çš„å°æ•ˆæœ</title>
    <link href="http://joeljt.top/2019/04/15/custom-view-parallax/"/>
    <id>http://joeljt.top/2019/04/15/custom-view-parallax/</id>
    <published>2019-04-14T16:00:00.000Z</published>
    <updated>2019-04-15T09:24:13.834Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ç®€å•å­¦äº†ä¸€ä¸ªè‡ªå®šä¹‰ View çš„å°æ•ˆæœï¼Œæœ¬èº«ä»£ç å¹¶ä¸ç®—å¤šï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰äº›æ–°ä¸œè¥¿ï¼Œæœ¬ç€å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´çš„æƒ³æ³•ï¼Œè¿˜æ˜¯è¦è®°å½•ä¸‹æ¥å¤‡å¿˜ï¼Œè¯´ä¸ä¸Šä»€ä¹ˆæ—¶å€™å°±ä¼šç”¨åˆ°ã€‚</p><a id="more"></a><h3 id="æ•ˆæœå±•ç¤º"><a href="#æ•ˆæœå±•ç¤º" class="headerlink" title="æ•ˆæœå±•ç¤º"></a>æ•ˆæœå±•ç¤º</h3><p>æ•´ä½“æ•ˆæœå¤§æ¦‚å¦‚å›¾ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190414212815.gif" alt=""></p><h3 id="çŸ¥è¯†ç‚¹æ¦‚å†µ"><a href="#çŸ¥è¯†ç‚¹æ¦‚å†µ" class="headerlink" title="çŸ¥è¯†ç‚¹æ¦‚å†µ"></a>çŸ¥è¯†ç‚¹æ¦‚å†µ</h3><p>æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹å…¶å®å°±é‚£ä¹ˆå‡ ä¸ªï¼Œä¸»è¦è¿˜æ˜¯æ€è·¯å’Œç¼–ç é£æ ¼é—®é¢˜ï¼›ç›¸åŒçš„æ•ˆæœç”¨å¸ƒå±€æ‘†æ”¾ï¼Œå†åŠ ä¸Šç›‘å¬ ViewPager æ»šåŠ¨å®Œå…¨å¯ä»¥å®ç°ï¼Œä¸è¿‡å°±æ˜¯æ‰©å±•æ€§å¤ªå·®ï¼Œå¥å£®æ€§ä¸å¤ªå¥½ï¼Œä¹Ÿä¸æ»¡è¶³å°è£…çš„è¦æ±‚ï¼Œæœ¬æ¬¡å®ç°åŸºæœ¬å®Œå…¨ä½¿ç”¨è‡ªå®šä¹‰ View å®ç°ï¼Œä¹Ÿæ˜¯ä¸ªä¸é”™çš„æ€è·¯ã€‚</p><p>éœ€è¦æ³¨æ„çš„çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p><ol><li>æœ€åˆè®¾è®¡çš„æ—¶å€™å°±è¦è€ƒè™‘åˆ°å°è£…ï¼Œä»£ç è€¦åˆæ€§æ˜¯ä¸æ˜¯è¶³å¤Ÿä½ï¼Œæ‰©å±•æ€§æ˜¯ä¸æ˜¯è¶³å¤Ÿå¼ºï¼›</li><li>è‡ªå®šä¹‰ View çš„ç”Ÿå‘½å‘¨æœŸï¼Œå› ä¸ºä½ éœ€è¦ç¡®å®š onMeasure æ–¹æ³•ä½•æ—¶æ‰§è¡Œå®Œæ¯•ï¼Œä»è€Œåœ¨åˆé€‚çš„ä½ç½®è¿›è¡Œå‚æ•°çš„åˆå§‹åŒ–å·¥ä½œï¼Œä¿è¯æµ‹é‡å®Œæˆï¼Œæ‰€ä»¥éœ€è¦çš„ç©ºé—´éƒ½å¯ä»¥å–åˆ°å®½é«˜ä¿¡æ¯ï¼›</li><li>å±æ€§åŠ¨ç”»çš„åŸºæœ¬ä½¿ç”¨ï¼›</li><li>Canvas#drawColor è®¾ç½®èƒŒæ™¯è‰²</li><li>Canvas#drawCircle è¦æ³¨æ„åœ†å¿ƒçš„ä½ç½®æ˜¯åœ¨å±å¹•çš„å·¦ä¸Šé¡¶ç‚¹ï¼Œå±å¹•ä¸­å¿ƒçš„ä½ç½®éœ€è¦è‡ªå·±ç¡®å®šï¼›</li><li>ç»˜åˆ¶åœ†ç¯éœ€è¦æ­£ç¡®ç¡®å®šåœ†ç¯çš„åŠå¾„ï¼ŒåŒæ—¶è¦è€ƒè™‘åˆ°ä¸å±å¹•ç›¸åˆ‡çš„ä½ç½®é—®é¢˜ï¼›</li><li>å¦‚ä½•æ‹¦æˆª View çš„åˆ›å»ºï¼Œå¹¶ä»ä¸­å»è§£æè‡ªå®šä¹‰å±æ€§</li></ol><p>ä¸‹é¢æŠŠæ•´ä¸ªè‡ªå®šä¹‰ View æ‹†è§£æˆå‡ ä¸ªéƒ¨åˆ†æ¥è®°å½•ï¼Œå¤§æ¦‚ä¹Ÿå°±æ˜¯ä¸Šé¢çš„çŸ¥è¯†ç‚¹ï¼Œä¹Ÿæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œéƒ½æ˜¯ç†Ÿèƒ½ç”Ÿå·§çš„ä¸œè¥¿ï¼Œpractice makes perfectï¼Œæ²¡æ¯›ç—…ã€‚</p><h3 id="æ—‹è½¬æ•ˆæœ"><a href="#æ—‹è½¬æ•ˆæœ" class="headerlink" title="æ—‹è½¬æ•ˆæœ"></a>æ—‹è½¬æ•ˆæœ</h3><p>å…ˆæ¥åˆ†æä¸€ä¸‹è¿™ä¸ªæ•ˆæœ</p><ol><li>å…­ä¸ªå°åœ†å‡åŒ€åˆ†å¸ƒåœ¨å¤§åœ†ä¸Šï¼Œæ¯ä¸ªæ‰‡å½¢çš„è§’åº¦ç›¸åŒï¼Œä¹Ÿå°±æ˜¯ 60Â°ï¼›</li><li>æ•´ä½“å›´æˆä¸€ä¸ªå¤§åœ†ï¼Œä¸æ–­æ—‹è½¬ï¼Œå¤§åœ†ä½äºå±å¹•æ­£ä¸­ï¼Œç›´å¾„ä¸ºå±å¹•å®½åº¦çš„ 1/2ï¼›</li><li>å…­ä¸ªåœ†ä¸åœçš„å˜æ¢ä½ç½®ï¼Œä½†æ€»ä½“ä½ç½®æœªå‘ç”Ÿå˜åŒ–ï¼Œä»è€Œå±•ç°å‡ºå›´ç€å¤§åœ†æ—‹è½¬çš„æ•ˆæœï¼›</li></ol><p>åˆ†æå®Œæ¯•åï¼Œæˆ‘ä»¬é¦–å…ˆè¦å¯¹è¯¸å¦‚ç”»ç¬”é¢œè‰²ï¼Œå±å¹•å®½é«˜ä¿¡æ¯ç­‰è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™ä¸ªå·¥ä½œåªéœ€è¦æ‰§è¡Œä¸€æ¬¡ï¼Œæˆ‘ä»¬é€‰æ‹©åœ¨ onLayout æ–¹æ³•ä¸­å®Œæˆï¼Œå› ä¸ºéœ€è¦è·å– View æµ‹é‡åçš„å®½é«˜ä¿¡æ¯ã€‚</p><pre><code class="java">private void initParams(Context context) {    // è·å–é¢œè‰²åˆ—è¡¨    mColorArray = context.getResources().getIntArray(R.array.splash_circle_colors);    // è·å–å¤§åœ†ã€å°åœ†çš„åŠå¾„    mBigCircleRadius = getMeasuredWidth() / 4;    mSmallCircleRadius = mBigCircleRadius / 7;    // åˆå§‹åŒ–ç”»ç¬”    mPaint = new Paint();    mPaint.setDither(true);    mPaint.setAntiAlias(true);    // è·å–å±å¹•ä¸­å¿ƒä½ç½®çš„åæ ‡    mCenterX = getMeasuredWidth() / 2;    mCenterY = getMeasuredHeight() / 2;}</code></pre><p>åˆå§‹åŒ–å·¥ä½œå®Œæˆåï¼ŒåŠå¾„æœ‰äº†ï¼Œç”»ç¬”ä¹Ÿæœ‰äº†ï¼Œç°åœ¨éœ€è¦ç¡®å®šçš„æ˜¯æ¯ä¸ªå°åœ†åœ†å¿ƒçš„ä½ç½®ï¼š</p><pre><code class="java">public void drawCircle(float cx, float cy, float radius, @NonNull Paint paint)</code></pre><p>å¤§å®¶éƒ½å­¦è¿‡ä¸‰è§’å‡½æ•°ï¼Œå¾ˆæ˜æ˜¾å°åœ†çš„åœ†å¿ƒåœ¨å¤§åœ†åœ†å‘¨ä¸Šï¼Œé‚£ä¹ˆå¤§åœ†çš„åŠå¾„æ˜¯å·²çŸ¥çš„ï¼Œæ¯ä¸ªæ‰‡å½¢çš„è§’åº¦ä¹Ÿæ˜¯å·²çŸ¥çš„ï¼Œæ ¹æ®ä¸‰è§’å‡½æ•°å¾ˆå®¹æ˜“å°±èƒ½æ±‚å‡ºæ¥æ¯ä¸ªå°åœ†åœ†å¿ƒå‘ç›´å¾„åšå‚çº¿æ‰€å¾—åˆ°çš„è·ç¦»ï¼Œè¿™ä¸ªè·ç¦»åˆæ˜¯ç›¸å¯¹äºå¤§åœ†åœ†å¿ƒçš„è·ç¦»ï¼Œå¤§åœ†åœ†å¿ƒåæ ‡å·²çŸ¥ï¼Œå¾ˆæ˜¾ç„¶å°±èƒ½æ±‚å¾—æ¯ä¸ªå°åœ†çš„åæ ‡ä¿¡æ¯ã€‚</p><p>ç°åœ¨çš„é—®é¢˜æ˜¯ï¼Œæ€ä¹ˆè®©è¿™ä¸ªå°åœ†è½¬èµ·æ¥ï¼Ÿ</p><p>è¿™é‡Œæˆ‘ä»¬çš„è§£å†³åŠæ³•æ˜¯ï¼Œåˆ©ç”¨ä¸€ä¸ªå±æ€§åŠ¨ç”»ï¼Œä» 0 å˜åŒ–åˆ° 2Ï€ï¼Œä¹Ÿå°±æ˜¯æ•´ä¸ªåœ†å‘¨ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸æ–­åœ°å»é‡ç»˜ Viewï¼Œç„¶ååœ¨ onDraw ä¸­æ›´æ–°æ¯ä¸ªå°åœ†å½“å‰çš„ä½ç½®ï¼Œé€šè¿‡é‡ç»˜æ¥å®ç°ä¸æ–­æ»šåŠ¨æ•ˆæœã€‚</p><p>åºŸè¯å°±ä¸å¤šè¯´äº†ï¼Œç›´æ¥ä¸Šä»£ç äº†ã€‚</p><pre><code class="java">private void setRotateAnimation() {    mValueAnimator = ObjectAnimator.ofFloat(0, (float) Math.PI * 2);    mValueAnimator.setRepeatCount(-1);    mValueAnimator.setDuration(ROTATION_ANIMATION_TIME);    mValueAnimator.setInterpolator(new LinearInterpolator());    mValueAnimator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() {        @Override        public void onAnimationUpdate(ValueAnimator animation) {            mRotatedAngle = (float) animation.getAnimatedValue();            invalidate();        }    });    mValueAnimator.start();}public void draw(Canvas canvas) {    // å…ˆç»˜åˆ¶æ•´ä¸ªèƒŒæ™¯ä¸ºç™½è‰²    canvas.drawColor(Color.WHITE);    // å¾—åˆ°æ¯ä¸ªæ‰‡å½¢çš„å¼§åº¦    double percentAngle = Math.PI * 2 / mColorArray.length;    for (int i = 0; i &lt; mColorArray.length; i++) {        mPaint.setColor(mColorArray[i]);        double currAngle = percentAngle * i + mRotatedAngle;        // xè½´ç›´è§’è¾¹ = åŠå¾„ * cos(è§’åº¦)        float cx = mCenterX + (float) (mBigCircleRadius * Math.cos(currAngle));        // yè½´ç›´è§’è¾¹ = åŠå¾„ * sin(è§’åº¦)        float cy = mCenterY + (float) (mBigCircleRadius * Math.sin(currAngle));        canvas.drawCircle(cx, cy, mSmallCircleRadius, mPaint);    }}</code></pre><p>æ•´ä¸ªæ—‹è½¬æ•ˆæœåŸºæœ¬ä¸Šå°±æ˜¯è¿™äº›å†…å®¹ï¼Œä¸»è¦è¿˜æ˜¯ä¸€ä¸ªæ€è·¯çš„é—®é¢˜ï¼Œé«˜ä¸­æ•°å­¦çš„å†…å®¹ï¼Œç®—æ•°è¿‡å…³ï¼Œä»£ç é—®é¢˜ä¸å¤§ã€‚</p><h3 id="ç¼©æ”¾æ•ˆæœ"><a href="#ç¼©æ”¾æ•ˆæœ" class="headerlink" title="ç¼©æ”¾æ•ˆæœ"></a>ç¼©æ”¾æ•ˆæœ</h3><p>è¿™ä¸ªæ•ˆæœå°±æ›´ç®€å•äº†ï¼Œåªæ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„å¹³ç§»åŠ¨ç”»ï¼Œæ€•çš„æ˜¯æŠŠé—®é¢˜æƒ³å¤æ‚ï¼Œæ¯”å¦‚çº ç»“åšå‡ºçš„å…ˆæ”¾å¤§å†ç¼©å°æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå®é™…ä¸Š<strong>é‚£åªæ˜¯å±æ€§åŠ¨ç”»çš„ä¸€ä¸ªå·®å€¼å™¨</strong>è€Œå·²ã€‚</p><p>æœ¬è´¨ä¸Šè¿™å°±æ˜¯æ¯ä¸ªå°åœ†éƒ½ä»åœ†å‘¨ä¸Šå¹³ç§»åˆ°äº†åœ†å¿ƒå¤„ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ã€‚åªä¸è¿‡åœ¨å®ƒä¸æ˜¯ç®€å•çš„ç¼©æ”¾ï¼Œè€Œæ˜¯ä¸æ–­çš„åœ¨æ›´æ”¹å¤§åœ†çš„åŠå¾„ï¼Œè®©æ•´ä¸ªå¤§åœ†åœ¨æ…¢æ…¢å˜å°ã€‚</p><pre><code class="java">private void setMergeAnimation() {    // ä»å¤§åœ†åŠå¾„é•¿å˜åŒ–åˆ° 0ï¼Œè®°å½•å˜åŒ–çš„å€¼ï¼Œå¹¶å°†å…¶ä½œä¸ºå„ä¸ªå°åœ†ç»˜åˆ¶ä½ç½®çš„å‚è€ƒå€¼    mValueAnimator = ObjectAnimator.ofFloat(mBigCircleRadius, 0);    mValueAnimator.setDuration(ROTATION_ANIMATION_TIME / 2);    mValueAnimator.setInterpolator(new AnticipateInterpolator(5f));    mValueAnimator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() {        @Override        public void onAnimationUpdate(ValueAnimator animation) {            mCurrBigCircleRadius = (float) animation.getAnimatedValue();            invalidate();        }    });    mValueAnimator.start();}public void draw(Canvas canvas) {    canvas.drawColor(Color.WHITE);    double percentAngle = Math.PI * 2 / mColorArray.length;    for (int i = 0; i &lt; mColorArray.length; i++) {        mPaint.setColor(mColorArray[i]);        double currAngle = percentAngle * i + mRotatedAngle;        // ä½¿ç”¨ mCurrBigCircleRadius ä»£æ›¿å›ºå®šçš„ å¤§åœ†åŠå¾„ï¼Œä»è€Œå®ç°å‘ä¸­å¿ƒé æ‹¢çš„æ•ˆæœ        float cx = mCenterX + (float) (mCurrBigCircleRadius * Math.cos(currAngle));        float cy = mCenterY + (float) (mCurrBigCircleRadius * Math.sin(currAngle));        canvas.drawCircle(cx, cy, mSmallCircleRadius, mPaint);    }}</code></pre><h3 id="æ°´æ³¢çº¹æ•ˆæœ"><a href="#æ°´æ³¢çº¹æ•ˆæœ" class="headerlink" title="æ°´æ³¢çº¹æ•ˆæœ"></a>æ°´æ³¢çº¹æ•ˆæœ</h3><p>å…¶å®æ°´æ³¢çº¹ä¹Ÿå°±æ˜¯ä¸ªè§†è§‰æ•ˆæœï¼Œæœ¬è´¨ä¸Šå°±æ˜¯åˆç”»äº†ä¸ªåœ†ï¼Œåªä¸è¿‡è¿™ä¸ªåœ†æœ‰ç‚¹å¤§ï¼ŒæŠŠæ•´ä¸ªå±å¹•éƒ½åŒ…å«è¿›å»äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ•´ä¸ªå±å¹•æœ¬è´¨ä¸Šæ˜¯è¿™ä¸ªåœ†çš„å†…åˆ‡çŸ©å½¢ï¼Œå³å±å¹•çš„å¯¹è§’çº¿æ˜¯è¿™ä¸ªåœ†å½¢çš„ç›´å¾„ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªç”»çš„å¹¶ä¸æ˜¯ä¸ªæ™®é€šçš„åœ†ï¼Œè€Œæ˜¯ä¸€ä¸ªåœ†ç¯ã€‚å…·ä½“å¦‚å›¾ã€‚</p><pre><code class="java">private void setMergeAnimation() {      // mExtendRadius = (int) Math.sqrt(Math.pow(mCenterX, 2) + Math.pow(mCenterX, 2));    // mExtendRadius å±å¹•å¯¹è§’çº¿çš„ä¸€åŠï¼Œå³åœ†çš„åŠå¾„    mValueAnimator = ObjectAnimator.ofFloat(0, mExtendRadius);    mValueAnimator.setDuration(ROTATION_ANIMATION_TIME / 2);    mValueAnimator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() {        @Override        public void onAnimationUpdate(ValueAnimator animation) {            mCurrBigCircleRadius = (float) animation.getAnimatedValue();            invalidate();        }    });    mValueAnimator.start();}public void draw(Canvas canvas) {        // mCurrBigCircleRadius ä¸åœå˜å¤§çš„åŠå¾„å€¼      // mExtendRadius - mCurrBigCircleRadius -&gt; åœ†ç¯çš„å®½åº¦    float strokeWidth = mExtendRadius - mCurrBigCircleRadius;    mPaint.setStrokeWidth(strokeWidth);    mPaint.setStyle(Paint.Style.STROKE); // è®¾ç½®åœ†ç¯    mPaint.setColor(Color.WHITE);        // åœ†ç¯çœŸæ­£çš„åŠå¾„    float radius = strokeWidth / 2 + mCurrBigCircleRadius;    canvas.drawCircle(mCenterX, mCenterY, radius, mPaint);}</code></pre><h3 id="ViewPager-æ»šåŠ¨è§†å·®æ•ˆæœ"><a href="#ViewPager-æ»šåŠ¨è§†å·®æ•ˆæœ" class="headerlink" title="ViewPager æ»šåŠ¨è§†å·®æ•ˆæœ"></a>ViewPager æ»šåŠ¨è§†å·®æ•ˆæœ</h3><p>åŠ¨ç”»ç»“æŸï¼Œä¸‹é¢æ¥ç®€å•ä»‹ç»ä¸€ä¸‹è§†å·®æ•ˆæœã€‚ä¸ªåˆ«æ§ä»¶å¯ä»¥è·Ÿéš ViewPager æ»šåŠ¨è€Œå˜åŒ–ï¼Œæœ¬æ¥ä¹Ÿå¯ä»¥ç›´æ¥ç›‘å¬ ViewPager æ»šåŠ¨ï¼Œå»éå†éœ€è¦ç§»åŠ¨çš„æ§ä»¶æ¥å®ç°åŒæ ·çš„æ•ˆæœï¼Œä½†æ˜¯ç”±äºå¤ç”¨æ€§ã€æ‰©å±•æ€§éƒ½æ¯”è¾ƒå·®ï¼Œè¿™é‡Œä½¿ç”¨è‡ªå®šä¹‰å±æ€§çš„æ–¹å¼æ¥å®ç°ã€‚<strong>è¿™ç§æ–¹å¼çš„é‡ç‚¹åœ¨äºæ‹¦æˆªç³»ç»Ÿ View çš„åˆ›å»ºï¼Œç„¶åè§£æè‡ªå®šä¹‰çš„å±æ€§ï¼Œä»è€Œå®ç°æƒ³è¦çš„æ•ˆæœã€‚</strong></p><ul><li>æ‹¦æˆªViewçš„åˆ›å»º</li></ul><p>éœ€è¦ä½¿ç”¨ LayoutInflater çš„ setFactory æ–¹æ³•ï¼Œå…·ä½“å°±ä¸å¤šåšä»‹ç»äº†ï¼Œä¸äº†è§£çš„è‡ªå·±å»äº†è§£ä¸€ä¸‹ï¼š <a href="https://blog.csdn.net/lmj623565791/article/details/51503977" target="_blank" rel="noopener">Android æ¢ç©¶ LayoutInflater setFactory</a></p><p>éœ€è¦</p><ul><li><p>è§£æè‡ªå®šä¹‰å±æ€§</p><p>æˆ‘ä»¬ä¸ºç³»ç»Ÿæ§ä»¶æ‰©å±•äº†è‡ªå®šä¹‰å±æ€§ï¼Œåœ¨ attrs ä¸­å£°æ˜ï¼š</p><pre><code class="xml">&lt;resources&gt;    &lt;!-- Xæ–¹å‘ä¸Šçš„ä½ç§» --&gt;    &lt;attr name=&quot;translationXIn&quot; format=&quot;float&quot; /&gt;    &lt;attr name=&quot;translationXOut&quot; format=&quot;float&quot; /&gt;    &lt;!-- Yæ–¹å‘ä¸Šçš„ä½ç§» --&gt;    &lt;attr name=&quot;translationYIn&quot; format=&quot;float&quot; /&gt;    &lt;attr name=&quot;translationYOut&quot; format=&quot;float&quot; /&gt;&lt;/resources&gt;</code></pre><p>ç„¶åæˆ‘ä»¬æ‹¦æˆªåˆ°ç³»ç»Ÿçš„ View åï¼Œå°è¯•ä»ä¸­å»è§£æè¿™äº›è‡ªå®šä¹‰çš„ Viewï¼›è§£æåˆ°å¯¹åº”çš„è‡ªå®šä¹‰å±æ€§åï¼Œé€šè¿‡ç»™ View è®¾ç½® tag çš„æ–¹å¼ï¼Œå°†ç”¨æˆ·è®¾ç½®çš„ä¿¡æ¯è¿›è¡Œä¿å­˜ï¼š</p><pre><code class="xml">&lt;resources&gt;    &lt;item name=&quot;parallax_tag&quot; type=&quot;id&quot;/&gt;&lt;/resources&gt;</code></pre><pre><code class="java"> private int[] mParallaxAttrs = new int[]{            R.attr.translationXIn, R.attr.translationXOut,            R.attr.translationYIn, R.attr.translationYOut    };private void analysisAttrs(View view, Context context, AttributeSet attrs) {    TypedArray array = context.obtainStyledAttributes(attrs, mParallaxAttrs);    // ä¸»åŠ¨å»è§£æè‡ªå®šä¹‰çš„å‡ ä¸ªå±æ€§ï¼Œå¦‚æœèƒ½å¤Ÿæ‹¿åˆ°ï¼Œå°±å»éå†è§£æ    if (array != null &amp;&amp; array.getIndexCount() != 0) {        ParallaxTag parallaxTag = new ParallaxTag();        for (int i = 0; i &lt; array.getIndexCount(); i++) {            int arrayIndex = array.getIndex(i);            switch (arrayIndex) {                case 0:                    parallaxTag.setxIn(array.getFloat(arrayIndex, 0f));                    break;                case 1:                    parallaxTag.setxOut(array.getFloat(arrayIndex, 0f));                    break;                case 2:                    parallaxTag.setyIn(array.getFloat(arrayIndex, 0f));                    break;                case 3:                    parallaxTag.setyOut(array.getFloat(arrayIndex, 0f));                    break;            }            // è¦ç´§çš„é—®é¢˜æ˜¯ï¼Œè§£æåˆ°äº†ä»¥åæ€ä¹ˆå­˜ -&gt; ç»™ View è®¾ç½® tag            view.setTag(R.id.parallax_tag, parallaxTag);            // å°†å‡†å¤‡æ“ä½œçš„ View æ”¾å…¥é›†åˆä¸­            mParallaxViews.add(view);        }        array.recycle();    }}</code></pre></li></ul><p>ä»¥ä¸ŠåŠ¨ä½œåœ¨ ViewPager å…³è”çš„ Fragment ä¸­å®ç°ï¼Œè¿™æ ·åªéœ€è¦åœ¨ ViewPager çš„æ»‘åŠ¨ç›‘å¬ä¸­å»å–åˆ°å½“å‰ Fragment çš„ View é›†åˆï¼Œç„¶ååˆ†åˆ«ä¸ºå·¦å³ä¸¤ä¾§çš„ Fragment è®¾ç½®è¿›å…¥å’Œåˆ’å‡ºæ•ˆæœå³å¯ã€‚</p><pre><code class="java">addOnPageChangeListener(new OnPageChangeListener() {    @Override    public void onPageScrolled(int position, float positionOffset, int positionOffsetPixels) {        // åŒæ—¶è®¾ç½®å·¦å³ä¸¤ä¾§çš„ fragmentï¼Œå·¦è¾¹é€€å‡ºï¼Œå³è¾¹è¿›å…¥        ParallaxFragment outFragment = mFragments.get(position);        List&lt;View&gt; outFragmentParallaxViews = outFragment.getParallaxViews();        for (View view : outFragmentParallaxViews) {            ParallaxTag parallaxTag = (ParallaxTag) view.getTag(R.id.parallax_tag);            view.setTranslationX(( -positionOffsetPixels) * parallaxTag.getxOut());            view.setTranslationY(( -positionOffsetPixels) * parallaxTag.getyOut());        }        try {            ParallaxFragment inFragment = mFragments.get(position + 1);            outFragmentParallaxViews = inFragment.getParallaxViews();            for (View view : outFragmentParallaxViews) {                ParallaxTag parallaxTag = (ParallaxTag) view.getTag(R.id.parallax_tag);                view.setTranslationX(                  (getMeasuredWidth() - positionOffsetPixels) * parallaxTag.getxIn());                view.setTranslationY(                  (getMeasuredWidth() - positionOffsetPixels) * parallaxTag.getyIn());            }        } catch (Exception e) {}    }    @Override    public void onPageSelected(int position) {    }    @Override    public void onPageScrollStateChanged(int state) {    }});</code></pre><p>å¥½å•¦ï¼Œè¯´åˆ°è¿™é‡Œå°±å·®ä¸å¤šç»“æŸäº†ï¼Œå®Œç»“æ’’èŠ±~</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘ç®€å•å­¦äº†ä¸€ä¸ªè‡ªå®šä¹‰ View çš„å°æ•ˆæœï¼Œæœ¬èº«ä»£ç å¹¶ä¸ç®—å¤šï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰äº›æ–°ä¸œè¥¿ï¼Œæœ¬ç€å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´çš„æƒ³æ³•ï¼Œè¿˜æ˜¯è¦è®°å½•ä¸‹æ¥å¤‡å¿˜ï¼Œè¯´ä¸ä¸Šä»€ä¹ˆæ—¶å€™å°±ä¼šç”¨åˆ°ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://joeljt.top/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>MeasureSpec é‚£ç‚¹äº‹å„¿</title>
    <link href="http://joeljt.top/2019/04/10/Android-MeasureSpec/"/>
    <id>http://joeljt.top/2019/04/10/Android-MeasureSpec/</id>
    <published>2019-04-09T16:00:00.000Z</published>
    <updated>2019-04-10T11:54:51.189Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨è‡ªå®šä¹‰ View çš„å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œä¸ç®¡æ€ä¹ˆæ ·éƒ½ç»•ä¸è¿‡ MeasureSpec  çš„å­¦ä¹ ï¼›æ‹–æ‹–æ‹‰æ‹‰å¾ˆä¹…ï¼Œåœ¨æ•°ä¸æ¸…çš„çœ‹äº†å¿˜ï¼Œå¿˜äº†çœ‹ä¹‹åï¼Œè¿˜æ˜¯å†³å®šå†™ç¯‡åšå®¢è®°å½•ä¸€ä¸‹ï¼Œæ¯•ç«Ÿæœ‰æ•ˆçš„è¾“å‡ºæ‰æ˜¯æ£€éªŒè¾“å…¥çš„ä¸äºŒæ³•é—¨ã€‚</p><a id="more"></a><p>åºŸè¯ä¸å¤šè¯´ï¼Œä¸‹é¢è¿›å…¥æ­£é¢˜ã€‚</p><h3 id="MeasureSpec-å®šä¹‰"><a href="#MeasureSpec-å®šä¹‰" class="headerlink" title="MeasureSpec å®šä¹‰"></a>MeasureSpec å®šä¹‰</h3><p>å…³äº MeasureSpec çš„å®šä¹‰ï¼Œå®˜æ–¹è§£é‡Šå¦‚ä¸‹ï¼š</p><blockquote><p>A MeasureSpec encapsulates the layout requirements passed from parent to child. Each MeasureSpec represents a requirement for either the width or the height. </p></blockquote><p>å¤§æ„å°±æ˜¯ï¼ŒMeasureSpec å°è£…äº†çˆ¶å¸ƒå±€ä¼ é€’ç»™å­å¸ƒå±€çš„å¸ƒå±€è¦æ±‚ï¼Œæ¯ä¸ª MeasureSpec ç”± <code>mode</code> å’Œ <code>size</code> ç»„æˆï¼ŒåŒ…å«äº†çˆ¶å¸ƒå±€å¯¹å­å¸ƒå±€ç›¸åº”çš„å®½é«˜è¦æ±‚ã€‚</p><p>MeasureSpec æœ‰ä¸‰ç§æ¨¡å¼ï¼šUNSPECIFIEDã€EXACTLYã€AT_MOSTã€‚</p><ul><li><p>UNSPECIFIED</p><p>çˆ¶å¸ƒå±€ä¸å¯¹å­å¸ƒå±€åšä»»ä½•é™åˆ¶ï¼Œå®ƒæƒ³å¤šå¤§å°±å¤šå¤§ï¼›ä¸€èˆ¬è‡ªå®šä¹‰ View ä¸­ç”¨ä¸åˆ°ï¼›</p><blockquote><p>å¸¸è§äºç³»ç»Ÿå†…éƒ¨æ§ä»¶ï¼Œä¾‹å¦‚ ListViewã€ScrollView</p></blockquote></li><li><p>EXACTLY</p><p>çˆ¶å¸ƒå±€å¯¹å­å¸ƒå±€çš„å®½é«˜å¤§å°æœ‰æ˜ç¡®çš„è¦æ±‚ï¼Œä¸ç®¡å­å¸ƒå±€æƒ³è¦å¤šå¤§ï¼Œå®ƒéƒ½ä¸èƒ½è¶…è¿‡çˆ¶å¸ƒå±€å¯¹å®ƒçš„é™åˆ¶ï¼›</p><blockquote><p>æŒ‡å®šçš„å¤§å°å¦‚ 100dpï¼Œæˆ–è€… match_parent(å®è´¨ä¸Šå°±æ˜¯å±å¹•å¤§å°)ï¼Œéƒ½æ˜¯ç¡®åˆ‡çš„å°ºå¯¸</p></blockquote></li><li><p>AT_MOST</p><p>å­å¸ƒå±€æƒ³è¦å¤šå¤§å°±å¯ä»¥å¤šå¤§ï¼Œä½†æ˜¯ä¸€èˆ¬æ¥è¯´ä¸ä¼šè¶…è¿‡çˆ¶å¸ƒå±€çš„å°ºå¯¸ï¼›</p><blockquote><p>ä¸€èˆ¬å¯¹åº”çš„çˆ¶å¸ƒå±€å°ºå¯¸ä¸º wrap_contentï¼Œçˆ¶å¸ƒå±€æ— æ³•ç¡®å®šå­å¸ƒå±€çš„å°ºå¯¸</p></blockquote></li></ul><p>ä¸ºäº†èŠ‚çº¦å†…å­˜å ç”¨ï¼ŒMeasureSpec æœ¬èº«å°±æ˜¯ä¸€ä¸ª 32 ä½çš„ int å€¼ï¼Œè¿™ä¸ªç±»å°±æ˜¯è´Ÿè´£å°† &lt;size, mode&gt; çš„å…ƒç»„è½¬æ¢ä¸º int å€¼ï¼Œé«˜ 2 ä½è¡¨ç¤º specModeï¼Œä½ 30 ä½è¡¨ç¤º specSizeã€‚</p><p><strong>ä¸€ä¸ª View çš„å¤§å°å¹¶ä¸æ˜¯ç”±å®ƒè‡ªå·±ç¡®å®šçš„ï¼Œè€Œæ˜¯ç”±å…¶è‡ªèº«çš„ LayoutParams ä»¥åŠçˆ¶å¸ƒå±€çš„ MeasureSpec ç¡®å®šçš„ã€‚</strong></p><p>é‚£ MeasureSpec æ˜¯ä»€ä¹ˆï¼Œæœ€åˆçš„ MeasureSpec åˆæ˜¯å“ªé‡Œæ¥çš„ï¼Ÿ</p><h3 id="MeasureSpec-ç¼˜èµ·"><a href="#MeasureSpec-ç¼˜èµ·" class="headerlink" title="MeasureSpec ç¼˜èµ·"></a>MeasureSpec ç¼˜èµ·</h3><p>ç”±äº View çš„ç»˜åˆ¶æµç¨‹å…¥å£åœ¨ ViewRootImpl ç±»ä¸­ï¼Œæˆ‘ä»¬æœ€ç»ˆåœ¨ performTraversals æ–¹æ³•ä¸­æ‰¾åˆ°å¦‚ä¸‹ä»£ç ï¼š</p><pre><code class="java">    int childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width);         int childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height);         // Ask host how big it wants to be         performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);</code></pre><p>å¾ˆæ˜æ˜¾åœ¨æ‰§è¡Œæµ‹é‡çš„æœ€åˆï¼Œç³»ç»Ÿæ˜¯é€šè¿‡ <code>getRootMeasureSpec</code> æ–¹æ³•è·å–åˆ°å®½é«˜çš„ MeasureSpec ä¿¡æ¯çš„ã€‚</p><pre><code class="java">private static int getRootMeasureSpec(int windowSize, int rootDimension) {    int measureSpec;    switch (rootDimension) {        case ViewGroup.LayoutParams.MATCH_PARENT:            // Window can&#39;t resize. Force root view to be windowSize.            measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);            break;        case ViewGroup.LayoutParams.WRAP_CONTENT:            // Window can resize. Set max size for root view.            measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.AT_MOST);            break;        default:            // Window wants to be an exact size. Force root view to be that size.            measureSpec = MeasureSpec.makeMeasureSpec(rootDimension, MeasureSpec.EXACTLY);            break;    }    return measureSpec;}</code></pre><p>å¾ˆæ˜æ˜¾ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨ View æµ‹é‡çš„å…¥å£ï¼ŒspecSize æ˜¯å›ºå®šçš„ windowSizeï¼Œè€Œ MATCH_PARENT å¯¹åº”çš„æµ‹é‡æ¨¡å¼æ˜¯ EXACTLYï¼ŒWRAP_CONTENT å¯¹åº”çš„æµ‹é‡æ¨¡å¼æ˜¯ AT_MOSTã€‚æˆ‘ä»¬ä¼šå‘ç°ï¼Œæ¯ä¸ª MeasureSpec éƒ½æ˜¯é€šè¿‡ <code>MeasureSpec.makeMeasureSpec</code> ç”Ÿæˆçš„ã€‚</p><p>SpecMode å’Œ SpecSize ç»„æˆäº† MeasureSpecï¼ŒMeasureSpec é€šè¿‡å°† SpecMode å’Œ SpecSize æ‰“åŒ…æˆä¸€ä¸ª int å€¼æ¥é¿å…è¿‡å¤šçš„å¯¹è±¡åˆ›å»ºï¼Œå¹¶æä¾›äº†å¯¹åº”çš„æ‰“åŒ…ã€è§£åŒ…æ–¹æ³•ï¼š</p><pre><code class="java">public static int makeMeasureSpec(int size, int mode) {    if (sUseBrokenMakeMeasureSpec) {        // äºŒè¿›åˆ¶çš„ + ï¼Œä¸æ˜¯åè¿›åˆ¶          // ä½¿ç”¨ä¸€ä¸ª32ä½çš„äºŒè¿›åˆ¶æ•°ï¼Œå…¶ä¸­ï¼š32å’Œ31ä½ä»£è¡¨æµ‹é‡æ¨¡å¼ï¼ˆmodeï¼‰ã€å30ä½ä»£è¡¨æµ‹é‡å¤§å°ï¼ˆsizeï¼‰        // ä¾‹å¦‚size=100(å°±æ˜¯åè¿›åˆ¶çš„ 4)ï¼Œmode=AT_MOSTï¼ŒmeasureSpec=100+1000...00=1000..00100          return size + mode;    } else {        return (size &amp; ~MODE_MASK) | (mode &amp; MODE_MASK);    }}public static int getMode(int measureSpec) {      // MODE_MASK = è¿ç®—é®ç½© = 11 00000000000(11åè·Ÿ30ä¸ª0)      // åŸç†ï¼šä¿ç•™measureSpecçš„é«˜2ä½ï¼ˆå³æµ‹é‡æ¨¡å¼ï¼‰ã€ä½¿ç”¨0æ›¿æ¢å30ä½    return (measureSpec &amp; MODE_MASK);}public static int getSize(int measureSpec) {    // åŸç†ï¼šåŒä¸Šï¼Œå°† MASK å–åï¼Œå¾—åˆ° 00 1111111111(00åè·Ÿ30ä¸ª1)     // å°† 32,31 æ›¿æ¢æˆ 0 ä¹Ÿå°±æ˜¯å»æ‰äº† modeï¼Œåªä¿ç•™å30ä½çš„size    return (measureSpec &amp; ~MODE_MASK);}</code></pre><p>ç°åœ¨æˆ‘ä»¬å¾—åˆ°äº† MeasureSpecï¼Œç°åœ¨æ¥çœ‹çœ‹çˆ¶å¸ƒå±€æ˜¯æ€ä¹ˆé€šè¿‡ MeasureSpec æ”¯é…å­å¸ƒå±€çš„ã€‚</p><p>ä»¥ä¸‹ä»£ç æˆªå–è‡ª LinearLayout çš„ measureVertical æ–¹æ³•ï¼š</p><pre><code class="java">final LayoutParams lp = (LayoutParams) child.getLayoutParams();final int childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(        Math.max(0, childWidth), MeasureSpec.EXACTLY);final int childHeightMeasureSpec = getChildMeasureSpec(heightMeasureSpec,        mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin,        lp.height);// ä¼ åˆ°å„ä¸ªå­ View çš„ MeasureSpec å°±æ˜¯åœ¨è¿™é‡Œç”Ÿæˆçš„child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</code></pre><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œç”±äºæ˜¯æµ‹é‡ç«–ç›´æ–¹å‘çš„çº¿æ€§å¸ƒå±€ï¼Œå¸ƒå±€çš„å®½åº¦æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥ç›´æ¥è°ƒç”¨ MeasureSpec ç”Ÿæˆå®½åº¦çš„è§„æ ¼ï¼ŒåŒæ—¶ä¸ºå…¶æŒ‡å®šæµ‹é‡æ¨¡å¼ä¸º MeasureSpec.EXACTLYï¼›é«˜åº¦å› ä¸ºæ¯”è¾ƒå¤æ‚ï¼Œè°ƒç”¨äº† <code>getChildMeasureSpec</code> ç”Ÿæˆï¼Œä¼ å…¥äº†å½“å‰ LinearLayout çš„çˆ¶å¸ƒå±€ä¸ºå…¶æŒ‡å®šçš„ MeasureSpec ä»¥åŠå½“å‰å­ View çš„ LayoutParamsï¼š</p><pre><code class="java">/** * ViewGroup#getChildMeasureSpec *  * @param spec çˆ¶å¸ƒå±€çš„ MeasureSpec * @param padding å­å¸ƒå±€çš„ margin+padding * @param childDimension å­å¸ƒå±€çš„é«˜åº¦ä¿¡æ¯ï¼Œlp.height * @return */public static int getChildMeasureSpec(int spec, int padding, int childDimension) {      // è·å–çˆ¶å¸ƒå±€ï¼Œä¹Ÿå°±æ˜¯ LinearLayout çš„æµ‹é‡æ¨¡å¼ä»¥åŠæµ‹é‡å¤§å°    int specMode = MeasureSpec.getMode(spec);    int specSize = MeasureSpec.getSize(spec);      // è®°å½•ä¸€ä¸‹é™¤å» padding çš„æµ‹é‡å¤§å°ï¼Œä½†æ˜¯ä¸ä¸€å®šä¼šç”¨ï¼Œå…·ä½“è¦çœ‹çˆ¶å¸ƒå±€çš„ mode ä»¥åŠå­å¸ƒå±€è‡ªèº«çš„ size     int size = Math.max(0, specSize - padding);      // å½“å‰ child çš„ size å’Œ mode    int resultSize = 0;    int resultMode = 0;    // åˆ¤æ–­ä¸€ä¸‹çˆ¶å¸ƒå±€çš„æµ‹é‡è§„æ ¼ï¼Œçœ‹çœ‹æ˜¯ match è¿˜æ˜¯ wrap    switch (specMode) {        // å¦‚æœæ˜¯ EXACTLYï¼Œè¯´æ˜çˆ¶å¸ƒå±€æ˜¯æœ‰å›ºå®šå¤§å°çš„ï¼Œæˆ–è€…æ˜¯å®šæ­»çš„ 100dpï¼Œæˆ–è€…æ˜¯ match_parent çš„å±å¹•å®½åº¦        case MeasureSpec.EXACTLY: // å€¼ä¸º -2                // åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœå­å¸ƒå±€çš„é«˜åº¦ä¿¡æ¯æ˜¯æœ‰ç¡®å®šå€¼çš„ï¼Œé‚£è¯´æ˜ç”¨æˆ·å£°æ˜äº†å›ºå®šçš„ 100dp ç­‰ä¿¡æ¯                 // é‚£å°±è®©å­å¸ƒå±€çš„å®½é«˜ä¿¡æ¯å›ºå®šï¼ŒåŒæ—¶è®¾ç½®æµ‹é‡æ¨¡å¼åŒæ ·ä¸º EXACTLY            if (childDimension &gt;= 0) {                resultSize = childDimension;                resultMode = MeasureSpec.EXACTLY;            } else if (childDimension == ViewGroup.LayoutParams.MATCH_PARENT) {                // å¦‚æœå­å¸ƒå±€æƒ³è¦å……æ»¡çˆ¶å¸ƒå±€ï¼Œé‚£å°±è®©å®ƒå’Œçˆ¶å¸ƒå±€ä¸€æ ·å¤§ï¼Œç„¶åè®¾ç½®æµ‹é‡æ¨¡å¼åŒæ ·ä¸º EXACTLY                resultSize = size;                resultMode = MeasureSpec.EXACTLY;            } else if (childDimension == ViewGroup.LayoutParams.WRAP_CONTENT) {                // å­å¸ƒå±€æƒ³è‡ªå·±å†³å®šè‡ªå·±çš„å¤§å°ï¼Œä½†æ˜¯å®ƒæœ€å¤§ä¸èƒ½è¶…è¿‡çˆ¶å¸ƒå±€ï¼Œæ‰€ä»¥æ¨¡å¼æ˜¯ AT_MOST                resultSize = size;                resultMode = MeasureSpec.AT_MOST;            }            break;        // å¦‚æœæ˜¯ AT_MOSTï¼Œè¯´æ˜çˆ¶å¸ƒå±€æ˜¯åŒ…è£¹å†…å®¹ï¼Œé‚£å­å¸ƒå±€ä¸èƒ½è¶…è¿‡çˆ¶å¸ƒå±€çš„å¤§å°        case MeasureSpec.AT_MOST:            if (childDimension &gt;= 0) {                // å…¨éƒ¨åŒä¸Š                resultSize = childDimension;                resultMode = MeasureSpec.EXACTLY;            } else if (childDimension == ViewGroup.LayoutParams.MATCH_PARENT) {                  // çˆ¶å¸ƒå±€éƒ½ä¸çŸ¥é“è‡ªå·±çš„å¤§å°ï¼Œåªèƒ½å‘Šè¯‰å­å¸ƒå±€æœ€å¤§ä¸èƒ½è¶…è¿‡è‡ªå·±ï¼Œæ‰€ä»¥æ¨¡å¼åªèƒ½æ˜¯ AT_MOST                resultSize = size;                resultMode = MeasureSpec.AT_MOST;            } else if (childDimension == ViewGroup.LayoutParams.WRAP_CONTENT) {                resultSize = size;                resultMode = MeasureSpec.AT_MOST;            }            break;        // çˆ¶å¸ƒå±€ä¸å¯¹å­å¸ƒå±€åšä»»ä½•é™åˆ¶ï¼Œæƒ³å¤šå¤§å¤šå¤§ï¼Œä¸€èˆ¬å¤šè§äºListViewã€GridView        case MeasureSpec.UNSPECIFIED:            if (childDimension &gt;= 0) {                // Child wants a specific size... let him have it                resultSize = childDimension;                resultMode = MeasureSpec.EXACTLY;            } else if (childDimension == ViewGroup.LayoutParams.MATCH_PARENT) {                // Child wants to be our size... find out how big it should                // be                resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size;                resultMode = MeasureSpec.UNSPECIFIED;            } else if (childDimension == ViewGroup.LayoutParams.WRAP_CONTENT) {                // Child wants to determine its own size.... find out how                // big it should be                resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size;                resultMode = MeasureSpec.UNSPECIFIED;            }            break;    }    // ç”¨çˆ¶å¸ƒå±€çš„ MeasureSpec å’Œ child çš„ lpï¼Œä¸ºå…¶ç”Ÿæˆè‡ªå·±çš„æµ‹é‡è§„æ ¼    return MeasureSpec.makeMeasureSpec(resultSize, resultMode);}</code></pre><h3 id="åšä¸ªå°æ€»ç»“"><a href="#åšä¸ªå°æ€»ç»“" class="headerlink" title="åšä¸ªå°æ€»ç»“"></a>åšä¸ªå°æ€»ç»“</h3><p>è¯´åˆ°è¿™é‡Œï¼Œå¤§å®¶ä¹Ÿåº”è¯¥èƒ½ç†è§£ã€Œä¸€ä¸ª View çš„å¤§å°æ˜¯ç”±å®ƒçš„çˆ¶å¸ƒå±€å’Œå®ƒè‡ªèº«å…±åŒå†³å®šçš„ã€æ˜¯ä»€ä¹ˆæ„æ€äº†ã€‚</p><p>è¿™é‡Œç®€å•åšä¸ªæ€»ç»“ï¼š</p><ol><li><p>MeasureSpec çš„ UNSPECIFIED æµ‹é‡æ¨¡å¼ä¸€èˆ¬è§äºç³»ç»Ÿå†…éƒ¨ï¼Œå¹¶ä¸å¤šè§ï¼Œä¸åšè¿‡å¤šè®¨è®ºï¼Œç›®å‰å·²çŸ¥çš„åº”ç”¨å°±æ˜¯ ScrollView åµŒå¥— ListView åªèƒ½æ˜¾ç¤ºä¸€è¡Œï¼Œå°±æ˜¯ç”±äº ScrollView åœ¨æµ‹é‡å­ View çš„æ—¶å€™ï¼Œå‘ä¸‹ä¼ é€’çš„æµ‹é‡æ¨¡å¼ä¸º MeasureSpec.UNSPECIFIED ï¼ŒåŒæ—¶ ListView çš„ onMeasure æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š</p><pre><code class="java">// å¦‚æœæµ‹é‡æ¨¡å¼ä¸º MeasureSpec.UNSPECIFIEDï¼Œåˆ™æœ€ç»ˆçš„é«˜åº¦å°±æ˜¯å·²æµ‹é‡çš„é«˜åº¦ + paddingif (heightMode == MeasureSpec.UNSPECIFIED) {       heightSize = mListPadding.top + mListPadding.bottom +              childHeight + getVerticalFadingEdgeLength() * 2;}</code></pre><p>è¿™å°±å¯¼è‡´äº†æœ€ç»ˆ ListView çš„é«˜åº¦åªæœ‰ä¸€è¡Œï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹<a href="https://www.jianshu.com/p/061f734af3e9" target="_blank" rel="noopener">ScrollView åµŒå¥— ListView çš„è§£å†³æ–¹æ³•çš„åŸç†</a>ï¼Œè¿™é‡Œå°±ä¸å†è¿‡å¤šä»‹ç»äº†ï¼›</p></li><li><p><strong>å½“å­ View è®¾ç½®äº†å›ºå®šå€¼çš„æ—¶å€™ï¼Œæ— è®ºçˆ¶å¸ƒå±€çš„æµ‹é‡æ¨¡å¼æ˜¯ä»€ä¹ˆï¼Œ<em><u>å­ View çš„å¤§å°éƒ½éµå¾ªè¿™ä¸ªå›ºå®šå€¼ï¼Œ</u></em><u><em>å³ä½¿è¶…å‡ºå±å¹•</em></u>ï¼Œä¸”æµ‹é‡æ¨¡å¼éƒ½ä¸ºç²¾ç¡®æ¨¡å¼ï¼Œå³ MeasureSpec.EXACTLY</strong>ï¼›</p></li><li><p><strong>å½“å­ View ä¸º match_parent æ—¶ï¼Œå…¶ specMode è·Ÿéšçˆ¶å¸ƒå±€çš„ specMode</strong>ï¼Œ<em><u>çˆ¶å¸ƒå±€å›ºå®šï¼Œé‚£ä½ å……æ»¡çˆ¶å¸ƒå±€ï¼Œä½ è‚¯å®šä¹Ÿå›ºå®šï¼Œå°±æ˜¯ EXACTLYï¼›çˆ¶å¸ƒå±€åŒ…è£¹å†…å®¹ï¼Œä¸èƒ½ç¡®å®šè‡ªå·±å¤šå¤§ï¼Œé‚£ä½ è‚¯å®šä¹Ÿä¸èƒ½çŸ¥é“è‡ªå·±å¤šå¤§ï¼Œé‚£å°± AT_MOST</u></em>ï¼›<strong>å…¶ specSize ä¹Ÿå°±æ˜¯çˆ¶å¸ƒå±€çš„ sizeï¼Œä¸ä¼šè¶…è¿‡çˆ¶å¸ƒå±€çš„å¤§å°ï¼›</strong></p></li><li><p><strong>å½“å­ View ä¸º wrap_content æ—¶ï¼Œé‚£å®ƒçš„ specMode æ˜¯ AT_MOSTï¼ŒspecSize å°±æ˜¯çˆ¶å¸ƒå±€çš„ sizeï¼Œå› ä¸ºè™½ç„¶å…¶ä¸èƒ½ç¡®å®šå®½é«˜ï¼Œä½†æ˜¯å§‹ç»ˆä¸èƒ½è¶…è¿‡çˆ¶å¸ƒå±€çš„å¤§å°ã€‚</strong></p></li></ol><h3 id="ğŸŒ°"><a href="#ğŸŒ°" class="headerlink" title="ğŸŒ°"></a>ğŸŒ°</h3><p>ä¸€ç›´è´´ä»£ç ï¼Œè¯´ç†è®ºå¤šå°‘æœ‰ç‚¹æ¯ç‡¥ï¼Œè´´ç‚¹å›¾ç‰‡ï¼Œçœ‹çœ‹ğŸŒ°</p><h4 id="çˆ¶å¸ƒå±€ä¸º-EXACTLY"><a href="#çˆ¶å¸ƒå±€ä¸º-EXACTLY" class="headerlink" title="çˆ¶å¸ƒå±€ä¸º EXACTLY"></a>çˆ¶å¸ƒå±€ä¸º EXACTLY</h4><ol><li><p>ViewGroup: match_parent, Child: 500dp x 500dp</p></li><li><p>ViewGroup: 300dp x 300dp, Child: 500dp x 500dp</p><blockquote><p>çˆ¶å¸ƒå±€æµ‹é‡è§„æ ¼æ˜¯ç²¾ç¡®æ¨¡å¼ï¼Œæµ‹é‡å¤§å°æ˜¯å±å¹•å¤§å°ï¼›</p><p>å­ View è®¾ç½®ä¸ºå›ºå®šå€¼ï¼Œå¿½è§†çˆ¶å¸ƒå±€çš„æµ‹é‡è§„æ ¼ï¼Œå¤§å°å°±æ˜¯è®¾ç½®çš„å®½é«˜ï¼Œæµ‹é‡æ¨¡å¼ä¸ºç²¾ç¡®æ¨¡å¼</p></blockquote><pre><code class="java">// å¸ƒå±€å¦‚ä¸‹&lt;com.ljt.rvanalysis.spec.MyLinearLayout    android:layout_width=&quot;match_parent&quot;    android:layout_height=&quot;match_parent&quot;    android:orientation=&quot;vertical&quot;&gt;    &lt;com.ljt.rvanalysis.spec.MyTextView        android:layout_width=&quot;300dp&quot;        android:layout_height=&quot;300dp&quot; /&gt;&lt;/com.ljt.rvanalysis.spec.MyLinearLayout&gt;</code></pre><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190410180646.png" alt=""></p></li><li><p>ViewGroup: match_parent, child: match_parent</p><blockquote><p>çˆ¶å¸ƒå±€ã€å­å¸ƒå±€å‡å……æ»¡å±å¹•ï¼Œæµ‹é‡æ¨¡å¼éƒ½ä¸º MeasureSpec.EXACTLYï¼Œæµ‹é‡å¤§å°å‡ä¸ºå±å¹•å¤§å°</p></blockquote><pre><code class="JAVA">&lt;com.ljt.rvanalysis.spec.MyLinearLayout    android:layout_width=&quot;match_parent&quot;    android:layout_height=&quot;match_parent&quot;    android:orientation=&quot;vertical&quot;&gt;    &lt;com.ljt.rvanalysis.spec.MyTextView        android:layout_width=&quot;match_parent&quot;        android:layout_height=&quot;match_parent&quot; /&gt;&lt;/com.ljt.rvanalysis.spec.MyLinearLayout&gt;</code></pre><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190410180825.png" alt=""></p></li><li><p>ViewGroup: match_parent, child: wrap_content</p><blockquote><p>çˆ¶å¸ƒå±€å……æ»¡å±å¹•ï¼Œæµ‹é‡æ¨¡å¼æ˜¯ç²¾ç¡®æ¨¡å¼ï¼Œæµ‹é‡å¤§å°æ˜¯å±å¹•å¤§å°ï¼›</p><p>å­å¸ƒå±€åŒ…è£¹å†…å®¹ï¼Œæµ‹é‡æ¨¡å¼æ˜¯ AT_MOSTï¼Œä½†æ˜¯ä¸èƒ½è¶…è¿‡çˆ¶å¸ƒå±€ï¼Œæµ‹é‡å¤§å°ä¸ºå±å¹•å¤§å°</p></blockquote><pre><code class="java">&lt;com.ljt.rvanalysis.spec.MyLinearLayout    android:layout_width=&quot;match_parent&quot;    android:layout_height=&quot;match_parent&quot;    android:orientation=&quot;vertical&quot;&gt;    &lt;com.ljt.rvanalysis.spec.MyTextView        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot; /&gt;&lt;/com.ljt.rvanalysis.spec.MyLinearLayout&gt;</code></pre><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190410180934.png" alt=""></p></li></ol><h4 id="çˆ¶å¸ƒå±€ä¸º-WRAP-CONTENT"><a href="#çˆ¶å¸ƒå±€ä¸º-WRAP-CONTENT" class="headerlink" title="çˆ¶å¸ƒå±€ä¸º WRAP_CONTENT"></a>çˆ¶å¸ƒå±€ä¸º WRAP_CONTENT</h4><ol><li><p>ViewGroup: wrap_content, child: match_parent</p><blockquote><p>çˆ¶å¸ƒå±€æµ‹é‡è§„æ ¼æ˜¯ AT_MOSTï¼Œæµ‹é‡å¤§å°æ˜¯å±å¹•å¤§å°ï¼›</p><p>å­å¸ƒå±€æµ‹é‡è§„æ ¼ AT_MOSTï¼Œä½†æ˜¯æ— æ³•è¶…è¿‡çˆ¶å¸ƒå±€å¤§å°ï¼Œæµ‹é‡å¤§å°ä¹Ÿæ˜¯å±å¹•å¤§å°ï¼›</p></blockquote><pre><code class="java">&lt;com.ljt.rvanalysis.spec.MyLinearLayout    android:layout_width=&quot;wrap_content&quot;    android:layout_height=&quot;wrap_content&quot;    android:orientation=&quot;vertical&quot;&gt;    &lt;com.ljt.rvanalysis.spec.MyTextView        android:layout_width=&quot;match_parent&quot;        android:layout_height=&quot;match_parent&quot; /&gt;&lt;/com.ljt.rvanalysis.spec.MyLinearLayout&gt;</code></pre><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190410181341.png" alt=""></p></li><li><p>ViewGroup: wrap_content, child: 300dp x 300dp</p><blockquote><p>çˆ¶å¸ƒå±€æµ‹é‡è§„æ ¼æ˜¯ AT_MOSTï¼Œæµ‹é‡å¤§å°æ˜¯å±å¹•å¤§å°ï¼›</p><p>å­ View è®¾ç½®ä¸ºå›ºå®šå€¼ï¼Œå¿½è§†çˆ¶å¸ƒå±€çš„æµ‹é‡è§„æ ¼ï¼Œå¤§å°å°±æ˜¯è®¾ç½®çš„å®½é«˜ï¼Œæµ‹é‡æ¨¡å¼ä¸ºç²¾ç¡®æ¨¡å¼</p></blockquote><pre><code class="java">&lt;com.ljt.rvanalysis.spec.MyLinearLayout    android:layout_width=&quot;wrap_content&quot;    android:layout_height=&quot;wrap_content&quot;    android:orientation=&quot;vertical&quot;&gt;    &lt;com.ljt.rvanalysis.spec.MyTextView        android:layout_width=&quot;300dp&quot;        android:layout_height=&quot;300dp&quot; /&gt;&lt;/com.ljt.rvanalysis.spec.MyLinearLayout&gt;</code></pre><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190410181429.png" alt=""></p></li><li><p>ViewGroup: wrap_content, child: wrap_content</p><blockquote><p>çˆ¶å¸ƒå±€æµ‹é‡è§„æ ¼æ˜¯ AT_MOSTï¼Œæµ‹é‡å¤§å°æ˜¯å±å¹•å¤§å°ï¼›</p><p>å­å¸ƒå±€ä¹Ÿä¸çŸ¥é“è‡ªå·±å¤šå¤§ï¼Œæµ‹é‡è§„æ ¼æ˜¯ AT_MOSTï¼Œä¸èƒ½è¶…è¿‡çˆ¶å¸ƒå±€ï¼Œæµ‹é‡å¤§å°æ˜¯å±å¹•å¤§å°ï¼›</p></blockquote><pre><code class="java">&lt;com.ljt.rvanalysis.spec.MyLinearLayout    android:layout_width=&quot;wrap_content&quot;    android:layout_height=&quot;wrap_content&quot;    android:orientation=&quot;vertical&quot;&gt;    &lt;com.ljt.rvanalysis.spec.MyTextView        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot; /&gt;&lt;/com.ljt.rvanalysis.spec.MyLinearLayout&gt;</code></pre><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190410181519.png" alt=""></p></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨è‡ªå®šä¹‰ View çš„å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œä¸ç®¡æ€ä¹ˆæ ·éƒ½ç»•ä¸è¿‡ MeasureSpec  çš„å­¦ä¹ ï¼›æ‹–æ‹–æ‹‰æ‹‰å¾ˆä¹…ï¼Œåœ¨æ•°ä¸æ¸…çš„çœ‹äº†å¿˜ï¼Œå¿˜äº†çœ‹ä¹‹åï¼Œè¿˜æ˜¯å†³å®šå†™ç¯‡åšå®¢è®°å½•ä¸€ä¸‹ï¼Œæ¯•ç«Ÿæœ‰æ•ˆçš„è¾“å‡ºæ‰æ˜¯æ£€éªŒè¾“å…¥çš„ä¸äºŒæ³•é—¨ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://joeljt.top/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>View.inflate() çš„å‰ä¸–ä»Šç”Ÿ</title>
    <link href="http://joeljt.top/2019/03/29/View-inflate-analysis/"/>
    <id>http://joeljt.top/2019/03/29/View-inflate-analysis/</id>
    <published>2019-03-28T16:00:00.000Z</published>
    <updated>2019-03-29T08:47:59.124Z</updated>
    
    <content type="html"><![CDATA[<p>è¯¯ç”¨ LayoutInflater çš„ inflate() æ–¹æ³•å·²ç»ä¸æ˜¯ä»€ä¹ˆç¨€ç½•äº‹å„¿äº†â€¦â€¦</p><a id="more"></a><p>åš Android å¼€å‘åšä¹…äº†ï¼Œä¸€å®šä¼šæˆ–å¤šæˆ–å°‘åœ°å¯¹å¸ƒå±€çš„æ¸²æŸ“æœ‰ä¸€äº›æ‡µé€¼ï¼š</p><blockquote><ol><li><code>View.inflate()</code> å’Œ <code>LayoutInflator.from().inflate()</code> æœ‰å•¥åŒºåˆ«ï¼Ÿ</li><li>è°ƒç”¨ inflate() æ–¹æ³•çš„æ—¶å€™æœ‰æ—¶å€™ä¼  nullï¼Œæœ‰æ—¶å€™ä¼  parent æ˜¯ä¸ºå•¥ï¼Ÿ</li><li>ç”¨ LayoutInflater æœ‰æ—¶å€™è¿˜å¯èƒ½ä¼ ä¸ª attachToRoot ï¼Œè¿™åˆæ˜¯ä¸ªå•¥ï¼Ÿ</li></ol></blockquote><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä»æºç çš„è§’åº¦æ¥å¯»æ‰¾ä¸€ä¸‹è¿™å‡ ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼Œåé¢å†ç”¨å‡ ä¸ªç¤ºä¾‹æ¥éªŒè¯æˆ‘ä»¬çš„çŒœæƒ³ã€‚</p><p>è¯ä¸å¤šè¯´ï¼ŒLetâ€™s go !</p><h3 id="åŸºæœ¬ä»‹ç»"><a href="#åŸºæœ¬ä»‹ç»" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h3><p>å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•å…·ä½“åšäº†ä»€ä¹ˆï¼š</p><pre><code class="java">/** * Inflate a view from an XML resource.  This convenience method wraps the {@link * LayoutInflater} class, which provides a full range of options for view inflation. */public static View inflate(Context context, int resource, ViewGroup root) {    LayoutInflater factory = LayoutInflater.from(context);    return factory.inflate(resource, root);}</code></pre><p>å½“æˆ‘ä»¬æŸ¥çœ‹æºç ï¼Œå°±ä¼šå‘ç°ï¼Œè¿™ä¸ªæ–¹æ³•çš„å†…éƒ¨å®é™…ä¸Šå°±æ˜¯è°ƒç”¨äº† <code>LayoutInflater</code> çš„ inflate æ–¹æ³•ã€‚æ­£å¦‚æ­¤æ–¹æ³•çš„æ³¨é‡Šæ‰€è¨€ï¼Œè¿™æ˜¯ä¸€ä¸ªæ–¹ä¾¿å¼€å‘è€…è°ƒç”¨çš„ <code>LayoutInflater</code> çš„åŒ…è£…æ–¹æ³•ï¼Œè€Œ <code>LayoutInflater</code> æœ¬èº«åˆ™ä¸º View çš„æ¸²æŸ“æä¾›äº†æ›´å¤šçš„é€‰æ‹©ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬ç°åœ¨çš„é—®é¢˜å°±å˜æˆäº†ï¼Œ <code>LayoutInflater</code> åˆåšäº†ä»€ä¹ˆï¼Ÿ</p><p>ç»§ç»­è¿½è¸ªä»£ç ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œ <code>LayoutInflator.from().inflate()</code>  æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š</p><pre><code class="java">// LayoutInflator#inflate(int, ViewGroup)public View inflate(@LayoutRes int resource, @Nullable ViewGroup root) {        return inflate(resource, root, root != null);}</code></pre><p>å•¥ï¼Ÿé‡è½½ï¼Ÿ</p><pre><code class="java">// LayoutInflator#inflate(int, ViewGroup, boolean)public View inflate(int resource, ViewGroup root, boolean attachToRoot) {    final Resources res = getContext().getResources();    final XmlResourceParser parser = res.getLayout(resource);    try {        return inflate(parser, root, attachToRoot);    } finally {        parser.close();    }}</code></pre><p>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ï¼Œé€šè¿‡å±‚å±‚è°ƒç”¨ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>LayoutInflator#inflate(int, ViewGroup, boolean)</code> æ–¹æ³•ï¼Œå¾ˆæ˜æ˜¾ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå°†æˆ‘ä»¬ä¼ å…¥çš„å¸ƒå±€ id è½¬æ¢ä¸º XmlResourceParserï¼Œç„¶åè¿›è¡Œå¦ä¸€æ¬¡ï¼Œä¹Ÿæ˜¯æœ€åä¸€æ¬¡é‡è½½ã€‚</p><p>è¿™ä¸ªæ–¹æ³•å°±å‰å®³äº†ï¼Œè¿™é‡ŒåŸºæœ¬ä¸ŠåŒ…æ‹¬äº†æˆ‘ä»¬æ‰€æœ‰é—®é¢˜çš„ç­”æ¡ˆï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p><h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>è¯ä¸å¤šè¯´ï¼Œä¸Šä»£ç ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥é€æ®µåˆ†æä¸‹è¿™ä¸ª <code>inflate</code> æ–¹æ³•ï¼š</p><pre><code class="java">public View inflate(XmlPullParser parser, ViewGroup root, boolean attachToRoot) {    final Context inflaterContext = mContext;    final AttributeSet attrs = Xml.asAttributeSet(parser);    // é»˜è®¤è¿”å›ç»“æœä¸ºä¼ å…¥çš„æ ¹å¸ƒå±€    View result = root;    // é€šè¿‡ createViewFromTag() æ–¹æ³•æ‰¾åˆ°ä¼ å…¥çš„ layoutId çš„æ ¹å¸ƒå±€ï¼Œå¹¶èµ‹å€¼ç»™ temp    final View temp = createViewFromTag(root, name, inflaterContext, attrs);    ViewGroup.LayoutParams params = null;    // å¦‚æœä¼ å…¥çš„çˆ¶å¸ƒå±€ä¸ä¸ºç©º    if (root != null) {        // ä¸ºè¿™ä¸ª root ç”Ÿæˆä¸€å¥—åˆé€‚çš„ LayoutParams        params = root.generateLayoutParams(attrs);        if (!attachToRoot) {            // å¦‚æœæ²¡æœ‰ attachToRootï¼Œé‚£ä¸ºæ ¹å¸ƒå±€è®¾ç½® layoutparams            temp.setLayoutParams(params);        }    }    // å¦‚æœä¼ å…¥çš„çˆ¶å¸ƒå±€ä¸ä¸ºç©ºï¼Œä¸”æƒ³è¦ attachToRoot    if (root != null &amp;&amp; attachToRoot) {        // é‚£å°±å°†ä¼ å…¥çš„å¸ƒå±€ä»¥åŠ layoutparams é€šè¿‡ addView æ–¹æ³•æ·»åŠ åˆ°çˆ¶å¸ƒå±€ä¸­         root.addView(temp, params);    }    // å¦‚æœä¼ å…¥çš„æ ¹å¸ƒå±€ä¸ºç©ºï¼Œæˆ–è€…ä¸æƒ³ attachToRootï¼Œåˆ™è¿”å›è¦åŠ è½½çš„ layoutId    if (root == null || !attachToRoot) {        result = temp;    }    return result;}</code></pre><p>ä»£ç ä¹Ÿåˆ†æå®Œäº†ï¼Œæˆ‘å†æ¥æ€»ç»“ä¸€ä¸‹ï¼š</p><ul><li><p><code>View#inflate</code> åªæ˜¯ä¸ªç®€æ˜“çš„åŒ…è£…æ–¹æ³•ï¼Œå®é™…ä¸Šè¿˜æ˜¯è°ƒç”¨çš„ <code>LayoutInflater#inflate</code> ;</p></li><li><p><code>LayoutInflater#inflate</code> ç”±äºå¯ä»¥è‡ªå·±é€‰æ‹© root å’Œ attachToRoot çš„æ­é…ï¼ˆåé¢æœ‰è§£é‡Šï¼‰ï¼Œä½¿ç”¨èµ·æ¥æ›´åŠ çµæ´»ï¼›</p></li><li><p>å®é™…ä¸Šçš„åŒºåˆ«åªæ˜¯åœ¨äº <code>root</code> æ˜¯å¦ä¼ ç©ºï¼Œä»¥åŠ <code>attachToRoot</code> çœŸå‡ä¸å¦ï¼›</p></li><li><p>å½“  <code>root</code> ä¼ ç©ºæ—¶ï¼Œä¼šç›´æ¥è¿”å›è¦åŠ è½½çš„ <code>layoutId</code>ï¼Œè¿”å›çš„ View æ²¡æœ‰çˆ¶å¸ƒå±€ä¸”æ²¡æœ‰ LayoutParamsï¼›</p></li><li><p>å½“  <code>root</code> ä¸ä¼ ç©ºæ—¶ï¼Œåˆåˆ†ä¸º <code>attachToRoot</code> ä¸ºçœŸæˆ–è€…ä¸ºå‡ï¼š</p><ul><li><p><code>attachToRoot = true</code> </p><p>ä¼šä¸ºä¼ å…¥çš„ <code>layoutId</code> ç›´æ¥è®¾ç½®å‚æ•°ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° <code>root</code> ä¸­ï¼Œç„¶åå°†ä¼ å…¥çš„ <code>root</code> è¿”å›ï¼›</p></li><li><p><code>attachToRoot = false</code> </p><p>ä¼šä¸ºä¼ å…¥çš„ <code>layoutId</code> è®¾ç½®å‚æ•°ï¼Œä½†æ˜¯ä¸ä¼šæ·»åŠ åˆ° <code>root</code> ï¼Œç„¶åè¿”å› <code>layoutId</code> å¯¹åº”çš„ Viewï¼›</p><blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶ä¸é©¬ä¸Šå°† View æ·»åŠ åˆ° parent ä¸­ï¼Œä½†æ˜¯è¿™é‡Œæœ€å¥½ä¹Ÿä¼ ä¸Š parentï¼Œè€Œä¸æ˜¯ç²—æš´çš„ä¼ å…¥ nullï¼›å› ä¸ºå­ View çš„ LayoutParams éœ€è¦ç”± parent æ¥ç¡®å®šï¼›å¦åˆ™ä¼šåœ¨æ‰‹åŠ¨ addView æ—¶è°ƒç”¨ <code>generateDefaultLayoutParams()</code> ä¸ºå­ View ç”Ÿæˆä¸€ä¸ªå®½é«˜éƒ½ä¸ºåŒ…è£¹å†…å®¹çš„ LayoutParamsï¼Œè€Œè¿™å¹¶ä¸ä¸€å®šæ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚</p></blockquote></li></ul></li></ul><h3 id="æµ‹è¯•-amp-æ£€éªŒ"><a href="#æµ‹è¯•-amp-æ£€éªŒ" class="headerlink" title="æµ‹è¯• &amp; æ£€éªŒ"></a>æµ‹è¯• &amp; æ£€éªŒ</h3><p>å•è¯´èµ·æ¥å¯èƒ½æœ‰äº›æŠ½è±¡ï¼Œä¸‹é¢ä½¿ç”¨ä»£ç æ¥è¿›è¡Œå…·ä½“çš„æµ‹è¯•ä¸æ£€éªŒã€‚</p><h4 id="View-inflate-context-layoutId-null"><a href="#View-inflate-context-layoutId-null" class="headerlink" title="View.inflate(context, layoutId, null)"></a>View.inflate(context, layoutId, null)</h4><p>å¦‚ä¹‹å‰æ‰€è¯´ï¼Œè¿™å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ <code>getLayoutInflater().inflate(layoutId, null)</code> ï¼Œç»“åˆä¹‹å‰çš„æºç æ¥çœ‹ï¼š</p><pre><code class="java">public View inflate(XmlPullParser parser, ViewGroup root, boolean attachToRoot) {    View result = root;    final View temp = createViewFromTag(root, name, inflaterContext, attrs);    if (root == null || !attachToRoot) {        result = temp;    }    return result;}</code></pre><p>å¾ˆæ˜æ˜¾ï¼Œä¼ å…¥çš„ <code>root</code> ä¸ºç©ºï¼Œåˆ™ä¼šç›´æ¥å°†åŠ è½½å¥½çš„ xml å¸ƒå±€è¿”å›ï¼Œè€Œè¿™ç§æƒ…å†µä¸‹è¿”å›çš„è¿™ä¸ª View æ²¡æœ‰å‚æ•°ï¼Œä¹Ÿæ²¡æœ‰çˆ¶å¸ƒå±€ã€‚</p><pre><code class="java">protected void onCreate(@Nullable Bundle savedInstanceState) {    super.onCreate(savedInstanceState);    setContentView(R.layout.layout_test);    View inflateView = View.inflate(this, R.layout.layout_basic_use_item, null);    Log.e(&quot;Test&quot;, &quot;LayoutParams -&gt; &quot; + inflateView.getLayoutParams());    Log.e(&quot;Test&quot;, &quot;Parent -&gt; &quot; + inflateView.getParent());}</code></pre><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190329145224.jpg" alt=""></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œæ­£å¦‚æˆ‘ä»¬æƒ³çš„ï¼Œroot ä¼  null æ—¶ï¼Œå‚æ•°ä»¥åŠçˆ¶å¸ƒå±€è¿”å›ç»“æœå‡ä¸º nullã€‚</p><h4 id="View-inflate-context-layoutId-mParent"><a href="#View-inflate-context-layoutId-mParent" class="headerlink" title="View.inflate(context, layoutId, mParent)"></a>View.inflate(context, layoutId, mParent)</h4><p>æŒ‰ä¹‹å‰åˆ†æè¿‡çš„ï¼Œæ­¤æ–¹æ³•å®é™…è°ƒç”¨çš„æ˜¯ <code>getLayoutInflater().inflate(layoutId, root, true)</code> ï¼Œå†æ¥çœ‹æºç ï¼š</p><pre><code class="java">public View inflate(XmlPullParser parser, ViewGroup root, boolean attachToRoot) {    final Context inflaterContext = mContext;    final AttributeSet attrs = Xml.asAttributeSet(parser);    View result = root;     final View temp = createViewFromTag(root, name, inflaterContext, attrs);    ViewGroup.LayoutParams params = null;    if (root != null) {        params = root.generateLayoutParams(attrs);    }    if (root != null &amp;&amp; attachToRoot) {        root.addView(temp, params);    }    return result;}</code></pre><p>å¦‚æºç æ‰€ç¤ºï¼Œè¿”å›çš„ result ä¼šåœ¨æœ€å¼€å§‹å°±è¢«èµ‹å€¼ä¸ºå…¥å‚çš„ rootï¼Œroot ä¸ä¸ºç©ºï¼ŒåŒæ—¶ attachToRoot ä¸º trueï¼Œå°±ä¼šå°†åŠ è½½å¥½çš„å¸ƒå±€ç›´æ¥é€šè¿‡ addView æ–¹æ³•æ·»åŠ åˆ° root å¸ƒå±€ä¸­ï¼Œç„¶åå°† root è¿”å›ã€‚</p><pre><code class="java">protected void onCreate(@Nullable Bundle savedInstanceState) {    super.onCreate(savedInstanceState);    setContentView(R.layout.layout_test);    LinearLayout mParent = findViewById(R.id.ll_root);    View inflateView = View.inflate(this, R.layout.layout_basic_use_item, mParent);    Log.e(&quot;Test&quot;, &quot;LayoutParams -&gt; &quot; + inflateView.getLayoutParams());    Log.e(&quot;Test&quot;, &quot;Parent -&gt; &quot; + inflateView.getParent());    Log.e(&quot;Test&quot;, &quot;inflateView -&gt; &quot; + inflateView);}</code></pre><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190329153240.jpg" alt=""></p><p>å¦‚å›¾ç¤ºï¼Œè¿”å›çš„ View æ­£æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ mParentï¼Œå¯¹åº”çš„ id æ˜¯ ll_rootï¼Œå‚æ•°ä¹Ÿä¸å†ä¸ºç©ºã€‚</p><p>####getLayoutInflater().inflate(layoutId, root, false) </p><p>ä¹Ÿè®¸ä¼šæœ‰äººé—®äº†ï¼Œç°åœ¨è¦ä¹ˆæ˜¯ root ä¼ ç©ºï¼Œè¿”å› layoutId å¯¹åº”çš„å¸ƒå±€ï¼›è¦ä¹ˆæ˜¯ root ä¸ä¼ ç©ºï¼Œè¿”å›ä¼ å…¥çš„ root å¸ƒå±€ã€‚é‚£æˆ‘è¦æ˜¯æƒ³ root ä¸ä¼ ç©ºï¼Œä½†æ˜¯è¿˜æ˜¯è¿”å› layoutId å¯¹åº”çš„å¸ƒå±€å‘¢ï¼Ÿ</p><p>è¿™å°±æ˜¯ <code>View#inflate</code> çš„å±€é™äº†ï¼Œç”±äºå®ƒæ˜¯åŒ…è£…æ–¹æ³•ï¼Œå› æ­¤ <code>attachToRoot</code> å¹¶ä¸èƒ½å› éœ€å®šåˆ¶ã€‚è¿™æ—¶å€™æˆ‘ä»¬å®Œå…¨å¯ä»¥è‡ªå·±è°ƒç”¨ <code>getLayoutInflater().inflate(layoutId, root, false)</code> æ–¹æ³•ï¼Œæ‰‹åŠ¨çš„å°†ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ ä¸º falseï¼ŒåŒæ—¶ä¸ºè¿™ä¸ªæ–¹æ³•ä¼ å…¥ç›®æ ‡æ ¹å¸ƒå±€ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªæœ‰ LayoutParamsï¼Œä½†æ˜¯æ²¡æœ‰ <code>parentView</code> çš„ <code>layoutId</code> å¸ƒå±€äº†ã€‚</p><pre><code class="java">protected void onCreate(@Nullable Bundle savedInstanceState) {    super.onCreate(savedInstanceState);    setContentView(R.layout.layout_test);    LinearLayout mParent = findViewById(R.id.ll_root);    View inflateView = getLayoutInflater().inflate(R.layout.main, mParent, false);    Log.e(&quot;Test&quot;, &quot;LayoutParams -&gt; &quot; + inflateView.getLayoutParams());    Log.e(&quot;Test&quot;, &quot;Parent -&gt; &quot; + inflateView.getParent());}</code></pre><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190329155230.jpg" alt=""></p><p>ä¸æˆ‘ä»¬åˆ†æçš„ä¸€è‡´ï¼Œæœ‰å‚æ•°ï¼Œä½†æ˜¯æ²¡æœ‰çˆ¶å¸ƒå±€ï¼Œä¸”è¿”å›çš„å°±æ˜¯æˆ‘ä»¬åŠ è½½çš„å¸ƒå±€ idã€‚æˆ‘ä»¬åœ¨ä¹‹åå¯ä»¥é€šè¿‡ addView æ–¹æ³•æ‰‹åŠ¨å°†è¿™ä¸ªå¸ƒå±€åŠ å…¥çˆ¶å¸ƒå±€ä¸­ã€‚</p><p><strong>è¿™é‡Œè¿˜æœ‰ä¸ªè¦æ³¨æ„çš„ç‚¹</strong>ï¼Œé‚£å°±æ˜¯ <code>params = root.generateLayoutParams(attrs);</code> è¿™å¥ä»£ç ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œä¸º <code>layoutId</code> è®¾ç½®çš„ params å‚æ•°ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡ root æ¥ç”Ÿæˆçš„ã€‚è¿™ä¹Ÿå°±å‘Šè¯‰æˆ‘ä»¬ï¼Œè™½ç„¶ä¸é©¬ä¸Šæ·»åŠ åˆ° parent ä¸­ï¼Œä½†æ˜¯è¿™é‡Œæœ€å¥½ä¹Ÿä¼ ä¸Š parentï¼Œè€Œä¸æ˜¯ç²—æš´çš„ä¼ å…¥ nullï¼Œå› ä¸ºå­ View çš„ LayoutParams éœ€è¦ç”± parent æ¥ç¡®å®šï¼›å½“ç„¶ï¼Œä¼ å…¥ null ä¹Ÿä¸ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºåœ¨æ‰§è¡Œ <code>addView()</code> æ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰ childView æ²¡æœ‰å‚æ•°ï¼Œä¼šè°ƒç”¨ <code>generateDefaultLayoutParams()</code> ç”Ÿæˆä¸€ä¸ªå®½é«˜éƒ½åŒ…è£¹çš„ LayoutParams èµ‹å€¼ç»™ childViewï¼Œè€Œè¿™å¹¶ä¸ä¸€å®šæ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚</p><h4 id="attachToRoot-å¿…é¡»ä¸º-falseï¼"><a href="#attachToRoot-å¿…é¡»ä¸º-falseï¼" class="headerlink" title="attachToRoot å¿…é¡»ä¸º falseï¼"></a>attachToRoot å¿…é¡»ä¸º falseï¼</h4><p>ä»£ç å†™å¤šäº†ï¼Œå¤§å®¶æœ‰æ—¶å€™ä¼šå‘ç°è¿™ä¸ª <code>attachToRoot</code> ä¹Ÿä¸æ˜¯æƒ³æ€æ ·å°±æ€æ ·çš„ï¼Œæœ‰æ—¶å€™å®ƒè¿˜å°±å¿…é¡»æ˜¯ falseï¼Œä¸èƒ½ä¸º trueã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™äº›æƒ…å†µã€‚</p><ul><li><p>RecylerView#onCreateViewHolder()</p><p>åœ¨ä¸º RecyclerView åˆ›å»º ViewHolder æ—¶ï¼Œç”±äº View å¤ç”¨çš„é—®é¢˜ï¼Œæ˜¯ RecyclerView æ¥å†³å®šä»€ä¹ˆæ—¶å€™å±•ç¤ºå®ƒçš„å­Viewï¼Œè¿™ä¸ªå®Œå…¨ä¸ç”±æˆ‘ä»¬å†³å®šï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒattachToRoot å¿…é¡»ä¸º falseï¼š</p><pre><code class="java">public ViewHolder onCreateViewHolder(ViewGroup parent, int viewType) {          LayoutInflater inflater = LayoutInflater.from(getActivity());          View view = inflater.inflate(R.layout.item, parent, false);          return new ViewHolder(view);  }</code></pre></li><li><p>Fragment#onCreateView()</p><p>ç”±äº Fragment éœ€è¦ä¾èµ–äº Activity å±•ç¤ºï¼Œä¸€èˆ¬åœ¨ Activity ä¸­ä¹Ÿä¼šæœ‰å®¹å™¨å¸ƒå±€æ¥ç››æ”¾ Fragmentï¼š</p><pre><code class="java">Fragment fragment = new Fragment();getSupportFragmentManager()        .beginTransaction()        .add(R.id.root_container, fragment)        .commit(); </code></pre><p>ä¸Šè¿°ä»£ç ä¸­çš„ <code>R.id.root_container</code> ä¾¿ä¸ºå®¹å™¨ï¼Œè¿™ä¸ª View ä¼šä½œä¸ºå‚æ•°ä¼ é€’ç»™ <code>Fragment#onCreateView()</code> :</p><pre><code class="java">public View onCreateView(LayoutInflater inflater, ViewGroup container,                          Bundle savedInstanceState) {    return inflater.inflate(R.layout.fragment_layout, parentViewGroup, false); }</code></pre><p>å®ƒä¹Ÿæ˜¯ä½ åœ¨ inflate() æ–¹æ³•ä¸­ä¼ å…¥çš„ ViewGroupï¼ŒFragmentManager ä¼šå°† Fragment çš„ View æ·»åŠ åˆ° ViewGroup ä¸­ï¼Œè¨€å¤–ä¹‹æ„å°±æ˜¯ï¼ŒFragment å¯¹åº”çš„å¸ƒå±€å±•ç¤ºæˆ–è€…è¯´æ·»åŠ è¿› ViewGroup æ—¶ä¹Ÿä¸æ˜¯æˆ‘ä»¬æ¥æ§åˆ¶çš„ï¼Œè€Œæ˜¯ FragmentManager æ¥æ§åˆ¶çš„ã€‚</p></li></ul><p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼Œ<strong>å½“æˆ‘ä»¬ä¸ä¸ºå­ View çš„å±•ç¤ºè´Ÿè´£æ—¶ï¼ŒattachToRoot å¿…é¡»ä¸º falseï¼›å¦åˆ™å°±ä¼šå‡ºç°å¯¹åº”çš„è´Ÿè´£äººï¼Œæ¯”å¦‚ä¸Šé¢è¯´çš„ Rv æˆ–è€… FragmentManagerï¼Œå·²ç»æŠŠå¸ƒå±€ id æ·»åŠ åˆ° ViewGroup äº†ï¼Œæˆ‘ä»¬è¿˜ç»§ç»­è®¾ç½® attachToRoot ä¸º trueï¼Œæƒ³è¦æ‰‹åŠ¨ addViewï¼Œé‚£å¿…ç„¶ä¼šå‘ç”Ÿ child already has parent çš„é”™è¯¯ã€‚</strong></p><p>ä»¥ä¸Šã€‚</p><h4 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h4><ul><li><a href="https://juejin.im/entry/5a1513abf265da43052e4473" target="_blank" rel="noopener">æ·±å…¥ç†è§£LayoutInflater.inflate()</a></li><li><a href="https://www.jianshu.com/p/cdc9d4c0826e" target="_blank" rel="noopener">LayoutInflater.inflateå’ŒView.inflate</a></li><li><a href="">Android API 28 View.java / LayoutInflater.java / ViewGroup.java</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¯¯ç”¨ LayoutInflater çš„ inflate() æ–¹æ³•å·²ç»ä¸æ˜¯ä»€ä¹ˆç¨€ç½•äº‹å„¿äº†â€¦â€¦&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://joeljt.top/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>ConstraintLayout ä»‹ç»</title>
    <link href="http://joeljt.top/2019/03/22/ConstraintLayout-learning/"/>
    <id>http://joeljt.top/2019/03/22/ConstraintLayout-learning/</id>
    <published>2019-03-21T16:00:00.000Z</published>
    <updated>2019-03-22T10:51:31.927Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸çŸ¥é“ä»ä»€ä¹ˆæ—¶å€™å¼€å§‹ï¼ŒAndroid æ­»ä¸¢ä¸¢å·²ç»é»˜è®¤ä½¿ç”¨çº¦æŸå¸ƒå±€ ConstraintLayout ä½œä¸ºé»˜è®¤å¸ƒå±€äº†ï¼Œä½†æ˜¯æ‡’ç™Œå‘ä½œä¸€ç›´ä¸æƒ³å­¦ä¹ ï¼Œæ¯æ¬¡éƒ½æ¢æˆ LinearLayoutï¼Œè¿™æ¬¡ä¹Ÿå¿˜è®°äº†ä¸ºå•¥å¼€å§‹å­¦ä¹ è¿™ä¸ªä¸œè¥¿ï¼Œå­¦å®Œå‘ç°è¿˜æŒºçˆ½â€¦â€¦å†™ä¸ªç¬”è®°è®°å½•ä¸€ä¸‹ï¼Œå“ˆå“ˆ</p><a id="more"></a><p>æ­£æ–‡å¼€å§‹~</p><h4 id="ç›¸å¯¹å¸ƒå±€"><a href="#ç›¸å¯¹å¸ƒå±€" class="headerlink" title="ç›¸å¯¹å¸ƒå±€"></a>ç›¸å¯¹å¸ƒå±€</h4><h5 id="å±æ€§é›†åˆ"><a href="#å±æ€§é›†åˆ" class="headerlink" title="å±æ€§é›†åˆ"></a>å±æ€§é›†åˆ</h5><p>ç±»ä¼¼ RelativeLayout ï¼Œä½¿ç”¨ç›¸å¯¹ä½ç½®çš„å±æ€§æ¥äº’ç›¸çº¦æŸä½ç½®ã€‚å…·ä½“çš„å±æ€§ä»¥åŠä½¿ç”¨æ–¹å¼ä¹Ÿç±»ä¼¼ RelativeLayoutï¼Œé»˜è®¤åƒ FrameLayout ä¸€æ ·å †å åœ¨ä¸€èµ·ï¼Œä½¿ç”¨å±æ€§è®²å±‚çº§å…³ç³»åŒºåˆ†å¼€ï¼š</p><pre><code class="xml">layout_constraintLeft_toLeftOf   å½“å‰æ§ä»¶çš„å·¦ä¾§ä¸æŸä¸ªæ§ä»¶çš„å·¦ä¾§å¯¹é½layout_constraintLeft_toRightOf  å½“å‰æ§ä»¶çš„å·¦ä¾§ä¸æŸä¸ªæ§ä»¶çš„å³ä¾§å¯¹é½layout_constraintRight_toLeftOf  å½“å‰æ§ä»¶çš„å³ä¾§ä¸æŸä¸ªæ§ä»¶çš„å·¦ä¾§å¯¹é½layout_constraintRight_toRightOf å½“å‰æ§ä»¶çš„å³ä¾§ä¸æŸä¸ªæ§ä»¶çš„å³ä¾§å¯¹é½layout_constraintStart_toEndOf   åŒä¸Šlayout_constraintStart_toStartOflayout_constraintEnd_toStartOflayout_constraintEnd_toEndOflayout_constraintTop_toTopOf       å½“å‰æ§ä»¶ä¸æŸä¸ªæ§ä»¶é¡¶ç«¯å¯¹é½layout_constraintTop_toBottomOf    å³å½“å‰æ§ä»¶æŸä¸ªæ§ä»¶çš„ä¸‹é¢layout_constraintBottom_toTopOf    å³å½“å‰æ§ä»¶åœ¨æŸä¸ªæ§ä»¶çš„ä¸Šé¢layout_constraintBottom_toBottomOf å½“å‰æ§ä»¶ä¸æŸä¸ªæ§ä»¶åº•éƒ¨å¯¹é½layout_constraintBaseline_toBaselineOf æ–‡æœ¬åŸºçº¿å¯¹é½</code></pre><h5 id="å…·ä½“ç¤ºä¾‹"><a href="#å…·ä½“ç¤ºä¾‹" class="headerlink" title="å…·ä½“ç¤ºä¾‹"></a>å…·ä½“ç¤ºä¾‹</h5><pre><code class="xml">&lt;!-- å±…ä¸­å¯¹é½å®ç°æ–¹å¼ --&gt;&lt;!-- ä¸Šä¸‹å·¦å³å…¨éƒ¨å— parent çº¦æŸï¼Œæœ€åçš„æ•ˆæœå°±æ˜¯ã€Œå±…ä¸­å¯¹é½ã€ --&gt;&lt;TextView    android:layout_width=&quot;wrap_content&quot;    android:layout_height=&quot;wrap_content&quot;    android:text=&quot;å±…ä¸­å¯¹é½&quot;    app:layout_constraintTop_toTopOf=&quot;parent&quot;    app:layout_constraintBottom_toBottomOf=&quot;parent&quot;    app:layout_constraintLeft_toLeftOf=&quot;parent&quot;    app:layout_constraintRight_toRightOf=&quot;parent&quot;/&gt;&lt;!-- åŒç†ï¼Œå·¦å³å— parent çº¦æŸï¼Œæ•ˆæœå°±æ˜¯ã€Œæ°´å¹³å±…ä¸­å¯¹é½ã€--&gt;&lt;TextView    android:layout_width=&quot;wrap_content&quot;    android:layout_height=&quot;wrap_content&quot;    android:text=&quot;æ°´å¹³å±…ä¸­å¯¹é½&quot;    app:layout_constraintLeft_toLeftOf=&quot;parent&quot;    app:layout_constraintRight_toRightOf=&quot;parent&quot;/&gt;&lt;!-- åŒç†ï¼Œä¸Šä¸‹å— parent çº¦æŸï¼Œæ•ˆæœå°±æ˜¯ã€Œå‚ç›´å±…ä¸­å¯¹é½ã€--&gt;&lt;TextView    android:layout_width=&quot;wrap_content&quot;    android:layout_height=&quot;wrap_content&quot;    android:text=&quot;å‚ç›´å±…ä¸­å¯¹é½&quot;    app:layout_constraintTop_toTopOf=&quot;parent&quot;    app:layout_constraintBottom_toBottomOf=&quot;parent&quot;/&gt;</code></pre><p>å±…ä¸­å¯¹é½å¾ˆå¥½ç†è§£ï¼Œä¸‹è¾¹æˆ‘ä»¬æ¥å†™ä¸€ä¸ªæ­£å¸¸çš„ item å¸ƒå±€çœ‹çœ‹ï¼š</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190322142136.png" alt="ConstraintLayout å®ç°çš„ item å¸ƒå±€"></p><pre><code class="xml">&lt;android.support.constraint.ConstraintLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;    xmlns:tools=&quot;http://schemas.android.com/tools&quot;    android:layout_width=&quot;match_parent&quot;    android:layout_height=&quot;wrap_content&quot;    android:padding=&quot;5dp&quot;&gt;    &lt;ImageView        android:id=&quot;@+id/iv_logo&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        android:background=&quot;@mipmap/ic_launcher&quot; /&gt;    &lt;!-- è®¾ç½®æ ‡é¢˜åç§° View çš„å·¦ä¾§è¾¹ç¼˜ä½äº logo çš„å³ä¾§ --&gt;    &lt;TextView        android:id=&quot;@+id/tv_title&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        android:layout_marginLeft=&quot;10dp&quot;        android:text=&quot;è™¾åƒè™¾æ¶®ï¼ˆåè´¸åº—ï¼‰&quot;        app:layout_constraintLeft_toRightOf=&quot;@+id/iv_logo&quot;        app:layout_constraintTop_toTopOf=&quot;parent&quot; /&gt;    &lt;!-- è®¾ç½®ä»·æ ¼ View çš„åº•éƒ¨é è¿‘çˆ¶å¸ƒå±€ï¼Œä¸”é¡¶éƒ¨å‚è€ƒ titleViewï¼ŒåŒæ—¶å·¦ä¾§ä¸ titleView å¯¹é½ --&gt;    &lt;TextView        android:id=&quot;@+id/tv_price&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        android:text=&quot;ï¿¥64/äºº&quot;        android:textSize=&quot;13sp&quot;        app:layout_constraintBottom_toBottomOf=&quot;parent&quot;        app:layout_constraintLeft_toLeftOf=&quot;@id/tv_title&quot;        app:layout_constraintTop_toBottomOf=&quot;@id/tv_title&quot; /&gt;    &lt;!-- è®¾ç½® distanceView ç´§è´´å±å¹•å³ä¾§ï¼Œä¸”é¡¶éƒ¨ä¸ priceView å¯¹é½--&gt;    &lt;TextView        android:id=&quot;@+id/tv_distance&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        android:text=&quot;1.1km&quot;        app:layout_constraintRight_toRightOf=&quot;parent&quot;        app:layout_constraintTop_toTopOf=&quot;@id/tv_price&quot; /&gt;    &lt;!-- è®¾ç½® areaView é¡¶éƒ¨ä¸å·¦ä¾§éƒ½å‚è€ƒ priceViewï¼Œåº•éƒ¨ä½ç½®å‚è€ƒ ivLogo--&gt;    &lt;TextView        android:id=&quot;@+id/tv_area&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        android:text=&quot;æœé˜³åŒº å¤§æœ›è·¯&quot;        android:textSize=&quot;13sp&quot;        app:layout_constraintBottom_toBottomOf=&quot;@id/iv_logo&quot;        app:layout_constraintLeft_toLeftOf=&quot;@id/tv_price&quot;        app:layout_constraintTop_toBottomOf=&quot;@id/tv_price&quot; /&gt;    &lt;!-- è®¾ç½® hotView ç´§è´´å±å¹•å³ä¾§ï¼Œä¸”é¡¶éƒ¨ä¸ areaView é¡¶éƒ¨å¯¹é½--&gt;    &lt;TextView        android:id=&quot;@+id/tv_curr_hot&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        android:text=&quot;å½“å‰äººæ°”89&quot;        android:textSize=&quot;13sp&quot;        app:layout_constraintRight_toRightOf=&quot;parent&quot;        app:layout_constraintTop_toTopOf=&quot;@id/tv_area&quot; /&gt;    &lt;!-- dividerView ä½äºæ•´ä¸ªå¸ƒå±€çš„æœ€åº•éƒ¨ï¼Œä¸”å§‹ç»ˆä½äº ivLogo åº•éƒ¨ï¼Œå¹¶ä¿æŒä¸€å®šè·ç¦» --&gt;    &lt;View        android:layout_width=&quot;match_parent&quot;        android:layout_height=&quot;1px&quot;        android:layout_marginTop=&quot;7dp&quot;        android:background=&quot;@android:color/darker_gray&quot;        app:layout_constraintBottom_toBottomOf=&quot;parent&quot;        app:layout_constraintTop_toBottomOf=&quot;@id/iv_logo&quot; /&gt;&lt;/android.support.constraint.ConstraintLayout&gt;</code></pre><p>å¯ä»¥å‘ç°ä½¿ç”¨çº¦æŸå¸ƒå±€å®ç°æ¯”æ™®é€šçš„ RL å®ç°è¿˜è¦ç®€å•ï¼Œç•Œé¢å®Œå…¨å®ç°æ‰å¹³åŒ–ï¼Œæ²¡æœ‰ä»»ä½•åµŒå¥—ã€‚å¦‚æœä½¿ç”¨ LL æˆ–è€… RL æ¥å®ç°åŒæ ·çš„æ•ˆæœï¼Œä»£ç è¦å¤æ‚å¤šå°‘æƒ³å¿…ä¸ç”¨æˆ‘å¤šè¯´ã€‚</p><h4 id="Bias-åå‘"><a href="#Bias-åå‘" class="headerlink" title="Bias åå‘"></a>Bias åå‘</h4><p>ä»¥ä¸Šçš„å†…å®¹å°±æ˜¯åŸºæœ¬ä½¿ç”¨äº†ï¼ŒæŠŠä¸Šä¸‹å·¦å³å„ç§å‚è€ƒã€ä¾èµ–å…³ç³»ææ˜ç™½ï¼Œæœ¬èº«æ²¡æœ‰å¤šä¹ˆå¤æ‚ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿå’Œ RL å·®ä¸å¤šï¼Œä¸‹é¢æ¥ä»‹ç»ä¸€äº›æ–°èŠ±æ ·ã€‚</p><p><code>bias</code> å¾ˆå¥½ç†è§£ï¼Œæ­£å¦‚å…¶è‹±æ–‡æœ¬æ„ä¸€æ ·ï¼Œå®ƒè¡¨è¾¾çš„æ˜¯<strong>åç§»</strong>ã€‚å½“æŸä¸€å¸ƒå±€åŒæ—¶å—ä¸¤ä¸ªç›¸åæ–¹å‘çš„çº¦æŸåŠ›æ—¶ï¼Œè¯¥å¸ƒå±€å°±ä¼šå¤„äºçº¦æŸå®ƒçš„é‚£ä¸¤ä¸ªåŠ›é‡çš„æ­£ä¸­å¤®ã€‚è€Œ <code>layout_constraintHorizontal_bias</code> ä¸ <code>layout_constraintVertical_bias</code> å°±æ˜¯ç”¨åœ¨è¿™ç§æ—¶å€™ï¼Œç”¨æ¥å°†æŸä¸€æ–¹å‘çš„çº¦æŸåŠ›å‡å¼±ã€‚æ¥è‡ªä¸¤ä¾§çš„çº¦æŸåŠ›å¯ä»¥ä¸º parentï¼Œä¹Ÿå¯ä»¥æ˜¯æ™®é€š Viewã€‚</p><p>æ–‡å­—æè¿°å¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œå…·ä½“å¸ƒå±€æ–‡ä»¶è¿˜æ˜¯æ›´å¥½ç†è§£ä¸€äº›ï¼š</p><pre><code class="xml">&lt;android.support.constraint.ConstraintLayout     android:layout_width=&quot;match_parent&quot;    android:layout_height=&quot;match_parent&quot;&gt;    &lt;TextView        android:id=&quot;@+id/tv1&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        android:text=&quot;this is a text&quot;        app:layout_constraintLeft_toLeftOf=&quot;parent&quot; /&gt;    &lt;TextView        android:id=&quot;@+id/tv2&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        android:text=&quot;this is a text&quot;        app:layout_constraintHorizontal_bias=&quot;0.3&quot;        app:layout_constraintLeft_toRightOf=&quot;@id/tv1&quot;        app:layout_constraintRight_toLeftOf=&quot;@id/tv3&quot; /&gt;    &lt;TextView        android:id=&quot;@+id/tv3&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        android:text=&quot;this is a text&quot;        app:layout_constraintRight_toRightOf=&quot;parent&quot; /&gt;&lt;/android.support.constraint.ConstraintLayout&gt;</code></pre><p>å¸ƒå±€å¾ˆç®€å•ï¼Œä¸‰ä¸ª TextView å¹¶æ’æ˜¾ç¤ºï¼Œå·¦å³ä¸¤ä¸ªåˆ†åˆ«ç´§è´´çˆ¶å¸ƒå±€ï¼Œä¸­é—´ä¸€ä¸ªå—å·¦å³ä¸¤ä¾§å¸ƒå±€çº¦æŸï¼Œæœ¬æ¥åº”è¯¥æ˜¯ä½äºä¸¤ä¸ª TextView æ­£ä¸­å¤®ï¼Œä½†æ˜¯ç”±äºè®¾ç½®äº† <code>layout_constraintHorizontal_bias</code> å°äº 0.5ï¼Œæ‰€ä»¥æœ€åæ•ˆæœä¸­é—´çš„ TextView æ•´ä½“åå‘å·¦ä¾§ï¼Œå±•ç¤ºå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190322145701.jpg" alt=""></p><h4 id="Circle-å¸ƒå±€"><a href="#Circle-å¸ƒå±€" class="headerlink" title="Circle å¸ƒå±€"></a>Circle å¸ƒå±€</h4><p>è¿™ä¸ªçœ‹ä¸Šå»å¾ˆå‰å®³çš„ï¼å¯ä»¥ä»¤ B å¸ƒå±€ä»¥ A å¸ƒå±€ä¸ºåœ†å¿ƒï¼Œç„¶åç”¨è§’åº¦å’ŒåŠå¾„è·ç¦»æ¥çº¦æŸä¸¤ä¸ªå¸ƒå±€çš„ä½ç½®ã€‚åºŸè¯ä¸å¤šè¯´ï¼Œä¸Šå›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190322153304.jpg" alt="">è¿™ä¸ªä¹Ÿå¾ˆå¥½ç†è§£ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªå±æ€§ï¼š</p><pre><code>layout_constraintCircle ï¼š      å½“å‰å¸ƒå±€ä»¥å“ªä¸ªå¸ƒå±€ä¸ºåœ†å¿ƒlayout_constraintCircleRadius ï¼šåŠå¾„layout_constraintCircleAngle ï¼š æ‘†æ”¾è§’åº¦</code></pre><p>æˆ‘åæ­£æ˜¯ç»™è°·æ­Œè·ªäº†â€¦â€¦</p><pre><code class="xml">&lt;android.support.constraint.ConstraintLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;    android:layout_width=&quot;match_parent&quot;    android:layout_height=&quot;match_parent&quot;    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;&gt;    &lt;TextView        android:id=&quot;@+id/tv_center&quot;        app:layout_constraintLeft_toLeftOf=&quot;parent&quot;        app:layout_constraintRight_toRightOf=&quot;parent&quot;        app:layout_constraintTop_toTopOf=&quot;parent&quot;        app:layout_constraintBottom_toBottomOf=&quot;parent&quot;        android:text=&quot;Circle Center&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot; /&gt;    &lt;!-- ã€Œæµ‹è¯•å¸ƒå±€ã€ä»¥ tv_center ä¸ºåœ†å¿ƒï¼Œä½äºå…¶ 135Â° æ–¹å‘çš„ 100dp å¤„ --&gt;    &lt;TextView        android:text=&quot;æµ‹è¯•å¸ƒå±€&quot;        app:layout_constraintCircle=&quot;@id/tv_center&quot;        app:layout_constraintCircleAngle=&quot;135&quot;        app:layout_constraintCircleRadius=&quot;100dp&quot;        android:textColor=&quot;@android:color/black&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot; /&gt;&lt;/android.support.constraint.ConstraintLayout&gt;</code></pre><h4 id="æ›¿ä»£-MATCH-PARENT-çš„-MATCH-CONSTRAINT"><a href="#æ›¿ä»£-MATCH-PARENT-çš„-MATCH-CONSTRAINT" class="headerlink" title="æ›¿ä»£ MATCH_PARENT çš„ MATCH_CONSTRAINT"></a>æ›¿ä»£ MATCH_PARENT çš„ MATCH_CONSTRAINT</h4><p>åœ¨çº¦æŸå¸ƒå±€ä¸­ï¼Œç”±äºå¸ƒå±€å—å„æ–¹çº¦æŸæ§åˆ¶ï¼Œä¹Ÿå°±æ²¡æœ‰æ‰€è°“çš„ã€Œmatch_parentã€äº†ã€‚éšä¹‹è€Œæ¥çš„éœ€æ±‚åˆ™æ˜¯ï¼Œå·¦è¾¹æœ‰ä¸ªå¸ƒå±€çº¦æŸæˆ‘ï¼Œå³è¾¹è¿˜æœ‰ä¸ªå¸ƒå±€çº¦æŸæˆ‘ï¼Œç„¶åæˆ‘å°±æƒ³å……æ»¡å‰©ä½™çš„å…¨éƒ¨ä½ç½®ï¼Œã€Œmatch_constraintã€ä¹Ÿå°±åº”è¿è€Œç”Ÿäº†ã€‚</p><p>è¯´èµ·æ¥å¤æ‚ï¼Œå…¶å®åªéœ€è¦æŠŠå¯¹åº”çš„ View å®½é«˜è®¾ç½®ä¸º 0dp å³å¯ï¼Œè¯¥ View å°±ä¼šå æ®ä¸Šå‰©ä½™çš„æ‰€æœ‰å¯ç”¨ç©ºé—´ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè°·æ­Œç»™æˆ‘ä»¬æä¾›äº†å‡ ä¸ªé¢å¤–çš„å±æ€§ï¼š</p><pre><code>layout_constraintWidth_min   å®½åº¦æœ€å°å€¼layout_constraintHeight_min  é«˜åº¦æœ€å°å€¼layout_constraintWidth_max   å®½åº¦æœ€å¤§å€¼layout_constraintHeight_max  é«˜åº¦æœ€å¤§å€¼layout_constraintWidth_percent   å®½åº¦å å‰©ä½™ä½ç½®çš„ç™¾åˆ†æ¯”layout_constraintHeight_percent  é«˜åº¦å å‰©ä½™ä½ç½®çš„ç™¾åˆ†æ¯”</code></pre><p>å…·ä½“ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><pre><code class="xml">&lt;android.support.constraint.ConstraintLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;    android:layout_width=&quot;match_parent&quot;    android:layout_height=&quot;match_parent&quot;&gt;    &lt;Button        android:id=&quot;@+id/btn1&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        android:text=&quot;Test Button&quot;        app:layout_constraintLeft_toLeftOf=&quot;parent&quot; /&gt;    &lt;Button        android:id=&quot;@+id/btn2&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        android:text=&quot;Button&quot;        app:layout_constraintRight_toRightOf=&quot;parent&quot; /&gt;    &lt;Button        android:id=&quot;@+id/btn3&quot;        android:layout_width=&quot;0dp&quot;        android:layout_height=&quot;wrap_content&quot;        app:layout_constrainedWidth=&quot;true&quot;        android:text=&quot;Button&quot;        app:layout_constraintWidth_min=&quot;wrap&quot;        app:layout_constraintWidth_max=&quot;wrap&quot;        app:layout_constraintWidth_percent=&quot;0.3&quot;        app:layout_constraintLeft_toRightOf=&quot;@id/btn1&quot;        app:layout_constraintRight_toLeftOf=&quot;@id/btn2&quot; /&gt;&lt;/android.support.constraint.ConstraintLayout&gt;</code></pre><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190322163826.jpg" alt=""></p><h4 id="Chains-é“¾"><a href="#Chains-é“¾" class="headerlink" title="Chains é“¾"></a>Chains é“¾</h4><p>å¦‚æœå‡ ä¸ªä¸åŒçš„ View ä¸¤ä¸¤å‘ç”Ÿå…³è”ï¼Œå¦‚ä¸‹å›¾ï¼Œåˆ™è¿™å‡ ä¸ª View æ„æˆäº†ä¸€ä¸ª Chains(é“¾)ã€‚</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190322170158.jpg" alt=""></p><p>å…·ä½“å¸ƒå±€ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="xml">&lt;android.support.constraint.ConstraintLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;    android:layout_width=&quot;match_parent&quot;    android:layout_height=&quot;match_parent&quot;&gt;    &lt;Button        android:id=&quot;@+id/btn1&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        android:text=&quot;Button&quot;        app:layout_constraintLeft_toLeftOf=&quot;parent&quot;        app:layout_constraintRight_toLeftOf=&quot;@id/btn2&quot; /&gt;    &lt;Button        android:id=&quot;@+id/btn2&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        android:text=&quot;Button&quot;        app:layout_constraintLeft_toRightOf=&quot;@id/btn1&quot;        app:layout_constraintRight_toLeftOf=&quot;@id/btn3&quot; /&gt;    &lt;Button        android:id=&quot;@+id/btn3&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        android:text=&quot;Button&quot;        app:layout_constraintLeft_toRightOf=&quot;@id/btn2&quot;        app:layout_constraintRight_toRightOf=&quot;parent&quot; /&gt;&lt;/android.support.constraint.ConstraintLayout&gt;</code></pre><p>è¿™æ ·è¿™ä¸‰ä¸ª Button å°±å½¢æˆäº†ä¸€ä¸ªæ¨ªå‘çš„ Chainï¼Œåœ¨è¿™ä¸ªé“¾çš„æœ€å·¦ä¾§çš„å…ƒç´ æˆä¸ºé“¾å¤´ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶èº«ä¸Šè®¾ç½®ä¸€äº›å±æ€§ï¼Œæ¥å†³å®šè¿™ä¸ªé“¾çš„å±•ç¤ºæ•ˆæœï¼š</p><p>è¯¥å±æ€§ä¸ºï¼š</p><pre><code>layout_constraintHorizontal_chainStylelayout_constraintVertical_chainStyle</code></pre><p>å…¶å–å€¼å¯ä»¥ä¸ºï¼šspreadã€spread_insideã€packedã€‚</p><p>å…·ä½“æ ·å¼å±•ç¤ºå¦‚ä¸‹ï¼š</p><ol><li>spreadï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯æŒ‰ç…§æƒé‡ç­‰åˆ†</li></ol><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190322171443.jpg" alt=""></p><ol><li><p>spread_insideï¼Œä¹Ÿæ˜¯ç­‰åˆ†å±•ç¤ºï¼Œä½†æ˜¯ä¸¤ä¾§å¸é™„</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190322171444.jpg" alt=""></p></li><li><p>packedï¼Œæ•´æ¡é“¾æŒ¤åœ¨ä¸€èµ·ï¼Œå±…ä¸­å±•ç¤º</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190322171442.jpg" alt=""></p></li></ol><p>å®˜ç½‘æœ‰ä¸€ä¸ªå›¾æ¥å±•ç¤ºä¸åŒæ ·å¼çš„ Chainsï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹ï¼Œä¹Ÿå¾ˆå½¢è±¡ï¼š</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190322172439.jpg" alt=""></p><h4 id="è™šæ‹Ÿè¾…åŠ©è§†å›¾"><a href="#è™šæ‹Ÿè¾…åŠ©è§†å›¾" class="headerlink" title="è™šæ‹Ÿè¾…åŠ©è§†å›¾"></a>è™šæ‹Ÿè¾…åŠ©è§†å›¾</h4><p>ä¸ä»¥å¾€çš„ ViewGroup ä¸åŒï¼ŒConstraintLayout è¿˜æä¾›äº†å‡ ç§è¾…åŠ©é¡µé¢ç»˜åˆ¶çš„å¸ƒå±€ï¼Œè¿™ç§å¸ƒå±€ä¸€èˆ¬è¡¨ç°ä¸ºå¼•å¯¼çº¿ä¹‹ç±»ï¼Œä¸ä¼šåœ¨é¡µé¢ä¸Šç»˜åˆ¶ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å ä½çš„æ–¹å¼ï¼Œæˆä¸ºä¸åŒå¸ƒå±€çš„çº¦æŸæ¡ä»¶ã€‚</p><h5 id="GuideLine"><a href="#GuideLine" class="headerlink" title="GuideLine"></a>GuideLine</h5><p>é¡¾åæ€ä¹‰ï¼ŒGuideLine å¯ä»¥åˆ›å»ºåŸºäºçˆ¶å¸ƒå±€ ConstraintLayout çš„æ°´å¹³æˆ–è€…å‚ç›´å‡†çº¿ï¼Œä»è€Œå¸®åŠ©å¼€å‘è€…è¿›è¡Œå¸ƒå±€å®šä½ã€‚</p><p>è¿™ä¸ªå¸ƒå±€æœ‰å››ä¸ªåŸºæœ¬å±æ€§ï¼Œä¾æ¬¡ä¸ºï¼š</p><pre><code class="xml">orientation å¦‚ä¸Šæ‰€è¿°ï¼Œç”¨æ¥è¡¨ç¤ºæ˜¯å‚ç›´æ–¹å‘è¿˜æ˜¯ç«–ç›´æ–¹å‘layout_constraintGuide_begin è·ç¦»çˆ¶äº²çš„èµ·å§‹ä½ç½®layout_constraintGuide_end è·ç¦»çˆ¶äº²çš„ç»“æŸä½ç½®layout_constraintGuide_percent è·ç¦»çˆ¶äº²çš„ä½ç½®ï¼Œç”¨ç™¾åˆ†æ¯”è¡¨ç¤ºç»è¿‡è¯•éªŒï¼Œpercent ä¼˜å…ˆçº§æœ€é«˜ï¼Œå…¶æ¬¡æ˜¯ beginï¼Œæœ€åæ˜¯ endï¼Œä¸€èˆ¬æ¥è®²ä½¿ç”¨ percent å°±è¶³å¤Ÿäº†</code></pre><p>xml ä»¥åŠå¯¹åº”çš„é¡µé¢æ•ˆæœå¦‚ä¸‹ï¼š</p><pre><code class="xml">&lt;android.support.constraint.ConstraintLayout                    android:layout_width=&quot;match_parent&quot;    android:layout_height=&quot;match_parent&quot;&gt;    &lt;!-- å‡è®¾è¯´ç°åœ¨éœ€è¦å°† ImageView æ‘†æ”¾åˆ°å³ä¸‹è§’çš„ä½ç½®ï¼Œå°±å¯ä»¥ä½¿ç”¨ GL è¾…åŠ©å®ç°--&gt;    &lt;android.support.constraint.Guideline        android:id=&quot;@+id/gl_vertical&quot;        android:layout_width=&quot;0dp&quot;        android:layout_height=&quot;wrap_content&quot;        android:orientation=&quot;vertical&quot;        app:layout_constraintGuide_percent=&quot;0.8&quot;/&gt;    &lt;android.support.constraint.Guideline        android:id=&quot;@+id/gl_horizontal&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;0dp&quot;        android:orientation=&quot;horizontal&quot;        app:layout_constraintGuide_percent=&quot;0.8&quot; /&gt;    &lt;ImageView        android:src=&quot;@mipmap/ic_launcher&quot;        app:layout_constraintLeft_toRightOf=&quot;@id/gl_vertical&quot;        app:layout_constraintTop_toBottomOf=&quot;@id/gl_horizontal&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot; /&gt;&lt;/android.support.constraint.ConstraintLayout&gt;</code></pre><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190322174954.jpg" alt=""></p><h5 id="Barrier"><a href="#Barrier" class="headerlink" title="Barrier"></a>Barrier</h5><p>ä¸ GuideLine å·®ä¸å¤šï¼Œä½†æ˜¯æ¯”å®ƒæ›´çµæ´»ï¼Œå¯ä»¥ç”¨æ¥çº¦æŸå¤šä¸ªå¸ƒå±€ï¼Œä¸”è‡ªåŠ¨åŒ¹é…æœ€å¤§æœ€å°å€¼è¿›è¡Œçº¦æŸã€‚</p><p>Barrier æœ‰ä¸¤ä¸ªåŸºæœ¬å±æ€§ï¼š</p><ul><li><p>barrierDirection</p><blockquote><p> å–å€¼å¯ä¸º top, bottom, left, right, start, end</p></blockquote><p>ç”¨äºçº¦å®šæ …æ æ‹¦æˆªçš„ View æ–¹å‘ï¼Œå‡è®¾è¯´è¦æ‹¦æˆªçš„ View åœ¨å³ä¾§ï¼Œè¿™ä¸ªå±æ€§å°±åº”è¯¥ä¸º right æˆ–è€… end</p></li><li><p>constraint_referenced_ids</p><p>è¢«æ …æ ä¿æŠ¤ï¼Œå±è”½èµ·æ¥çš„ View é›†åˆï¼Œç›´æ¥è¾“å…¥ viewIdï¼Œç”¨é€—å·åˆ†éš”å³å¯ï¼›barrier ä¼šæ ¹æ®å®½åº¦æˆ–è€…é«˜åº¦æœ€å¤§çš„é‚£ä¸ª View æ¥è®¾ç½®æ …æ çš„è¾¹ç•Œ</p></li></ul><p>å¯èƒ½ä¼šæœ‰äº›æŠ½è±¡ï¼Œæˆ‘ä»¬åœ¨å¼€å‘æ—¶å¯èƒ½ä¼šé‡åˆ°ä¸€ç§æ¯”è¾ƒè›‹ç–¼çš„éœ€æ±‚ï¼š</p><blockquote><p>å§“åã€æ€§åˆ«ã€å‡ºç”Ÿæ—¥æœŸã€æ‰‹æœºå·ç­‰å­—æ®µä»ä¸Šåˆ°ä¸‹ä¸€å­—æ’å¼€ï¼Œä½†æ˜¯æ¯ä¸ªå­—æ®µå¯¹åº”çš„å€¼è¦ä¿è¯å½¼æ­¤å·¦ä¾§å¯¹é½</p></blockquote><p>è®²é“ç†ä»¥å‰è¿™ç§å¸ƒå±€æˆ‘ä¸€ç›´ä¸çŸ¥é“æ€ä¹ˆç”»ï¼Œä½†æ˜¯ç°åœ¨æœ‰äº† <code>barrier</code> ä»¥åè¿™é—®é¢˜å°±è¿åˆƒè€Œè§£äº†ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ barrier å°†å·¦ä¾§çš„é‚£äº›å­—æ®µä¸å³ä¾§çš„å€¼æ‹¦æˆªå¼€ï¼Œbarrier ä¼šè‡ªåŠ¨è¯†åˆ«æœ€å®½çš„é‚£ä¸ªå­—æ®µï¼Œå¹¶å°†ä¹‹ä½œä¸º barrier çš„å®½åº¦ï¼Œä¹‹åæ¯ä¸ªå€¼éƒ½ç”¨ barrier æ¥åˆ¶é€ çº¦æŸå°±å¯ä»¥äº†ã€‚</p><pre><code class="XML">&lt;android.support.constraint.ConstraintLayout     android:layout_width=&quot;match_parent&quot;    android:layout_height=&quot;match_parent&quot;    android:padding=&quot;10dp&quot;&gt;    &lt;TextView        android:id=&quot;@+id/tv_name&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        android:text=&quot;å§“å:&quot;/&gt;    &lt;TextView        android:id=&quot;@+id/tv_gender&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        app:layout_constraintTop_toBottomOf=&quot;@id/tv_name&quot;        android:text=&quot;æ€§åˆ«:&quot;/&gt;    &lt;TextView        android:id=&quot;@+id/tv_phone&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        app:layout_constraintTop_toBottomOf=&quot;@id/tv_gender&quot;        android:text=&quot;æ‰‹æœºå·:&quot;/&gt;    &lt;TextView        android:id=&quot;@+id/tv_birthday&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        app:layout_constraintTop_toBottomOf=&quot;@id/tv_phone&quot;        android:text=&quot;å‡ºç”Ÿæ—¥æœŸ:&quot;/&gt;    &lt;android.support.constraint.Barrier        android:id=&quot;@+id/barrier&quot;        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        app:barrierDirection=&quot;end&quot;        app:constraint_referenced_ids=&quot;tv_name,tv_phone,tv_gender,tv_birthday&quot;/&gt;    &lt;TextView        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        app:layout_constraintLeft_toRightOf=&quot;@id/barrier&quot;        android:text=&quot;æ˜“çƒŠåƒçº&quot;/&gt;    &lt;TextView        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        app:layout_constraintTop_toBottomOf=&quot;@id/tv_name&quot;        app:layout_constraintLeft_toRightOf=&quot;@id/barrier&quot;        android:text=&quot;ç”·&quot;/&gt;    &lt;TextView        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        app:layout_constraintLeft_toRightOf=&quot;@id/barrier&quot;        app:layout_constraintTop_toBottomOf=&quot;@id/tv_gender&quot;        android:text=&quot;13800138000&quot;/&gt;    &lt;TextView        android:layout_width=&quot;wrap_content&quot;        android:layout_height=&quot;wrap_content&quot;        app:layout_constraintLeft_toRightOf=&quot;@id/barrier&quot;        app:layout_constraintTop_toBottomOf=&quot;@id/tv_phone&quot;        android:text=&quot;2000å¹´1æœˆ1æ—¥&quot; /&gt;&lt;/android.support.constraint.ConstraintLayout&gt;</code></pre><p>æ˜¾ç¤ºæ•ˆæœå¦‚å›¾ï¼Œå¾ˆå®Œç¾æœ‰æ²¡æœ‰ï¼Ÿ</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190322182306.jpg" alt=""></p><h5 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h5><p>Group æ˜¯ä¸€ä¸ªç»„ï¼Œç”¨æ¥æ‰¹é‡æ§åˆ¶ View çš„æ˜¾ç¤ºä¸éšè—ï¼›ä½†æ˜¯æ³¨æ„è¿™ä¸æ˜¯ä¸ª ViewGroupï¼Œå®ƒåªæ˜¯ä¸€ä¸ªä¸æ‰§è¡Œç»˜åˆ¶çš„ Viewï¼Œå’Œ barrier ä¸€æ ·ï¼Œå®ƒæœ‰ä¸€ä¸ª constraint_referenced_ids çš„å±æ€§ï¼Œå¯ä»¥å°†éœ€è¦éšè—çš„ ViewId ä¸¢è¿›å»ï¼Œåœ¨éœ€è¦çš„æ—¶å€™å°†å…¶æ‰¹é‡éšè—å³å¯ã€‚</p><p>è¿˜é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œå‡è®¾ç°åœ¨è¦æŠŠæ€§åˆ«ä¸€æ éšè—æ‰ï¼š</p><pre><code class="xml">&lt;android.support.constraint.Group    app:constraint_referenced_ids=&quot;tv_gender,tv_sex_value&quot;    android:visibility=&quot;gone&quot;    android:layout_width=&quot;wrap_content&quot;    android:layout_height=&quot;wrap_content&quot; /&gt;</code></pre><p>é€šè¿‡å°†æ€§åˆ«çš„ key å’Œ value çš„ id éƒ½æ”¾è¿›å»ï¼Œå°†å…¶è®¾ç½®ä¸º goneï¼Œåˆ™å¯ä»¥å°†è¯¥ç»„å®ç°éšè—ï¼š</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190322183030.jpg" alt=""></p><p>ä½†æ˜¯ï¼Œä½¿ç”¨ Group æ§åˆ¶å¯è§æ€§æ˜¯æœ‰å‘çš„ï¼š</p><blockquote><ol><li><p>å’Œä»¥å‰ç”¨çš„ViewGroupæœ‰ä¸€ç‚¹ä¸åŒï¼Œä»¥å‰ç”¨ViewGroupçº¦æŸViewçš„æ—¶å€™ï¼Œå¤–å±‚ViewGroupè®¾ç½®æˆå¯è§ï¼Œé‡Œå±‚Viewè®¾ç½®æˆä¸å¯è§æ˜¯å¯ä»¥ç”Ÿæ•ˆçš„ï¼Œä½†æ˜¯ç”¨Groupå°±ä¸èƒ½ã€‚Groupçº¦æŸçš„å…ƒç´ çš„å¯è§æ€§å§‹ç»ˆä¸€è‡´ã€‚</p></li><li><p>è°ƒç”¨Groupçš„setVisibilityæ–¹æ³•ä¸ä¼šç«‹å³å¯¹å®ƒçº¦æŸå¯¹å­Viewç”Ÿæ•ˆï¼Œè€Œæ˜¯è¦ç­‰åˆ°Groupæ‰€åœ¨çš„ConstrainLayoutè°ƒç”¨preLayoutæ–¹æ³•æ—¶æ‰ä¼šç”Ÿæ•ˆã€‚preLayoutåªæœ‰åœ¨ç¬¬ä¸€æ¬¡layoutå’Œå¸ƒå±€å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šè°ƒç”¨ã€‚</p></li></ol></blockquote><h4 id="Optimizerä¼˜åŒ–"><a href="#Optimizerä¼˜åŒ–" class="headerlink" title="Optimizerä¼˜åŒ–"></a>Optimizerä¼˜åŒ–</h4><p>å¯ä»¥é€šè¿‡å°†æ ‡ç­¾appï¼šlayout_optimizationLevelå…ƒç´ æ·»åŠ åˆ° ConstraintLayout æ¥å†³å®šåº”ç”¨å“ªäº›ä¼˜åŒ–</p><pre><code class="xml">&lt;android.support.constraint.ConstraintLayout     android:layout_width=&quot;match_parent&quot;    android:layout_height=&quot;match_parent&quot;    app:layout_optimizationLevel=&quot;standard|dimensions|chains&quot;/&gt;</code></pre><ul><li>noneï¼š ä¸æ‰§è¡Œä¼˜åŒ–</li><li>standardï¼š é»˜è®¤ï¼Œä»…ä¼˜åŒ–ç›´æ¥å’Œéšœç¢çº¦æŸ</li><li>directï¼š ä¼˜åŒ–ç›´æ¥çº¦æŸ</li><li>barrierï¼š ä¼˜åŒ–éšœç¢çº¦æŸ</li><li>chainï¼šä¼˜åŒ–é“¾æ¡çº¦æŸ</li><li>dimensionsï¼šä¼˜åŒ–ç»´åº¦æµ‹é‡ï¼Œå‡å°‘åŒ¹é…çº¦æŸå…ƒç´ çš„åº¦é‡æ•°é‡</li></ul><h4 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h4><ul><li><a href="https://juejin.im/post/5c0bd6b05188257c3045dc50#heading-7" target="_blank" rel="noopener">ConstraintLayout å…¨è§£æ</a></li><li><a href="https://mp.weixin.qq.com/s/vI-fPaNoJ7ZBlZcMkEGdLQ" target="_blank" rel="noopener">æ‹’ç»æ‹–æ‹½ ä½¿ç”¨ConstraintLayoutä¼˜åŒ–ä½ çš„å¸ƒå±€å§</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸çŸ¥é“ä»ä»€ä¹ˆæ—¶å€™å¼€å§‹ï¼ŒAndroid æ­»ä¸¢ä¸¢å·²ç»é»˜è®¤ä½¿ç”¨çº¦æŸå¸ƒå±€ ConstraintLayout ä½œä¸ºé»˜è®¤å¸ƒå±€äº†ï¼Œä½†æ˜¯æ‡’ç™Œå‘ä½œä¸€ç›´ä¸æƒ³å­¦ä¹ ï¼Œæ¯æ¬¡éƒ½æ¢æˆ LinearLayoutï¼Œè¿™æ¬¡ä¹Ÿå¿˜è®°äº†ä¸ºå•¥å¼€å§‹å­¦ä¹ è¿™ä¸ªä¸œè¥¿ï¼Œå­¦å®Œå‘ç°è¿˜æŒºçˆ½â€¦â€¦å†™ä¸ªç¬”è®°è®°å½•ä¸€ä¸‹ï¼Œå“ˆå“ˆ&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://joeljt.top/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>çº¿ç¨‹é—´é€šä¿¡ ä¸‹ç¯‡</title>
    <link href="http://joeljt.top/2018/09/09/Efficient-Android-Threading-chapter-4-2/"/>
    <id>http://joeljt.top/2018/09/09/Efficient-Android-Threading-chapter-4-2/</id>
    <published>2018-09-08T16:00:00.000Z</published>
    <updated>2019-03-21T10:47:37.178Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Efficient.Android.Threading ç¬¬å››ç« è¯»ä¹¦ç¬”è®° ä¸‹ç¯‡</p></blockquote><a id="more"></a><h3 id="Android-æ¶ˆæ¯æœºåˆ¶"><a href="#Android-æ¶ˆæ¯æœºåˆ¶" class="headerlink" title="Android æ¶ˆæ¯æœºåˆ¶"></a>Android æ¶ˆæ¯æœºåˆ¶</h3><p>è¿„ä»Šä¸ºæ­¢ï¼Œæˆ‘ä»¬ä»‹ç»çš„çº¿ç¨‹é€šä¿¡éƒ½æ˜¯ Java å±‚é¢çš„ï¼Œç®¡é“ã€å…±äº«å†…å­˜ã€é˜»å¡é˜Ÿåˆ—ç­‰ç­‰ï¼Œéƒ½æ˜¯æ‰€æœ‰ Java åº”ç”¨éƒ½æœ‰çš„æœºåˆ¶ã€‚ç„¶è€Œï¼Œå› ä¸ºé˜»å¡çº¿ç¨‹ç‰¹æ€§çš„å­˜åœ¨ï¼Œè¿™äº›æœºåˆ¶å¯¹äº Android ç³»ç»Ÿéƒ½ä¸é€‚ç”¨ï¼Œå› ä¸º UI çº¿ç¨‹ç»ä¸å…è®¸é˜»å¡ã€‚</p><p>å› æ­¤ï¼ŒAndroid ç³»ç»Ÿä¸ºäº†ååŒ UI çº¿ç¨‹å’Œå·¥ä½œçº¿ç¨‹ï¼Œå®šä¹‰äº†ä¸€å¥—ç³»ç»Ÿçº§åˆ«çš„æ¶ˆæ¯æœºåˆ¶ã€‚Android æ¶ˆæ¯æœºåˆ¶æ˜¯ä¸€ä¸ªæ²¡æœ‰é˜»å¡çŠ¶æ€çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼ŒUI çº¿ç¨‹å¯ä»¥å°†è€—æ—¶æ“ä½œè½¬ç§»ç»™å·¥ä½œçº¿ç¨‹åœ¨åå°å¤„ç†ï¼ŒåŒæ—¶ç”Ÿäº§è€…çº¿ç¨‹ä¸æ¶ˆè´¹è€…çº¿ç¨‹éƒ½ä¸ä¼šå‘ç”Ÿé˜»å¡ã€‚</p><p>Android å¹³å°çš„æ¶ˆæ¯æœºåˆ¶ç›¸å…³çš„ API ä»å±äº <code>android.os</code> åŒ…ï¼š</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190321182551.jpg" alt="Android Message API"></p><p><code>android.os.Looper</code></p><p>å”¯ä¸€å…³è”æŸä¸ªæ¶ˆè´¹è€…çº¿ç¨‹çš„æ¶ˆæ¯è°ƒåº¦å™¨</p><p><code>android.os.Handler</code></p><p>æ¶ˆè´¹è€…çº¿ç¨‹çš„æ¶ˆæ¯å¤„ç†å™¨ï¼ŒåŒæ—¶ç”Ÿäº§è€…çº¿ç¨‹ä¹Ÿä½¿ç”¨è¯¥å¯¹è±¡å°†æ¶ˆæ¯æ’å…¥é˜Ÿåˆ—ã€‚ä¸€ä¸ª Looper å¯¹è±¡å¯ä»¥ç»‘å®šå¤šä¸ª Handler å¯¹è±¡ï¼Œä½†æ˜¯æ‰€æœ‰çš„æ¶ˆæ¯éƒ½æ˜¯æ’å…¥åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„ã€‚</p><p><code>android.os.MessageQueue</code></p><p>æ¶ˆè´¹è€…çº¿ç¨‹ä¸­å¾…å¤„ç†æ¶ˆæ¯çš„é“¾è¡¨ï¼Œä½†æ˜¯ä¸åŒçš„æ¶ˆæ¯ä¹‹é—´å¹¶æ²¡æœ‰ç»‘å®šå…³ç³»ã€‚æ¯ä¸ª Looper å¯¹è±¡æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼›ç”±äºæ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ª Looper å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªçº¿ç¨‹æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><p>åå« MessageQueue, å®é™…ä¸Šæ˜¯ä¸€ä¸ª LinkedList</p><p><code>android.os.Message</code></p><p>æ¶ˆè´¹è€…çº¿ç¨‹ä¸­å¾…æ‰§è¡Œçš„æ¶ˆæ¯</p><p>æ¶ˆæ¯æœºåˆ¶çš„å·¥ä½œåŸç†å¤§æŠµå¦‚ä¸‹å›¾ç¤ºæ„ï¼š</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190321182556.jpg" alt="æ¶ˆæ¯æœºåˆ¶ç¤ºæ„"></p><p>ç”Ÿäº§è€…çº¿ç¨‹å‘é€æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹å¤„ç†æ¶ˆæ¯ï¼š</p><ol><li>æ’å…¥ï¼šç”Ÿäº§è€…çº¿ç¨‹ä½¿ç”¨ä¸æ¶ˆè´¹è€…çº¿ç¨‹ç›¸ç»‘å®šçš„ Handler å¯¹è±¡ï¼Œå°†æ¶ˆæ¯æ’å…¥æ¶ˆæ¯é˜Ÿåˆ—</li><li>å–å‡ºï¼šLooper è¿è¡Œåœ¨æ¶ˆè´¹è€…çº¿ç¨‹ä¸­ï¼ŒæŒ‰ä¸€å®šçš„é¡ºåºå–å‡ºæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</li><li>åˆ†å‘ï¼šHandler è´Ÿè´£åœ¨æ¶ˆè´¹è€…çº¿ç¨‹ä¸­å¤„ç†æ¶ˆæ¯ï¼›æŸä¸ªçº¿ç¨‹å¯ä»¥æœ‰å¤šä¸ª Handler å¯¹è±¡ï¼ŒLooper å¯ä»¥ç¡®ä¿æ¯æ¡æ¶ˆæ¯èƒ½å¤Ÿæ­£ç¡®åˆ†å‘ç»™å¯¹åº”çš„ Handler ã€‚</li></ol><h4 id="æ¶ˆæ¯ä¼ é€’åŸºæœ¬ç¤ºä¾‹"><a href="#æ¶ˆæ¯ä¼ é€’åŸºæœ¬ç¤ºä¾‹" class="headerlink" title="æ¶ˆæ¯ä¼ é€’åŸºæœ¬ç¤ºä¾‹"></a>æ¶ˆæ¯ä¼ é€’åŸºæœ¬ç¤ºä¾‹</h4><pre><code class="java">public class LooperActivity extends Activity {    LooperThread mLooperThread;    // 1.å£°æ˜ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œæ‰®æ¼”æ¶ˆè´¹è€…çº¿ç¨‹è§’è‰²    private static class LooperThread extends Thread {        public Handler mHandler;        public void run() {            // 2.ä¸ºå½“å‰çº¿ç¨‹å…³è” Looperï¼Œä¹Ÿå°±æ˜¯å…³è”äº† MessageQueue            Looper.prepare();            // 3.ä½¿ç”¨é»˜è®¤æ„é€ å™¨ï¼Œå³å°† Handler ä¸å½“å‰çº¿ç¨‹çš„ Looper ç»‘å®š            // ä¹Ÿå°±å†³å®šäº†å®ƒåªèƒ½åœ¨ Looper.prepare() ååˆå§‹åŒ–ï¼Œå¦åˆ™æ²¡æœ‰å¯ä»¥ç»‘å®šçš„ Looper            mHandler = new Handler() {                // 4. å·¥ä½œçº¿ç¨‹ä¸­å¤„ç†åˆ†å‘ä¸‹æ¥çš„æ¶ˆæ¯çš„å›è°ƒ                public void handleMessage(Message msg) {                    if(msg.what == 0) {                        doLongRunningOperation();                    }                }            };            // 5. å¼€å¯å¯¹æ¶ˆæ¯é˜Ÿåˆ—çš„è½®è¯¢ï¼Œå¯¹æ¶ˆæ¯è¿›è¡Œåˆ†å‘ï¼›            // è¿™æ˜¯ä¸ª blocking callï¼Œå› æ­¤æ­¤å·¥ä½œçº¿ç¨‹ä¸ä¼šç»“æŸ            Looper.loop();        }        private void doLongRunningOperation() {            // Add long running operation here.        }    }    public void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.activity_looper);        // 6. å¼€å¯å·¥ä½œçº¿ç¨‹ï¼Œå‡†å¤‡å¤„ç†æ¶ˆæ¯        mLooperThread = new LooperThread();        mLooperThread.start();    }    public void onClick(View v) {        // 7. Handler åˆå§‹åŒ–å®Œæˆå’Œç‚¹å‡»äº‹ä»¶æ˜¯å¼‚æ­¥çš„ï¼Œå› æ¬¡æ ¡éªŒä¸€ä¸‹ Handler ä¸ä¸ºç©º        if (mLooperThread.mHandler != null) {            // 8. åˆå§‹åŒ–ä¸€ä¸ª Message å¯¹è±¡ï¼Œwhat å±æ€§èµ‹å€¼ä¸º 0            Message msg = mLooperThread.mHandler.obtainMessage(0);            // 9. å‘æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ’å…¥æ¶ˆæ¯            mLooperThread.mHandler.sendMessage(msg);        }    }    protected void onDestroy() {        super.onDestroy();        // 10. ç»“æŸ loop() æ–¹æ³•çš„é˜»å¡çŠ¶æ€ï¼Œä»è€Œç»“æŸåå°çº¿ç¨‹çš„æ‰§è¡Œ        mLooperThread.mHandler.getLooper().quit();    }}</code></pre><h4 id="æ¶ˆæ¯ä¼ é€’è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„-Classes"><a href="#æ¶ˆæ¯ä¼ é€’è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„-Classes" class="headerlink" title="æ¶ˆæ¯ä¼ é€’è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„ Classes"></a>æ¶ˆæ¯ä¼ é€’è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„ Classes</h4><h5 id="MessageQueue"><a href="#MessageQueue" class="headerlink" title="MessageQueue"></a>MessageQueue</h5><p>æ¶ˆæ¯é˜Ÿåˆ—ä¸»è¦ç”± <code>android.os.MessageQueue</code> ç±»æ¥å®ç°ï¼Œå…¶å†…éƒ¨å®ç°ä¸€ä¸ªæ²¡æœ‰ç»‘å®šå…³ç³»çš„å•å‘é“¾è¡¨ï¼Œç”¨äºå­˜å‚¨ä¸€ç³»åˆ—å¾…å¤„ç†çš„æ¶ˆæ¯ã€‚ç”Ÿäº§è€…çº¿ç¨‹æ’å…¥æ¶ˆæ¯ï¼Œä¹‹åæ¶ˆæ¯ä¼šåˆ†å‘åˆ°å¯¹åº”çš„æ¶ˆè´¹è€…çº¿ç¨‹å»å¤„ç†ã€‚ä¸€èˆ¬æ¥è®²ï¼Œä¸åŒçš„æ¶ˆæ¯æ˜¯æŒ‰ç…§æ—¶é—´æˆ³æ¥æ’åºçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ—¶é—´æˆ³å€¼è¶Šå°ï¼Œåœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ’åºé¡ºåºå°±è¶Šé å‰ã€‚ä½†æ˜¯åªæœ‰åˆ°è¾¾å½“å‰æ—¶é—´çš„æ¶ˆæ¯æ‰ä¼šè¢«åˆ†å‘ï¼›å¦‚æœè¿˜æ²¡æœ‰åˆ°å½“å‰æ—¶é—´ï¼Œåˆ™ä¼šç­‰åˆ°å½“å‰æ—¶é—´æ‰ä¼šå¯¹æ¶ˆæ¯è¿›è¡Œåˆ†å‘ã€‚</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190321182557.jpg" alt="æ¶ˆæ¯åˆ†å‘çš„æ—¶é—´ç‚¹"></p><p>ä¸Šå›¾å±•ç¤ºäº†æ¶ˆæ¯é˜Ÿåˆ—ä¸­æŒ‰æ—¶é—´æ’åºçš„æ¶ˆæ¯æ˜¯å¦‚ä½•å‘ä¸‹åˆ†å‘çš„ï¼Œå…¶ä¸­ t1 &lt; t2 &lt; t3ï¼Œå³ t1 çš„æ—¶é—´è¦æ—©äº t3ã€‚ç°åœ¨åªæœ‰ä¸€æ¡æ¶ˆæ¯è¶Šè¿‡äº† <code>disptch barrier</code> , å®é™…ä¸Šä¹Ÿå°±æ˜¯å½“å‰æ—¶é—´ç‚¹ã€‚å¯ä»¥è¢«åˆ†å‘ä¸‹å»çš„æ¶ˆæ¯æ‰€ç»‘å®šçš„æ—¶é—´æˆ³ï¼Œä¸€å®šæ¯”å½“å‰æ—¶é—´å°ï¼Œä¹Ÿå°±æ˜¯å·²ç»åˆ°äº†åˆ†å‘çš„æ—¶é—´ã€‚</p><p>å¦‚æœå½“å‰ Looper è·å–æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰æ¶ˆæ¯ç©¿è¶Šè¿‡ <code>dispatch barrier</code> ï¼Œæ­¤æ—¶æ¶ˆè´¹è€…çº¿ç¨‹å°±ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯è¶Šè¿‡ <code>dispatch barrier</code> ã€‚è€Œç”Ÿäº§è€…çº¿ç¨‹å¯ä»¥åœ¨ä»»ä½•æ—¶é—´ã€ä»»æ„ä½ç½®æ’å…¥æ¶ˆæ¯ï¼Œå› ä¸ºæ¶ˆæ¯åˆ—è¡¨çš„æ’åˆ—åªå’Œæ¶ˆæ¯å‘é€çš„æ—¶é—´æœ‰å…³ç³»ï¼Œå¦‚æœéœ€è¦æ’å…¥ä¸€æ¡ç«‹å³å‘é€çš„æ¶ˆæ¯ï¼Œåˆ™å³ä½¿æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰ä¸€ç™¾æ¡å¾…å‘é€çš„æ¶ˆæ¯ï¼Œä½†å®ƒä»¬éƒ½æ˜¯ä¸€åˆ†é’Ÿåæ‰å‘é€ï¼Œé‚£åˆšæ’å…¥çš„è¿™æ¡æ¶ˆæ¯ä¹Ÿä¼šåœ¨é“¾è¡¨çš„é¦–ä½ï¼Œä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ªè¢«åˆ†å‘çš„æ¶ˆæ¯ã€‚</p><h5 id="MessageQueue-IdleHandler"><a href="#MessageQueue-IdleHandler" class="headerlink" title="MessageQueue.IdleHandler"></a>MessageQueue.IdleHandler</h5><p>æ­£å¸¸æ¥è®²ï¼Œå¦‚æœ Looper è·å–ä¸åˆ°åº”åˆ†å‘çš„æ¶ˆæ¯æ—¶ï¼Œçº¿ç¨‹å°±ä¼šé˜»å¡ç­‰å¾…ï¼›ä½†æ˜¯é™¤äº†å¹²ç­‰ä»¥å¤–ï¼Œè¿˜å¯ä»¥å°†è¿™æ®µæ—¶é—´åˆ©ç”¨èµ·æ¥ï¼Œç”¨æ¥æ‰§è¡Œä¸€äº›å…¶ä»–çš„ä»»åŠ¡ã€‚è€Œè¿™ä¸ªä»»åŠ¡åˆ™ç”± <code>android.os.MessageQueue.IdleHandler</code> æ¥å®Œæˆã€‚</p><pre><code class="java">/** * å½“çº¿ç¨‹ç­‰å¾…æ–°æ¶ˆæ¯ï¼Œå³å°†è¿›å…¥é˜»å¡ï¼ˆé—²ç½®ï¼‰çŠ¶æ€æ—¶çš„å›è°ƒæ¥å£ */public static interface IdleHandler {      boolean queueIdle();}// å…·ä½“ä½¿ç”¨ï¼š// è·å–å½“å‰çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—MessageQueue myQueue = Looper.myQueue();// å£°æ˜ä¸€ä¸ª IdleHandler å¯¹è±¡MessageQueue.IdleHandler idleHandler = new MessageQueue.IdleHandler() {    @Override    public boolean queueIdle() {        return false;    }};// ä¸æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œç»‘å®šmyQueue.addIdleHandler(idleHandler);// ä¸æ¶ˆæ¯é˜Ÿåˆ—è§£é™¤ç»‘å®šmyQueue.removeIdleHandler(idleHandler);</code></pre><p>å½“æ¶ˆæ¯é˜Ÿåˆ—æ£€æµ‹åˆ°åˆ†å‘æ¶ˆæ¯çš„ç©ºé—²æ—¶é—´æ—¶ï¼Œå®ƒä¼šå”¤é†’æ‰€æœ‰æ³¨å†Œåˆ°å½“å‰æ¶ˆæ¯é˜Ÿåˆ—çš„ IdleHandler å®ä¾‹ï¼Œå¹¶è°ƒç”¨ä»–ä»¬çš„ <code>queueIdle</code> æ–¹æ³•ï¼Œè€Œå…·ä½“çš„å›è°ƒç”±åº”ç”¨è‡ªèº«æ¥è¿›è¡Œå®ç°ã€‚</p><p> <code>queueIdle</code> æ–¹æ³•è¿”å›å€¼ä¸ºå¸ƒå°”ç±»å‹ï¼š</p><ul><li><p>true</p><p>å½“å‰ IdleHandler å®ä¾‹ä¿æŒå­˜æ´»ï¼Œä¸‹æ¬¡å†æœ‰ time slots æ—¶ï¼ŒMessageQueue è¿˜ä¼šå”¤é†’è¯¥å®ä¾‹</p></li><li><p>false</p><p>å½“å‰ IdleHandler å®ä¾‹ä¸å†å­˜æ´»ï¼Œå¤„ç†å®Œæ¶ˆæ¯åå°±ä¼šä¸»åŠ¨è°ƒç”¨ MessageQueue.removeIdleHandler() å°†è¯¥å®ä¾‹ä¸ MessageQueue è§£ç»‘</p></li></ul><h5 id="ä½¿ç”¨-IdleHandler-æ¥ç»ˆæ­¢é—²ç½®çº¿ç¨‹çš„è¿è¡Œ"><a href="#ä½¿ç”¨-IdleHandler-æ¥ç»ˆæ­¢é—²ç½®çº¿ç¨‹çš„è¿è¡Œ" class="headerlink" title="ä½¿ç”¨ IdleHandler æ¥ç»ˆæ­¢é—²ç½®çº¿ç¨‹çš„è¿è¡Œ"></a>ä½¿ç”¨ IdleHandler æ¥ç»ˆæ­¢é—²ç½®çº¿ç¨‹çš„è¿è¡Œ</h5><p>å‡å®šç°åœ¨æœ‰å¤šä¸ªç”Ÿäº§è€…çº¿ç¨‹è¦è¿ç»­ä¸æ–­çš„å‘æ¶ˆè´¹è€…çº¿ç¨‹å‘é€æ¶ˆæ¯ï¼Œé‚£å°±å¯ä»¥åœ¨æ¶ˆè´¹è€…çº¿ç¨‹å°†æ‰€æœ‰ä»»åŠ¡çš„å¤„ç†å®Œä»¥å¶èƒ¡ï¼Œä½¿ç”¨ IdleHandler æ¥ç»ˆæ­¢çº¿ç¨‹çš„æ‰§è¡Œï¼Œä»è€Œä¿è¯è¯¥çº¿ç¨‹å¯¹è±¡ä¸ä¼šåœ¨å†…å­˜ä¸­æ¸¸è¡ã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨ IdleHandler ï¼Œå°±ä¸ç”¨è¿½è¸ªæœ€åä¸€æ¡æ’å…¥é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼Œä»¥æœŸå¾—åˆ°å›æ”¶è¯¥çº¿ç¨‹çš„ç¡®åˆ‡æ—¶é—´ã€‚</p><p>ä¸è¿‡è¿™ç§åœºæ™¯åªé€‚ç”¨äºç”Ÿäº§è€…çº¿ç¨‹è¿ç»­ä¸æ–­åœ°å‘æ¶ˆè´¹è€…çº¿ç¨‹æ’å…¥æ¶ˆæ¯ï¼Œä»è€Œä¿è¯åœ¨å¤„ç†å®Œæ‰€æœ‰æ¶ˆæ¯ä¹‹å‰ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹éƒ½æ²¡æœ‰ time slots.</p><pre><code class="java">public class ConsumeAndQuitThreadActivity extends Activity {    public void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        final ConsumeAndQuitThread consumeAndQuitThread = new ConsumeAndQuitThread();        consumeAndQuitThread.start();        for (int i = 0; i &lt; 10; i++) {            // ç”±å¤šä¸ªçº¿ç¨‹å¹¶å‘å‘æ¶ˆè´¹è€…çº¿ç¨‹å‘é€æ¶ˆæ¯ï¼Œéšæœºæ¨¡æ‹Ÿå‘é€çš„æ—¶é—´            new Thread(new Runnable() {                @Override                public void run() {                    for (int i = 0; i &lt; 10; i++) {                        SystemClock.sleep(new Random().nextInt(10));                        consumeAndQuitThread.enqueueData(i);                    }                }            }).start();        }    }    /**     * æ­¤çº¿ç¨‹ä¸ºç»‘å®šäº† Looper å¯¹è±¡çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œæ¥æ”¶ç”Ÿäº§è€…çº¿ç¨‹çš„æ¶ˆæ¯å¹¶è¿›è¡Œå¤„ç†ï¼›     * å¤„ç†å®Œæ¶ˆæ¯åï¼Œä¼šç»ˆæ­¢ Looper.loop() æ–¹æ³•ï¼Œç»“æŸçº¿ç¨‹çš„æ‰§è¡Œ     */    private static class ConsumeAndQuitThread extends Thread implements MessageQueue.IdleHandler {        private static final String THREAD_NAME = &quot;ConsumeAndQuitThread&quot;;        public Handler mConsumerHandler;        private boolean mIsFirstIdle = true;        public ConsumeAndQuitThread() {            super(THREAD_NAME);        }        @Override        public void run() {            Looper.prepare();            mConsumerHandler = new Handler() {                @Override                public void handleMessage(Message msg) {                    // Consume data                }            };            // 1. ä¸ºå½“å‰çº¿ç¨‹åˆå§‹åŒ– Looperï¼Œå¹¶ä¸ºè¯¥çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ç»‘å®š IdleHandler å¯¹è±¡            Looper.myQueue().addIdleHandler(this);            Looper.loop();        }        @Override        public boolean queueIdle() {            // 2. ç¬¬ä¸€æ¬¡ queueIdle() çš„è°ƒç”¨ä¼šå‘ç”Ÿåœ¨æ¥æ”¶æ¶ˆæ¯ä¹‹å‰            // å› æ­¤éœ€è¦è®©é¦–æ¬¡è°ƒç”¨è¿”å› trueï¼Œä»è€Œä¿è¯æ­¤å¯¹è±¡ä»ç„¶ä¸æ¶ˆæ¯é˜Ÿåˆ—ç»‘å®š            if (mIsFirstIdle) {                 mIsFirstIdle = false;                return true;            }            // 3. ç»“æŸæ¶ˆè´¹è€…çº¿ç¨‹çš„æ‰§è¡Œ            mConsumerHandler.getLooper().quit();            return false;        }        public void enqueueData(int i) {            mConsumerHandler.sendEmptyMessage(i);        }    }}</code></pre><h5 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h5><p>Message æ˜¯ä¸€ä¸ªå®¹å™¨ç±»ï¼Œå¯ä»¥æ‰¿è½½å„ç§ç±»å‹çš„æ•°æ®æˆ–è€…ä¸€ä¸ª Runnable å¯¹è±¡ï¼Œä½†æ˜¯ä¸èƒ½åŒæ—¶æºå¸¦äºŒè€…ã€‚æ‰€æºå¸¦çš„æ•°æ®ä¼šåœ¨æ¶ˆè´¹è€…çº¿ç¨‹è¢«å¤„ç†ï¼Œä½†ä»»åŠ¡åˆ™ä¼šåœ¨æ¶ˆæ¯åˆ†å‘æ—¶ç›´æ¥å¾—åˆ°æ‰§è¡Œï¼Œè€Œä¸éœ€è¦è°ƒç”¨è€…åšå…¶ä»–é¢å¤–çš„å·¥ä½œã€‚</p><p>æ­£å¸¸æ¥è®²ï¼ŒMessage çš„æ’å…¥ç”± Handler æ¥å®Œæˆï¼Œå› ä¸ºå®ƒåœ¨æ’å…¥æ¶ˆæ¯æ—¶æœ‰æ›´å¤šçš„é€‰æ‹©ï¼Œæ›´åŠ çµæ´»ï¼›ä½†æ˜¯å®é™…ä¸Šæ¯æ¡æ¶ˆæ¯å¯¹è±¡éƒ½çŸ¥é“è‡ªå·±å¯¹åº”çš„å¤„ç†å™¨æ˜¯è°ï¼Œä¹Ÿå°±æ˜¯çŸ¥é“è‡ªå·±å¯¹åº”çš„ Handler å¯¹è±¡ï¼Œæ‰€ä»¥ä¸€æ¡æ¶ˆæ¯å¯ä»¥è‡ªå·±å®ç°å…¥é˜Ÿæ“ä½œã€‚</p><pre><code class="java">// é€šè¿‡ obtain() ä¼ é€’ä¸€ä¸ª Handler å¯¹è±¡è¿›å»ï¼Œèµ‹å€¼ç»™ Message.target å±æ€§Message m = Message.obtain(handler, runnbale);m.sendToTarget();public void sendToTarget() {    // target æ˜¯ Handler å¯¹è±¡ï¼Œæ­¤æ–¹æ³•ä¼šè°ƒç”¨ Handler çš„ sendMessage æ–¹æ³•    target.sendMessage(this);}</code></pre><p>å¦‚ä¹‹å‰æ‰€è¯´ï¼ŒMessage å¯ä»¥æºå¸¦æ•°æ®æˆ–è€…ä»»åŠ¡ï¼Œå…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190321182601.jpg" alt=""></p><p>æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥åŒ…å«ä»»ä½•æ•°æ®å’Œä»»åŠ¡æ¶ˆæ¯çš„ç»„åˆï¼Œæ¶ˆè´¹è€…çº¿ç¨‹å…·ä½“åœ¨å¤„ç†æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¹Ÿä»…ä»…æ˜¯æŒ‰ç…§æ¶ˆæ¯çš„æ’åºé¡ºåºï¼Œè€Œä¸å’Œæ¶ˆæ¯çš„ç±»å‹æœ‰ä»»ä½•å…³ç³»ã€‚å¦‚æœæ¶ˆæ¯æºå¸¦çš„æ˜¯æ•°æ®ï¼Œé‚£æ¶ˆè´¹è€…çº¿ç¨‹å°±ä¼šåœ¨ handleMessage ä¸­å¤„ç†æ•°æ®ï¼›å¦‚æœæ¶ˆæ¯æºå¸¦çš„æ˜¯ä»»åŠ¡ï¼Œåˆ™è¯¥ Runnable çš„ run æ–¹æ³•åˆ™ä¼šåœ¨æ¶ˆè´¹è€…çº¿ç¨‹å¾—åˆ°æ‰§è¡Œï¼Œä½†æ˜¯ä¸ä¼šå†è§¦å‘ handleMessage æ–¹æ³•çš„å›è°ƒã€‚</p><p>Message çš„ç”Ÿå‘½å‘¨æœŸå¤§æ¦‚å¯ä»¥åˆ†ä¸ºå››ä¸ªæ–¹é¢ï¼šåˆå§‹åŒ–ï¼Œç­‰å¾…ï¼Œåˆ†å‘ï¼Œå›æ”¶ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç³»ç»Ÿå¹¶æ²¡æœ‰å¯¹æ¶ˆæ¯çš„çŠ¶æ€è¿›è¡Œç›‘å¬ï¼Œå°½ç®¡è¿™åœ¨æŠ€æœ¯ä¸Šä¹Ÿæ˜¯å¯è¡Œçš„ï¼Œæ‰€ä»¥åº”ç”¨åœ¨å¤„ç†æ¶ˆæ¯ä¸è¯¥å¯¹è¯¥æ¶ˆæ¯çš„å½“å‰çŠ¶æ€åšå‡ºä»»ä½•å‡è®¾ã€‚</p><ul><li><p>Initialized</p><p>åœ¨åˆå§‹åŒ–çŠ¶æ€ä¸‹ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ¥åˆ›å»º Message å¯¹è±¡ï¼š</p><ul><li><p>ä½¿ç”¨æ„é€ å™¨åˆå§‹åŒ–</p><pre><code class="java">Message m = new Message();</code></pre></li><li><p>å·¥å‚æ–¹æ³•</p><ul><li><p>ç©ºæ¶ˆæ¯</p><pre><code class="java">Message m = Message.obtain();</code></pre></li><li><p>æ•°æ®æ¶ˆæ¯</p><pre><code class="java">Message m = Message.obtain(Handler h);Message m = Message.obtain(Handler h, int what);Message m = Message.obtain(Handler h, int what, Object o);Message m = Message.obtain(Handler h, int what, int arg1, int arg2); Message m = Message.obtain(Handler h, int what, int arg1, int arg2, Object o);</code></pre></li><li><p>ä»»åŠ¡æ¶ˆæ¯</p><pre><code class="java">Message m = Message.obtain(Handler h, Runnable task);</code></pre></li><li><p>å¤åˆ¶æ„é€ å™¨</p><pre><code class="java">Message m = Message.obtain(Message originalMsg);</code></pre></li></ul></li></ul></li><li><p>Pending</p><p>æ¶ˆæ¯å·²ç»è¢«æ’å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œä½†è¿˜æ²¡åˆ°å‘é€æ—¶é—´ï¼Œæ­£åœ¨ç­‰å¾…åˆ†å‘</p></li><li><p>Disptached</p><p>åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒLooper å·²ç»ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºäº†æ¶ˆæ¯ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿå°†å…¶ç§»é™¤ã€‚Looper åœ¨ loop æ–¹æ³•ä¸­ï¼Œä¼šé€šè¿‡è®¿é—® Message.target å±æ€§ï¼Œæ¥è·å–åˆ°è¯¥æ¶ˆæ¯å¯¹åº”çš„ Handler ï¼Œç„¶åå°†æ¶ˆæ¯å‘é€åˆ°å¯¹åº”çš„å›è°ƒä¸­è¿›è¡Œå¤„ç†ã€‚</p></li><li><p>Recycled</p><p>åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒMessage çš„çŠ¶æ€è¢«æ¸…é™¤ï¼Œè¯¥å®ä¾‹ä¹Ÿå›åˆ°äº†æ¶ˆæ¯æ± ä¸­ç­‰å¾…å¤ç”¨ã€‚åœ¨æ¶ˆè´¹è€…çº¿ç¨‹å®Œæˆæ•°æ®å¤„ç†åï¼ŒLooper è´Ÿè´£ Message çš„å›æ”¶å·¥ä½œã€‚è¿™ä¸ªå›æ”¶è¿‡ç¨‹ç”±è™šæ‹Ÿæœºæ¥å®Œæˆï¼Œè€Œä¸åº”è¯¥ç”±åº”ç”¨ç¨‹åºæ¥ä¸»åŠ¨å¤„ç†ã€‚</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€æ—¦æ¶ˆæ¯å…¥é˜Ÿåï¼Œå…¶æºå¸¦çš„æ•°æ®å°±ä¸åº”è¯¥å†è¢«æ›´æ”¹ã€‚ç†è®ºä¸Šæ¥è®²ï¼Œåœ¨æ¶ˆæ¯è¢«åˆ†å‘ä¹‹å‰ï¼Œå¯¹æ•°æ®åšå‡ºçš„æ›´æ”¹éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚ä½†ç”±äº Handler æœºåˆ¶åœ¨è®¾è®¡ä¹‹åˆå°±æ²¡æœ‰å¯¹ Message çš„å¤„ç†çŠ¶æ€è¿›è¡Œç›‘å¬ï¼Œå› æ­¤è°ƒç”¨è€…æ­£åœ¨å¯¹æ•°æ®è¿›è¡Œæ›´æ”¹æ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹æ­£åœ¨å¤„ç†æ•°æ®ï¼Œä»è€Œå¯¼è‡´çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ã€‚è€Œå¦‚æœè¯¥æ¶ˆæ¯å¯¹è±¡å·²ç»è¢«å›æ”¶äº†ï¼Œé—®é¢˜åˆ™ä¼šæ›´åŠ ä¸¥é‡ï¼Œå› ä¸ºè¯¥å¯¹è±¡å›åˆ°æ¶ˆæ¯æ± åï¼Œä¼šåœ¨ä¹‹åè¢«åº”ç”¨ç¨‹åºæ‰€å¤ç”¨ï¼Œæœ‰å¯èƒ½ä¼šæºå¸¦ä¹‹å‰çš„æ•°æ®åˆ°æ–°çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚</p></blockquote></li></ul><h5 id="Looper"><a href="#Looper" class="headerlink" title="Looper"></a>Looper</h5><p><code>android.os.Looper</code> å¤æ‚å°†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åˆ†å‘ç»™å¯¹åº”çš„ Handler å»å¤„ç†ã€‚æ‰€æœ‰è¶Šè¿‡åˆ†å‘æ …æ çš„æ¶ˆæ¯éƒ½å¯ä»¥è¢« Looper æ‰€åˆ†å‘ã€‚æ‰€æœ‰å¾…åˆ†å‘çš„æ¶ˆæ¯ä¸€å®šæ˜¯è¶Šè¿‡åˆ†å‘æ …æ çš„ï¼Œå½“æ²¡æœ‰æ¶ˆæ¯å¾…åˆ†å‘æ—¶ï¼Œæ¶ˆè´¹çº¿ç¨‹åˆ™ä¼šé˜»å¡ï¼Œç›´è‡³æœ‰æ¶ˆæ¯ç­‰å¾…å¤„ç†ã€‚</p><p>æ¶ˆè´¹çº¿ç¨‹å¹¶ä¸ç›´æ¥ä¸æ¶ˆæ¯é˜Ÿåˆ—å‘ç”Ÿå…³ç³»ï¼Œè€Œæ˜¯é€šè¿‡ Looper ä½œä¸ºä¸­é—´è€…æ¥åè°ƒæ¶ˆæ¯çš„åˆ†å‘ä¸å¤„ç†ï¼šæ¶ˆè´¹ç”µè½¦ç»‘å®š Looperï¼Œè€Œ Looper ä¼šç»‘å®šä¸€ä¸ª MessageQueueã€‚é»˜è®¤åªæœ‰ UI çº¿ç¨‹è‡ªå¸¦ Looper ï¼Œå…¶ä»–å­çº¿ç¨‹éœ€è¦è°ƒç”¨è€…æ˜¾å¼å£°æ˜ Looper ã€‚</p><pre><code class="java">new Thread() {    @Override    public void run() {        // prepare() æ–¹æ³•ä¼šåˆå§‹åŒ–ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶å°†å…¶ä¸å½“å‰çº¿ç¨‹ç»‘å®š        // åœ¨æ­¤æ—¶ï¼Œè¯¥æ¶ˆæ¯é˜Ÿåˆ—å·²ç»å¯ä»¥æ’å…¥æ¶ˆæ¯ï¼Œä½†æ˜¯æ— æ³•åˆ†å‘åˆ°æ¶ˆè´¹çº¿ç¨‹å¤„ç†        Looper.prepare();        // ... ...        // æ­¤æ–¹æ³•ä¸ºä¸€ä¸ª blocking callï¼Œç¡®ä¿ run() æ–¹æ³•ä¸ä¼šç»“æŸæ‰§è¡Œ        // å½“ run() æ–¹æ³•é˜»å¡çš„æ—¶å€™ï¼ŒLooper å¯ä»¥å¾ªç¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åå‘æ¶ˆè´¹çº¿ç¨‹åˆ†å‘æ¶ˆæ¯        Looper.loop();    }}.start();</code></pre><p>ä¸€ä¸ªçº¿ç¨‹åªèƒ½ç»‘å®šä¸€ä¸ª Looperï¼Œè€Œ Looper ä¼šç»‘å®šä¸€ä¸ª MessageQueueï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼›è¿™ä¹Ÿå°±ä¿è¯äº†æ— è®ºå¤šå°‘å·¥ä½œçº¿ç¨‹å‘ä¸»çº¿ç¨‹å‘é€æ¶ˆæ¯ï¼Œä¸»çº¿ç¨‹ä¹Ÿåªèƒ½æŒ‰ç…§ä¸€å®šé¡ºåºæ¥å¤„ç†æ¶ˆæ¯ã€‚å› æ­¤ï¼Œå½“å‰æ‰§è¡Œçš„æ¶ˆæ¯å¤„ç†æ—¶é—´çš„é•¿çŸ­ä¼šå½±å“åˆ°ä¹‹åçš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œåº”è¯¥è§„é¿å¤„ç†è€—æ—¶è¿‡é•¿çš„æ¶ˆæ¯ã€‚</p><h5 id="Looper-çš„ç»ˆæ­¢"><a href="#Looper-çš„ç»ˆæ­¢" class="headerlink" title="Looper çš„ç»ˆæ­¢"></a>Looper çš„ç»ˆæ­¢</h5><ul><li><p>quit()</p><p>ä¸¢å¼ƒæ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‰€æœ‰æœªåˆ†å‘çš„æ¶ˆæ¯ï¼Œä¸ç®¡å…¶æœ‰æ²¡æœ‰è¶Šè¿‡åˆ†å‘æ …æ </p></li><li><p>quitSafely()</p><p>ä¸¢å¼ƒè¿˜æ²¡è¶Šè¿‡åˆ†å‘æ …æ çš„æ¶ˆæ¯ï¼ŒLooper ä¼šç­‰åˆ°å·²ç»å¤„äºå¾…åˆ†å‘çŠ¶æ€çš„æ¶ˆæ¯æ­£ç¡®åˆ†å‘åå†ç»“æŸ</p></li></ul><p>ç»ˆæ­¢ Looper å¹¶ä¸ä¼šç»ˆæ­¢çº¿ç¨‹çš„æ‰§è¡Œï¼Œå®ƒåªæ˜¯å°† loop() æ–¹æ³•ç»“æŸäº†ï¼›ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»ˆæ­¢ Looper åæ­¤çº¿ç¨‹å°†ä¸å†æ˜¯ Looper çº¿ç¨‹ï¼Œæ—¢ä¸èƒ½é‡æ–°ç»‘å®šæ–°çš„ Looper ï¼Œä¹Ÿæ— æ³•å”¤é†’å·²ç»ç»ˆæ­¢çš„ Looperã€‚è°ƒç”¨ Looper.prepare() ä¼šæŠ›å¼‚å¸¸ï¼Œæç¤ºå·²ç»ç»‘å®šï¼›é‡æ–°è°ƒç”¨ Looper.loop() ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œä½†æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¸ä¼šå†å¾—åˆ°åˆ†å‘ã€‚</p><h5 id="UI-çº¿ç¨‹çš„-Looper"><a href="#UI-çº¿ç¨‹çš„-Looper" class="headerlink" title="UI çº¿ç¨‹çš„ Looper"></a>UI çº¿ç¨‹çš„ Looper</h5><p>UI çº¿ç¨‹æ˜¯å”¯ä¸€ä¸€ä¸ªè‡ªå¸¦ Looper çš„çº¿ç¨‹ï¼Œå…¶ä¸å…¶ä»–çº¿ç¨‹æœ‰ä»¥ä¸‹å‡ ç‚¹ä¸åŒï¼š</p><ul><li>åœ¨ç¨‹åºä»»ä½•ä½ç½®éƒ½å¯ä»¥é€šè¿‡è°ƒç”¨ Looper.getMainLooper() æ¥è·å– UI Looper</li><li>UI çº¿ç¨‹çš„ Looper ä¸èƒ½è¢«ç»ˆæ­¢</li><li>Java è™šæ‹Ÿæœºé€šè¿‡ Looper.prepareMainLooper() ä¸º UI çº¿ç¨‹åˆå§‹åŒ– Looperï¼Œæ­¤åŠ¨ä½œåªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œå› æ­¤å°è¯•å°† main looper ä¸å…¶ä»–å­çº¿ç¨‹å…³è”ä¼šæŠ›å¼‚å¸¸ã€‚</li></ul><h5 id="Handler"><a href="#Handler" class="headerlink" title="Handler"></a>Handler</h5><p>Android ç³»ç»Ÿä¸­ä½¿ç”¨ <code>android.os.Handler</code> æ¥åè°ƒå·¥ä½œçº¿ç¨‹ä¸ UI çº¿ç¨‹çš„è°ƒåº¦ï¼Œæ¶ˆæ¯çš„æ’å…¥å’Œå¤„ç†éƒ½ç”±å®ƒæ¥å®Œæˆï¼Œå…·ä½“å·¥ä½œåŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>æ¶ˆæ¯çš„åˆ›å»º</li><li>æ’å…¥æ¶ˆæ¯</li><li>åœ¨æ¶ˆè´¹çº¿ç¨‹ä¸­å¤„ç†æ¶ˆæ¯</li><li>ç®¡ç†æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</li></ul><p>Handler çš„å·¥ä½œéœ€è¦ Looper å’Œ MQ çš„æ”¯æŒï¼Œå› æ­¤ Handler åœ¨å£°æ˜æ—¶å°±åº”è¯¥ç»‘å®š Looper å¯¹è±¡ï¼š</p><ol><li><p>æ„é€ å™¨ä¸­ä¸æ¥æ”¶ Looper çš„ï¼Œè¯¥ Handler ä¸å½“å‰çº¿ç¨‹ç»‘å®š</p><pre><code class="java">// è¿™ç§ä¸å½“å‰çº¿ç¨‹ç»‘å®šçš„ï¼Œå¦‚æœå½“å‰ä¸æ˜¯ Looper çº¿ç¨‹ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸new Handler();new Handler(Handler.Callback);</code></pre></li><li><p>æ„é€ å™¨æ˜ç¡®éœ€è¦ä¼ å…¥ Looper å¯¹è±¡çš„</p><pre><code class="java">new Handler(Looper);new Handler(Looper, Handler.Callback);</code></pre></li></ol><p>ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æœ‰å¤šä¸ª Handler ï¼Œä¸åŒ Handler å‘é€çš„æ¶ˆæ¯å¯ä»¥åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­å…±å­˜ï¼Œå¹¶ä¸ä¼šæœ‰ä»€ä¹ˆå†²çªï¼›å…·ä½“åœ¨åˆ†å‘çš„æ—¶å€™åˆä¼šé€šè¿‡ Message çš„ target å±æ€§å‘é€å›è¯¥æ¶ˆæ¯å¯¹åº”çš„ Handlerï¼š</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190321182554.jpg" alt=""></p><blockquote><p>å¤šä¸ª Handler å‘å‡ºçš„æ¶ˆæ¯ä¹Ÿä¸ä¼šå¯¼è‡´å¹¶å‘ï¼ŒMessage çš„å¤„ç†ä»ç„¶æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ã€‚</p></blockquote><h5 id="Message-creation"><a href="#Message-creation" class="headerlink" title="Message creation"></a>Message creation</h5><p>Handler å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ä¸ªåŒ…è£…æ–¹æ³•ç›´æ¥è·å– Message å¯¹è±¡ï¼Œè€Œè¿™äº›å¯¹è±¡åˆ™ä¼šå’Œ Handler å‘ç”Ÿç»‘å®šå…³ç³»ï¼š</p><pre><code class="java">// è¿™äº›æ–¹æ³•å†…éƒ¨éƒ½ä¼šè°ƒç”¨ Message.obtain() æ–¹æ³•ï¼Œå¹¶å°† Handler ä¼ å…¥ï¼Œä»è€Œäº§ç”Ÿç»‘å®šå…³ç³»Message obtainMessage(int what, int arg1, int arg2)Message obtainMessage()Message obtainMessage(int what, int arg1, int arg2, Object obj) Message obtainMessage(int what)Message obtainMessage(int what, Object obj)</code></pre><h5 id="Message-insertion"><a href="#Message-insertion" class="headerlink" title="Message insertion"></a>Message insertion</h5><p>æ ¹æ®æ¶ˆæ¯ç±»å‹çš„ä¸åŒï¼ŒHandler æ’å…¥æ¶ˆæ¯çš„æ–¹å¼ä¹Ÿç•¥æœ‰å·®åˆ«ã€‚</p><pre><code class="java">// æºå¸¦ä»»åŠ¡çš„æ¶ˆæ¯ï¼Œä½¿ç”¨ postXxx() æ–¹æ³•boolean post(Runnable r)boolean postAtFrontOfQueue(Runnable r)boolean postAtTime(Runnable r, Object token, long uptimeMillis) boolean postAtTime(Runnable r, long uptimeMillis)boolean postDelayed(Runnable r, long delayMillis)// æºå¸¦æ•°æ®çš„æ¶ˆæ¯æˆ–è€…ç©ºæ¶ˆæ¯ï¼Œä½¿ç”¨ sendXxx() æ–¹æ³•// é»˜è®¤ï¼Œç«‹å³åˆ†å‘boolean sendMessage(Message msg) // ä¸‹ä¸€ä¸ªåˆ†å‘boolean sendMessageAtFrontOfQueue(Message msg)// æŒ‡å®šæŸä¸ªç¡®åˆ‡çš„æ—¶é—´è¿›è¡Œåˆ†å‘boolean sendMessageAtTime(Message msg, long uptimeMillis) boolean sendMessageDelayed(Message msg, long delayMillis)boolean sendEmptyMessage(int what)boolean sendEmptyMessageAtTime(int what, long uptimeMillis) boolean sendEmptyMessageDelayed(int what, long delayMillis)</code></pre><p>æ¯æ¡æ¶ˆæ¯éƒ½æœ‰ä¼šæœ‰ä¸€ä¸ª when å±æ€§ï¼Œç”¨æ¥è®°å½•å½“å‰æ¶ˆæ¯åº”è¯¥ä½•æ—¶è¢«åˆ†å‘ï¼›è¯¥å±æ€§ä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ªä¼šå½±å“åˆ†å‘é¡ºåºçš„å› ç´ ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°½ç®¡æˆ‘ä»¬å¯ä»¥æŒ‡å®šç¡®å®šçš„æ—¶æœºåˆ†å‘ï¼Œä½†æ˜¯ç”±äºä¹‹å‰æ¶ˆæ¯çš„å¤„ç†ä¹Ÿä¼šå½±å“åˆ°åä¸€æ¡æ¶ˆæ¯çš„åˆ†å‘ï¼Œå› æ­¤è¿™ä¸ªæ—¶é—´è¿˜æ˜¯ä¸ç¡®å®šçš„ã€‚</p><p>å‘æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ’å…¥æ¶ˆæ¯æ—¶ï¼Œæœ‰å¯èƒ½å¯¼è‡´æŸäº›é”™è¯¯çš„äº§ç”Ÿï¼š</p><ul><li><p>Message has no Handler</p><p>Message was created from a Message.obtain() method without a specified Handler.</p></li><li><p>Message has already been disptached and is being processed</p><p>The same message instance was inserted twice.</p></li><li><p>Looper has exited</p><p>Message is inserted after Looper.quit() has been called.</p></li></ul><blockquote><p>Looper åœ¨åˆ†å‘æ¶ˆæ¯æ—¶ï¼Œä¼šè°ƒç”¨ Handler çš„ dispatchMessage æ–¹æ³•ã€‚å¦‚æœæ­¤æ–¹æ³•è¢«åº”ç”¨ç¨‹åºä¸»åŠ¨è°ƒç”¨ï¼Œé‚£è¯¥æ¶ˆæ¯ä¼šåœ¨å‘èµ·è°ƒç”¨çš„çº¿ç¨‹ç«‹å³å¾—åˆ°æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨æ¶ˆè´¹çº¿ç¨‹æ‰§è¡Œã€‚</p></blockquote><h5 id="Message-processing"><a href="#Message-processing" class="headerlink" title="Message processing"></a>Message processing</h5><p>Message æ ¹æ®æºå¸¦æ•°æ®ç±»å‹çš„ä¸åŒï¼Œæœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ï¼š</p><ul><li><p>Task messages</p><p>å¦‚æœæºå¸¦çš„æ˜¯ Runnbale å¯¹è±¡ï¼Œé‚£ç­‰è½®åˆ°è¯¥æ¡æ¶ˆæ¯åˆ†å‘çš„æ—¶å€™ï¼Œåˆ™è¯¥ Runnable å¯¹è±¡çš„ run æ–¹æ³•ä¼šç›´æ¥å¾—åˆ°æ‰§è¡Œï¼Œè€Œä¸ä¼šå†è§¦å‘ <code>Handler.handMessage()</code> æ–¹æ³•ã€‚</p></li><li><p>Data messages</p><p>å¦‚æœæ¶ˆæ¯æºå¸¦çš„æ˜¯æ•°æ®çš„è¯ï¼Œé‚£å¤„ç†æ¶ˆæ¯åˆ™éœ€è¦é‡å†™ <code>Handler.handMessage()</code> æ–¹æ³•ï¼ˆä¸¤ç§æ–¹å¼ï¼‰ã€‚</p></li></ul><p>ä¸€ç§æ˜¯æ­£å¸¸çš„å®ç°è‡ªå·±çš„ Handler ï¼Œç„¶åé‡å†™è¯¥æ–¹æ³•ï¼›æˆ–è€…åœ¨åˆå§‹åŒ– Handler çš„æ—¶å€™ç›´æ¥é‡å†™è¯¥æ–¹æ³•ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœåœ¨å­çº¿ç¨‹ä¸­ï¼Œè¯¥æ–¹æ³•çš„é‡å†™è¦åœ¨æ¶ˆæ¯é˜Ÿåˆ—å°±ç»ªä»¥åç«‹åˆ»å£°æ˜ï¼Œå¦åˆ™ loop() å¾ªç¯å¼€å¯åï¼Œå°±æ— æ³•å†å£°æ˜äº†ï¼š</p><pre><code class="java">class ConsumerThread extends Thread{    Handler mHandler;    @Override    public void run(){        Looper.prepare();        mHandler = new Handler(){            public void handleMessage(Message msg){                // process data message here            }        };        Looper.loop();    }}</code></pre><p>å¦ä¸€ç§æ–¹å¼æ˜¯åˆ©ç”¨ <code>Handler.Callback</code> æ¥å£ï¼Œè¯¥æ¥å£æ–¹æ³•ä¸ºä¸€ä¸ªå¸¦å¸ƒå°”ç±»å‹è¿”å›å€¼çš„ <code>handleMessage</code> æ–¹æ³•ï¼š</p><pre><code class="java">public interface Callback {    // true: ä»£è¡¨å®ç°ç±»å¤„ç†å®Œæ¶ˆæ¯å³ç»ˆæ­¢    // false: ä»£è¡¨å®ç°ç±»å¤„ç†å®Œä»¥åï¼Œè¿˜è¦ç»§ç»­ä¸‹å‘åˆ° Handler.handleMessage æ–¹æ³•    public boolean handleMessage(Message msg);}// æ¶ˆæ¯åˆ†å‘public void dispatchMessage(Message msg) {    if (msg.callback != null) {        handleCallback(msg);    } else {        if (mCallback != null) {            // å¦‚æœè¿”å› true ï¼Œåˆ™ä¸ä¼šç»§ç»­å‘ä¸‹åˆ†å‘äº†            if (mCallback.handleMessage(msg)) {                return;            }        }        handleMessage(msg);    }    }</code></pre><p>ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œè°ƒç”¨è€…ä¸å†éœ€è¦ç»§æ‰¿è‡ª Handler ï¼Œè€Œåªéœ€è¦å°† Callback æ¥å£çš„å®ç°ç±»å½“åš Handler æ„é€ å™¨ä¼ å…¥å³å¯ï¼Œç„¶åè¯¥ Handler å°±ä¼šå›è°ƒåˆ° handleMessage()ï¼š</p><pre><code class="java">public class HandlerCallbackActivity extends Activity implements Handler.Callback {    Handler mUiHandler;    @Override    public void onCreate(Bundle savedInstanceState){        super.onCreate(savedInstanceState);        mUiHandler = new Handler(this); // ç›´æ¥é€šè¿‡æ„é€ å™¨ä¼ å…¥ï¼Œå³å¯é€šè¿‡æ­¤ç±»å¤„ç†æ¶ˆæ¯    }    @Override    public boolean handleMessage(Message msg){        // process msg        return true;    }}</code></pre><h4 id="ä¸-UI-çº¿ç¨‹é€šä¿¡"><a href="#ä¸-UI-çº¿ç¨‹é€šä¿¡" class="headerlink" title="ä¸ UI çº¿ç¨‹é€šä¿¡"></a>ä¸ UI çº¿ç¨‹é€šä¿¡</h4><p>æ­£å¦‚ä¹‹å‰æ‰€è¯´ï¼ŒUI çº¿ç¨‹æ˜¯å”¯ä¸€ä¸€ä¸ªè‡ªå¸¦ Looper çš„çº¿ç¨‹ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥å‘ UI çº¿ç¨‹å‘é€æ¶ˆæ¯ï¼Œä½†è¦æ³¨æ„é¿å…è€—æ—¶æ“ä½œï¼Œå› ä¸º UI çº¿ç¨‹æ˜¯å…¨å±€çš„ï¼Œæ¯ä¸ªä»»åŠ¡çš„æ—¶é•¿éƒ½ä¼šå¯¹å…¨å±€ä»»åŠ¡çš„æ‰§è¡Œäº§ç”Ÿå½±å“ã€‚</p><p>æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼å°†æ¶ˆæ¯è½¬äº¤åˆ° UI çº¿ç¨‹å¤„ç†ï¼š</p><ol><li><p>ä¸º Handler æŒ‡å®š UI çº¿ç¨‹çš„ Looper</p><pre><code class="java">Runnable task = new Runnable(){...};new Handler(Looper.getMainLooper()).post(task);</code></pre><p>ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œä¸ç®¡è°ƒç”¨çº¿ç¨‹ï¼Œtask éƒ½ä¼šé€šè¿‡ UI Looper ç›´æ¥æ’å…¥ UI MessageQueueã€‚</p></li><li><p>ç›´æ¥åœ¨ UI çº¿ç¨‹å‘è‡ªèº«å‘é€æ¶ˆæ¯ï¼Œè¯¥ä»»åŠ¡ä¼šåœ¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ¶ˆæ¯å¤„ç†å®Œåå¾—åˆ°æ‰§è¡Œ</p><pre><code class="java">private void postFromUiThreadToUiThread(){    new Handler().post(new Runnable(){...})}</code></pre></li><li><p>Activity.runOnUiThread</p><pre><code class="java">private void postFromUiThreadToUiThread(){    runOnUiThread(new Runnable(){...})}</code></pre><p>å¦‚æœæ­¤æ–¹æ³•åœ¨å…¶ä»–çº¿ç¨‹è°ƒç”¨ï¼Œåˆ™å®ƒä¼šå°†æ¶ˆæ¯æ’å…¥åˆ° UI çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚æ­¤æ–¹æ³•åªèƒ½ç”± Activity çš„å®ä¾‹æ¥è°ƒç”¨ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥å®ç°è‡ªå·±çš„ runOnUIThread æ–¹æ³•ï¼Œåªè¦è¿½è¸ª UI çº¿ç¨‹çš„ ID å³å¯ï¼š</p><pre><code class="java">public class MyApplication extends Application{    private long mUiThreadId;    private Handler mUiHandler;    @Override    public void onCreate(){        super.onCreate();        mUiThread = Thread.currentThread().getId();        mUiHandler = new Handler();    }    public void customRunOnUiThread(Runnable action){        if(Thread.currentThread().getId() != mUiThreadId){            mUiHandler.post(action);        } else{            action.run();        }    }}</code></pre></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Efficient.Android.Threading ç¬¬å››ç« è¯»ä¹¦ç¬”è®° ä¸‹ç¯‡&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="http://joeljt.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Efficient.Android.Threading" scheme="http://joeljt.top/tags/Efficient-Android-Threading/"/>
    
  </entry>
  
  <entry>
    <title>çº¿ç¨‹é—´é€šä¿¡ ä¸Šç¯‡</title>
    <link href="http://joeljt.top/2018/09/09/Efficient-Android-Threading-chapter-4-1/"/>
    <id>http://joeljt.top/2018/09/09/Efficient-Android-Threading-chapter-4-1/</id>
    <published>2018-09-08T16:00:00.000Z</published>
    <updated>2019-03-21T10:47:26.820Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Efficient.Android.Threading ç¬¬å››ç« è¯»ä¹¦ç¬”è®° ä¸Šç¯‡</p></blockquote><a id="more"></a><p>åœ¨å¤šè¿›ç¨‹åº”ç”¨ä¸­ï¼Œå„ä¸ªä»»åŠ¡å¯ä»¥å¹¶è¡Œæ‰§è¡Œåä½œä»¥äº§å‡ºç»“æœã€‚å› æ­¤ï¼Œå„ä¸ªçº¿ç¨‹ä¹‹é—´å¿…é¡»è¿›è¡Œé€šä¿¡æ‰èƒ½æ»¡è¶³åä½œæ‰§è¡Œçš„ç›®çš„ã€‚åœ¨ Android ç³»ç»Ÿä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä¼ ç»Ÿçš„ Java çº¿ç¨‹é€šä¿¡æŠ€æœ¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ Android ä¸“å±çš„ Handler / Looper æ¶ˆæ¯æœºåˆ¶ã€‚åŸºäºæ­¤ï¼Œæœ¬ç« çš„ä¸»è¦å†…å®¹ä¸ºï¼š</p><ul><li>ä½¿ç”¨å•å‘ä¼ è¾“çš„ç®¡é“æ¥è¿›è¡Œæ•°æ®ä¼ è¾“</li><li>å…±äº«å†…å­˜é€šä¿¡</li><li>ä½¿ç”¨ <code>BlockingQueue</code> å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…</li><li>æ¶ˆæ¯é˜Ÿåˆ—çš„å…·ä½“æ“ä½œ</li><li>å°†å…·ä½“ä»»åŠ¡å‘å› UI çº¿ç¨‹</li></ul><h3 id="ç®¡é“"><a href="#ç®¡é“" class="headerlink" title="ç®¡é“"></a>ç®¡é“</h3><p>ç®¡é“ <code>Pipes</code> ä»å±äº <code>java.io</code> åŒ…ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸¥æ ¼æ„ä¹‰ä¸Šè®²ï¼Œå®ƒæ˜¯å±äº Java è¯­è¨€èŒƒç•´ï¼Œè€Œé Android ç³»ç»Ÿçš„ã€‚ä¸€ä¸ªç®¡é“ä¸ºåŒä¸€è¿›ç¨‹çš„ä¸¤ä¸ªçº¿ç¨‹æä¾›ä¸€ç§äº¤äº’æ–¹å¼ï¼Œä¸ºäºŒè€…å»ºç«‹è¿æ¥ï¼Œæ­å»ºä¸€ä¸ªå•å‘ä¼ è¾“çš„æ•°æ®ä¼ è¾“é€šé“ï¼šç”Ÿäº§è€…çº¿ç¨‹å‘ç®¡é“ä¸­å†™å…¥æ•°æ®ï¼ŒåŒæ—¶æ¶ˆè´¹è€…çº¿ç¨‹ä»ä¸­å–æ•°æ®ã€‚</p><p>Java ç®¡é“ä¸ Unix ç³»ç»Ÿç®¡é“å‘½ä»¤ <code>|</code> ç›¸æ¯”è¾ƒèµ·æ¥æœ‰æ‰€ä¸åŒã€‚Java ç®¡é“ç”¨æ¥ä¸ºåŒä¸€è¿›ç¨‹ä¸­çš„ä¸åŒçº¿ç¨‹æä¾›é€šä¿¡æœåŠ¡ï¼›è€Œ Unix ç³»ç»Ÿç®¡é“å‘½ä»¤ç”¨æ¥å°†æŸä¸ªå‘½ä»¤çš„è¾“å…¥é‡å®šå‘ä¸ºå¦ä¸€å‘½ä»¤çš„è¾“å…¥ã€‚</p><p>ç®¡é“åœ¨å†…å­˜ä¸­è¡¨ç°ä¸ºä¸€ä¸ªå¾ªç¯ç¼“å†²åŒºï¼Œä»…é€‚ç”¨äºä¸¤ä¸ªè¿æ¥çš„çº¿ç¨‹ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•æ¥è§¦åˆ°å…¶ä¸­çš„æ•°æ®ã€‚åŒæ—¶ï¼Œç®¡é“æ˜¯å•å‘çš„ï¼Œåªå…è®¸ä¸€ä¸ªçº¿ç¨‹çº¿ç¨‹å†™å…¥æ•°æ®ï¼Œå¦ä¸€çº¿ç¨‹è¯»å–æ•°æ®ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçº¿ç¨‹å®‰å…¨æ˜¯å¯ä»¥ç¡®å®šçš„ã€‚</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190321182548.jpg" alt="Pipes"></p><p>ç®¡é“çš„å…¸å‹ä½¿ç”¨åœºæ™¯ä¸ºï¼Œå¹¶è¡Œçš„ä¸¤ä¸ªè€—æ—¶ä»»åŠ¡ï¼Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹éœ€è¦ä¸åœåœ°ç»™å¦ä¸€ä¸ªçº¿ç¨‹ä¼ è¾“æ•°æ®ã€‚ç®¡é“å¯ä»¥ç”¨æ¥ä¸º UI çº¿ç¨‹å‡å‹ï¼Œä»è€Œä¿è¯ç”¨æˆ·ç•Œé¢å“åº”çš„åŠæ—¶æ€§ï¼Œä»è€Œæå‡ç”¨æˆ·ä½“éªŒã€‚</p><p>ç®¡é“å¯ä»¥ä¼ è¾“äºŒè¿›åˆ¶æ•°æ®æˆ–è€…å­—èŠ‚æ•°æ®ã€‚å…¶ä¸­ï¼ŒäºŒè¿›åˆ¶æ•°æ®çš„ä»£è¡¨ä¸º <code>PipedOutputStream</code> å’Œ <code>PipedInputStream</code> ï¼Œå­—èŠ‚æ•°æ®çš„ä»£è¡¨ä¸º <code>PipedWriter</code> å’Œ <code>PipedReader</code> ã€‚é™¤äº†ä¼ è¾“æ•°æ®ç±»å‹çš„ä¸åŒä»¥å¤–ï¼Œä»¥ä¸Šä¸¤ç§ç±»å‹çš„ç®¡é“æ²¡æœ‰ä»»ä½•ä¸åŒã€‚ç®¡é“çš„ç”Ÿå‘½å‘¨æœŸè‡ªä¸¤ä¸ªçº¿ç¨‹å»ºç«‹è¿æ¥å¼€å§‹ï¼Œæ–­å¼€è¿æ¥æ—¶ç”Ÿå‘½å‘¨æœŸç»“æŸã€‚</p><h4 id="ç®¡é“çš„åŸºæœ¬ä½¿ç”¨"><a href="#ç®¡é“çš„åŸºæœ¬ä½¿ç”¨" class="headerlink" title="ç®¡é“çš„åŸºæœ¬ä½¿ç”¨"></a>ç®¡é“çš„åŸºæœ¬ä½¿ç”¨</h4><p>åŸºæœ¬çš„ç®¡é“ç”Ÿå‘½å‘¨æœŸå¯ä»¥å½’çº³æ¦‚æ‹¬ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼šå»ºç«‹è¿æ¥ï¼Œæ•°æ®ä¼ è¾“å’Œæ–­å¼€è¿æ¥ã€‚</p><pre><code class="java">// 1.å»ºç«‹è¿æ¥ - int BUFFER_SIZE_IN_CHARS = 1024 * 4; // é»˜è®¤ä¸º 1024ï¼Œå¯ä»¥è‡ªå®šä¹‰PipedReader r = new PipedReader(BUFFER_SIZE_IN_CHARS);PipedWriter w = new PipedWriter();w.connect(r); // r.connect(w);// 2.å°†æ¶ˆè´¹è€…ä¼ å…¥çº¿ç¨‹ä¸­, çº¿ç¨‹å¯åŠ¨åï¼Œå°±å‡†å¤‡å¥½ä»ç®¡é“ä¸­è¯»å–æ•°æ®äº†Thread t = new MyReaderThread(r);t.start();// 3. ä¼ è¾“æ•°æ®// ç±»ä¼¼è¿™ç§ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹çš„é€šä¿¡æ–¹å¼ï¼Œä¸€èˆ¬éƒ½æ˜¯å¸¦æœ‰é˜»å¡æœºåˆ¶çš„ã€‚// å¦‚æœç®¡é“å·²æ»¡ï¼Œåˆ™ write() ä¼šå¤„äºé˜»å¡çŠ¶æ€ï¼Œç›´åˆ°ç®¡é“ä¸­å†æ¬¡æœ‰ç©ºä½™ç©ºé—´ï¼›// å¦‚æœç¼“å­˜ä¸ºç©ºï¼Œåˆ™ read() ä¼šå¤„äºé˜»å¡çŠ¶æ€ã€‚// flush() æ–¹æ³•çš„è°ƒç”¨æ˜¯å¾ˆæœ‰å¿…è¦çš„// å› ä¸ºå½“ read() çº¿ç¨‹è°ƒç”¨ wait() åï¼Œé»˜è®¤ä¼šæœ‰è‡³å°‘ä¸€ç§’é’Ÿçš„è¶…æ—¶æ—¶é•¿// flush() æ–¹æ³•ç›¸å½“äº notify()ï¼Œå¯ä»¥ä¿è¯æ¶ˆè´¹è€…é©¬ä¸Šå¯¹æ–°åŠ å…¥çš„æ•°æ®åšå‡ºå“åº”w.write(&#39;A&#39;);w.flush();int i; // ä¼ è¾“çš„æ•°æ®ä¼šè¢«è½¬ä¸º int ç±»å‹ï¼Œä»¥ä¿è¯ä¸åŒç¼–ç æ ¼å¼çš„ç»Ÿä¸€æ€§while((i = r.read()) != -1){    char c = (char)i;}// 4. å…³é—­è¿æ¥// å¦‚æœå…³é—­ writer, ç®¡é“å…³é—­ä½†ç¼“å­˜ä¸­çš„æ•°æ®è¿˜ä¼šè¢«è¯»å–åˆ°// å¦‚æœå…³é—­ reader, åˆ™ç¼“å­˜ä¸­çš„æ•°æ®ä¼šè¢«æ¸…é™¤w.close();r.close();</code></pre><h4 id="ç®¡é“åœ¨-Android-ç³»ç»Ÿä¸­çš„åº”ç”¨"><a href="#ç®¡é“åœ¨-Android-ç³»ç»Ÿä¸­çš„åº”ç”¨" class="headerlink" title="ç®¡é“åœ¨ Android ç³»ç»Ÿä¸­çš„åº”ç”¨"></a>ç®¡é“åœ¨ Android ç³»ç»Ÿä¸­çš„åº”ç”¨</h4><p>ä½¿ç”¨ç®¡é“æ¥å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œä¸€äº›ç®€å•å¤„ç†ï¼šç”¨æˆ·é€šè¿‡ EditText è¾“å…¥å†…å®¹ï¼Œä¸ºäº†ä¿è¯ UI çº¿ç¨‹çš„å³æ—¶æ€§ï¼Œä½¿ç”¨ç®¡é“å°†ç”¨æˆ·è¾“å…¥å†…å®¹å‘é€åˆ°å·¥ä½œçº¿ç¨‹è¿›è¡ŒæŸäº›è€—æ—¶æ“ä½œçš„å¤„ç†ï¼š</p><pre><code class="java">private static class TextHandlerTask implements Runnable {    private final PipedReader reader;    private TextHandlerTask(PipedReader reader) {        this.reader = reader;    }    @Override    public void run() {        while (!Thread.currentThread().isInterrupted()) {            int i;            try {                while ((i = reader.read()) != -1) {                    char c = (char) i;                    Log.e(&quot;Test&quot;, &quot;char -&gt; &quot; + c);                }            } catch (IOException e) {                e.printStackTrace();            }        }    }}private PipedReader r = new PipedReader();private PipedWriter w = new PipedWriter();w.connect(r);etSearch.addTextChangedListener(new TextWatcher() {    @Override    public void onTextChanged(CharSequence s, int start, int before, int count) {        if (count &gt; before) { // è¾“å…¥å†…å®¹            try {                w.write(s.subSequence(before, count).toString());            } catch (IOException e) {                e.printStackTrace();            }        }    }});new Thread(new TextHandlerTask(r)).start();</code></pre><h3 id="å…±äº«å†…å­˜"><a href="#å…±äº«å†…å­˜" class="headerlink" title="å…±äº«å†…å­˜"></a>å…±äº«å†…å­˜</h3><p>å…±äº«å†…å­˜æ˜¯ä¸€ç§é€šç”¨çš„çº¿ç¨‹é—´é€šä¿¡çš„æ–¹å¼ã€‚åº”ç”¨ç¨‹åºçš„åœ°å€ç©ºé—´å­˜å‚¨åœ¨å †ä¸­ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥å¯¹å…¶è¿›è¡Œè®¿é—®ï¼Œå³æŸä¸ªçº¿ç¨‹æ“ä½œæŸä¸ªæ•°æ®ï¼Œè¯¥æ•°æ®åŒæ—¶å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹æ‰€è¯»å–ã€‚</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190321182555.jpg" alt="ä¸åŒçº¿ç¨‹åˆ©ç”¨å…±äº«å†…å­˜è¿›è¡Œé€šä¿¡"></p><p>å¦‚æœæŸä¸ªçº¿ç¨‹å°†å…¶æ•°æ®å­˜å‚¨ä¸ºå±€éƒ¨å˜é‡ï¼ˆæœ¬åœ°å˜é‡ï¼‰ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹æ˜¯æ— æ³•å¯¹å…¶è¿›è¡Œè®¿é—®çš„ã€‚åªæœ‰å°†æ•°æ®å­˜å‚¨åœ¨å…±äº«å†…å­˜ä¸­ï¼Œæ‰èƒ½å¤Ÿè¢«å…¶ä»–çº¿ç¨‹è®¿é—®åˆ°ï¼Œä»è€Œå®Œæˆä¸åŒçº¿ç¨‹é—´çš„åä½œã€‚ä»¥ä¸‹å¯¹è±¡ä¸€èˆ¬è¢«è®¤ä¸ºæ˜¯å­˜å‚¨åœ¨å…±äº«å†…å­˜ä¸­çš„ï¼š<code>å®ä¾‹å˜é‡</code>ï¼Œ<code>ç±»å˜é‡</code>ï¼Œ<code>æ–¹æ³•ä¸­å£°æ˜çš„å¯¹è±¡</code>ã€‚</p><p>å¯¹è±¡çš„å¼•ç”¨ï¼ˆæŒ‡é’ˆï¼‰å­˜å‚¨åœ¨çº¿ç¨‹çš„æ ˆä¸­ï¼Œä½†æ˜¯å¯¹è±¡å…¶æœ¬èº«ï¼ˆå ç”¨çš„å†…å­˜ï¼‰å­˜å‚¨åœ¨å…±äº«å†…å­˜ä¸­ã€‚ä¸åŒæ–¹æ³•ä¹‹é—´å¦‚æœæƒ³è¦äº’ç›¸æ“ä½œå¯¹è±¡ï¼Œåˆ™éœ€è¦å°†å¯¹è±¡çš„å¼•ç”¨è¿›è¡Œä¼ é€’æ‰å¯ä»¥å®ç°ã€‚<code>ä¸åŒçš„çº¿ç¨‹é€šè¿‡å®šä¹‰å®ä¾‹å±æ€§ä»¥åŠç±»å±æ€§æ¥å®ç°é€šä¿¡å’Œä»»åŠ¡åä½œ</code>ã€‚</p><h4 id="å‘é€ä¿¡å·"><a href="#å‘é€ä¿¡å·" class="headerlink" title="å‘é€ä¿¡å·"></a>å‘é€ä¿¡å·</h4><p>ç”±äºçº¿ç¨‹æ•°æ®å®‰å…¨é—®é¢˜çš„å­˜åœ¨ï¼Œä¸åŒçš„çº¿ç¨‹åœ¨æ“ä½œåŒä¸€æ•°æ®æ—¶éœ€è¦æœ‰é˜»å¡æœºåˆ¶ï¼Œæ¥ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«æ•°æ®è¿›è¡Œæ“ä½œã€‚Java å†…ç½®çš„å”¤é†’æœºåˆ¶å°±å¾ˆå¥½çš„è§£å†³äº†è¿™ä¸€é—®é¢˜ã€‚</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190321182553.jpg" alt="Thread signal"></p><p>å½“æŸä¸€çº¿ç¨‹é™¤éæ»¡è¶³æŸä¸ªæ¡ä»¶ï¼Œå¦åˆ™æ— æ³•ç»§ç»­æ‰§è¡Œæ—¶ï¼Œè¯¥çº¿ç¨‹å¯ä»¥è°ƒç”¨ wait() / await() æ–¹æ³•ã€‚timeout å‚æ•°è¡¨ç¤ºå½“å‰çº¿ç¨‹åœ¨ä¸‹æ¬¡æ‰§è¡Œå‰ï¼Œéœ€è¦ç­‰å¾…å¤šä¹…ã€‚</p><p>å½“å…¶ä»–çº¿ç¨‹å·²ç»å°†çŠ¶æ€æ›´æ”¹ï¼Œä¹Ÿå°±æ˜¯ç°åœ¨æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹å·²ç»æ»¡è¶³æ¡ä»¶äº†ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹ä¼šé€šè¿‡è°ƒç”¨ notify() / notifyAll() æ¥é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹ï¼›è€Œæ”¶åˆ°æ¶ˆæ¯çš„çº¿ç¨‹åˆ™å¯ä»¥ç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¾ˆå¯èƒ½å¹¶ä¸æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…ï¼Œä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥åŒæ­¥ä»£ç å—ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ”¶åˆ°é€šçŸ¥æ¶ˆæ¯çš„æ¶ˆæ¯ä¹Ÿå¹¶ä¸ä¸€å®šå¯ä»¥ç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚è¿™å°±è¦æ±‚ç­‰å¾…çº¿ç¨‹éœ€è¦éµå¾ªä¸€å®šçš„è®¾è®¡æ¨¡å¼ï¼Œå³<code>åœ¨åŒæ­¥ä»£ç å—ä¸­ï¼Œé‡å¤æ£€æŸ¥æ¡ä»¶æ˜¯å¦å·²ç»æ»¡è¶³</code>ã€‚</p><pre><code class="java">synchronized(this){    while(isConditionFulfilled == false){        wait();    }    // ä»£ç æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œæ‰è¯´æ˜çŠ¶æ€æ˜¯å¯¹çš„}</code></pre><p>ä»¥ä¸Šä»£ç åœ¨åŒæ­¥ä»£ç å—ä¸­å†æ¬¡æ£€æŸ¥äº†æ¡ä»¶æ˜¯å¦æ»¡è¶³ã€‚å¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œåˆ™å½“å‰çº¿ç¨‹æŒ‚èµ·ç­‰å¾…ï¼›å½“æ”¶åˆ°é€šçŸ¥æ¶ˆæ¯ï¼Œç­‰å¾…çº¿ç¨‹è¢«å”¤é†’ï¼Œå®ƒåœ¨æ‰§è¡Œå…³é”®ä»£ç å‰ä¼šå†æ¬¡æ ¡éªŒåŒæ­¥æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œå› ä¸ºæœ‰å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹æ·è¶³å…ˆç™»ï¼Œå¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œåˆ™å…¶ä¼šç»§ç»­æŒ‚èµ·ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªå”¤é†’ä¿¡å·ã€‚</p><p>ä»¥ä¸Šæœºåˆ¶å¾ˆå¥½çš„ååŒäº†å¤šçº¿ç¨‹çš„é€šä¿¡ï¼Œä½†æ˜¯ä¸é€‚åˆ Android å¹³å°ï¼Œå› ä¸º UI çº¿ç¨‹ç»ä¸èƒ½æŒ‚èµ·ç­‰å¾…å·¥ä½œçº¿ç¨‹å®Œæˆä»»åŠ¡åå”¤é†’ï¼Œä¹‹åçš„æ–‡ç« ä¸­ä»‹ç» Android æ¶ˆæ¯åˆ†å‘æœºåˆ¶ã€‚</p><h3 id="é˜»å¡é˜Ÿåˆ—"><a href="#é˜»å¡é˜Ÿåˆ—" class="headerlink" title="é˜»å¡é˜Ÿåˆ—"></a>é˜»å¡é˜Ÿåˆ—</h3><p>çº¿ç¨‹ä¿¡ä»¤æ˜¯ä¸€ç§ä½çº§ï¼Œé«˜åº¦å¯é…ç½®çš„æœºåˆ¶ï¼Œå°½ç®¡å®ƒå¯ä»¥åº”ç”¨åœ¨å¾ˆå¤šåœºæ™¯ï¼Œä½†åŒæ—¶è¿™ä¹Ÿæ˜¯ä¸€ç§æå®¹æ˜“å‡ºé”™çš„æŠ€æœ¯ã€‚å› æ­¤ï¼ŒJava å¹³å°åŸºäºçº¿ç¨‹ä¿¡ä»¤æœºåˆ¶ï¼Œé‡æ–°æ„å»ºäº†ä¸€å¥—æŠ½è±¡æ¦‚å¿µï¼Œä»¥æœŸè§£å†³çº¿ç¨‹ä¹‹é—´å¤šå¯¹è±¡çš„å•å‘åˆ‡æ¢ã€‚</p><p>åœ¨è¿™ä¸€æœºåˆ¶ä¸­ï¼Œçº¿ç¨‹çš„æŒ‚èµ·å’Œå”¤é†’ä¸å†é€šè¿‡æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…æœ¬èº«æ¥æ§åˆ¶ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªå¸¦æœ‰é˜»å¡ç‰¹æ€§çš„é˜Ÿåˆ—æ¥å®Œæˆï¼Œä¾‹å¦‚ï¼Œ<code>java.util.concurrent.BlockingQueue</code>ã€‚</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190321182555.jpg" alt="BlockingQueue"></p><p>é˜»å¡é˜Ÿåˆ—æ‰®æ¼”ç€ç”Ÿäº§è€…çº¿ç¨‹å’Œæ¶ˆè´¹è€…çº¿ç¨‹ä¸­é—´çš„åè°ƒè€…ï¼Œå†…éƒ¨ç»´æŠ¤ä¸€ä¸ªå®ç°äº†çº¿ç¨‹ä¿¡ä»¤æœºåˆ¶ï¼Œå¯è‡ªå®šä¹‰å¤§å°çš„åˆ—è¡¨ã€‚å…·ä½“ä½¿ç”¨çš„æ—¶å€™ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æ•°æ®å·²æ»¡ï¼Œåˆ™ç”Ÿäº§è€…çº¿ç¨‹ put() æ–¹æ³•ä¼šé˜»å¡ï¼Œç›´åˆ°æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­å–å‡ºæ•°æ®ï¼›å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™æ¶ˆè´¹è€…çº¿ç¨‹ take() æ–¹æ³•ä¼šé˜»å¡ï¼Œç›´åˆ°ç”Ÿäº§è€…å‘é˜Ÿåˆ—ä¸­æ’å…¥æ•°æ®ã€‚</p><pre><code class="java">public class ConsumerProducer{    private final int LIMIT = 10;    private BlockingQueue&lt;Integer&gt; blockingQueue =         new LinkedBlockingQueue&lt;Integer&gt;(LIMIT);    public void produce() throws InterruptedException{        int value = 0;        while(true){            blockingQueue.put(value++);        }    }    public void consume() throws InterruptedException{        while(true){            int value = blockingQueue.take();        }    }}</code></pre><p>ä»¥ä¸Šæ˜¯ç¬¬å››ç« å‰åŠéƒ¨åˆ†å†…å®¹ï¼Œç”±äºç¯‡å¹…è¾ƒé•¿ï¼Œå‡†å¤‡åˆ†ä¸ºä¸¤ç¯‡æ¥è®°å½•ã€‚</p><p>æ¥ä¸‹æ¥ä¼šä»‹ç» Android å¹³å°çš„æ¶ˆæ¯åˆ†å‘æœºåˆ¶ï¼Œä¸‹ç¯‡å†è§ï¼Œå¤§å®¶åŠ æ²¹~</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Efficient.Android.Threading ç¬¬å››ç« è¯»ä¹¦ç¬”è®° ä¸Šç¯‡&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="http://joeljt.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Efficient.Android.Threading" scheme="http://joeljt.top/tags/Efficient-Android-Threading/"/>
    
  </entry>
  
  <entry>
    <title>Android ç³»ç»Ÿä¸­çš„çº¿ç¨‹</title>
    <link href="http://joeljt.top/2018/08/29/Efficient-Android-Threading-chapter-3/"/>
    <id>http://joeljt.top/2018/08/29/Efficient-Android-Threading-chapter-3/</id>
    <published>2018-08-28T16:00:00.000Z</published>
    <updated>2019-03-21T10:53:39.443Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Efficient.Android.Threading ç¬¬ä¸‰ç« è¯»ä¹¦ç¬”è®°</p></blockquote><a id="more"></a><p>æ¯ä¸ª Android åº”ç”¨ç¨‹åºéƒ½ä¼šè¿è¡Œç€å¾ˆå¤šçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹ä¸€èˆ¬éƒ½ä¸ Linux è¿›ç¨‹ç»‘å®šï¼Œå¹¶ä¸”é€šè¿‡ Dalvik VM æ¥ç®¡ç†å„çº¿ç¨‹çš„å†…éƒ¨æ‰§è¡Œã€‚åº”ç”¨ä¸»è¦åŒ…æ‹¬ UI çº¿ç¨‹ï¼Œbinder çº¿ç¨‹ï¼Œä»¥åŠè‡ªå·±æŒ‰éœ€åˆ›å»ºçš„åå°çº¿ç¨‹ï¼Œæœ¬ç« ä¸»è¦è®¨è®ºæ–¹å‘ï¼š</p><ul><li>UI çº¿ç¨‹ï¼Œbinder çº¿ç¨‹ï¼Œåå°çº¿ç¨‹çš„åŒºåˆ«</li><li>Linux thread coupling</li><li>åº”ç”¨ç¨‹åºæ’åä¼šå¯¹çº¿ç¨‹çš„æ‰§è¡Œé€ æˆæ€æ ·çš„å½±å“</li><li>æ‰§è¡Œ Linux çº¿ç¨‹</li></ul><h3 id="Android-åº”ç”¨å±‚çº¿ç¨‹"><a href="#Android-åº”ç”¨å±‚çº¿ç¨‹" class="headerlink" title="Android åº”ç”¨å±‚çº¿ç¨‹"></a>Android åº”ç”¨å±‚çº¿ç¨‹</h3><p>Android åº”ç”¨å±‚ä¸»è¦åŒ…æ‹¬ UI çº¿ç¨‹ï¼Œbinder çº¿ç¨‹ï¼Œä»¥åŠè‡ªå·±æŒ‰éœ€åˆ›å»ºçš„åå°çº¿ç¨‹ã€‚</p><h4 id="UI-çº¿ç¨‹"><a href="#UI-çº¿ç¨‹" class="headerlink" title="UI çº¿ç¨‹"></a>UI çº¿ç¨‹</h4><p>UI çº¿ç¨‹åœ¨åº”ç”¨å¯åŠ¨æ—¶å¯åŠ¨ï¼Œç”Ÿå‘½å‘¨æœŸä¸åº”ç”¨ç›¸åŒã€‚ä½œä¸º Android åº”ç”¨çš„ä¸»çº¿ç¨‹ï¼ŒUI çº¿ç¨‹ä¸»è¦è´Ÿè´£ Android ç»„ä»¶å’Œç•Œé¢ UI çš„ç»˜åˆ¶ä¸æ›´æ–°ã€‚å½“ç”¨æˆ·å°è¯•åœ¨å…¶ä»–çº¿ç¨‹æ›´æ–° UI æ—¶ï¼Œç³»ç»Ÿåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚å°½ç®¡è¿™ä¸ªå¤„ç†æ–¹å¼çœ‹ä¸Šå»å¾ˆä¸å‹å¥½ï¼Œä½†å´æ˜¯éå¸¸å¿…è¦çš„ã€‚å› ä¸º Android UI Toolkit ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥ä¸ºäº†è§„é¿ä¸å¿…è¦çš„éº»çƒ¦ï¼Œruntime åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ¥æ“ä½œ UI ã€‚</p><p>UI çº¿ç¨‹æ˜¯åŸºäºæ¶ˆæ¯æœºåˆ¶çš„ï¼ŒæŒ‰ç…§äº‹ä»¶çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚æ‰€æœ‰çš„çº¿ç¨‹éƒ½å¯ä»¥é€šè¿‡ Handler å°†äº‹ä»¶å‘é€åˆ° UI çº¿ç¨‹ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ­£åœ¨åšç€æ’åœ¨å‰é¢çš„äº‹ä»¶ï¼Œåˆ™è¯¥äº‹ä»¶ä¼šå…¥é˜Ÿç­‰å¾…ã€‚</p><h4 id="Binder-çº¿ç¨‹"><a href="#Binder-çº¿ç¨‹" class="headerlink" title="Binder çº¿ç¨‹"></a>Binder çº¿ç¨‹</h4><p>Binder çº¿ç¨‹ä¸»è¦æ˜¯ç”¨æ¥ä¸ºä¸åŒè¿›ç¨‹ä¹‹é—´æä¾›é€šä¿¡çš„ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä¸ä¼šé¢‘ç¹çš„æ–°å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œè€Œæ˜¯ä¸æ–­å¤ç”¨ç°æœ‰çš„å‡ ä¸ªçº¿ç¨‹æ¥ååŒå·¥ä½œã€‚Binder çº¿ç¨‹å¤„ç†æ¥è‡ªå…¶ä»–è¿›ç¨‹çš„è¯·æ±‚ï¼Œå…·ä½“åŒ…æ‹¬ç³»ç»ŸæœåŠ¡ï¼Œintents, content providers, servicesã€‚å¤§éƒ¨åˆ†æ¶‰åŠä¸åˆ°è¿›ç¨‹é—´é€šä¿¡çš„åœºæ™¯ï¼Œæ¶ˆæ¯éƒ½æ˜¯é€šè¿‡ UI çº¿ç¨‹æ¥è¿›è¡Œå¤„ç†çš„ã€‚ä¸€ä¸ªä¾‹å¤–æ˜¯ï¼Œå½“å‰åº”ç”¨å¯èƒ½æä¾›äº†ä¸€ä¸ª <code>Service</code> ï¼Œå…¶é€šè¿‡ AIDL æ¥å£ä¸å…¶ä»–è¿›ç¨‹å®ç°äº†ç»‘å®šã€‚</p><h4 id="åå°çº¿ç¨‹"><a href="#åå°çº¿ç¨‹" class="headerlink" title="åå°çº¿ç¨‹"></a>åå°çº¿ç¨‹</h4><p>ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­ï¼Œæ‰€æœ‰éœ€è¦è°ƒç”¨è€…æ˜¾å¼å£°æ˜çš„çº¿ç¨‹ï¼Œéƒ½æ˜¯åå°çº¿ç¨‹ã€‚ä¸€èˆ¬æ¥è®²ï¼Œåå°çº¿ç¨‹æ˜¯ç”¨æˆ·æ‰‹åŠ¨å£°æ˜çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å…¶é»˜è®¤æ²¡æœ‰ä»»ä½•å®ç°ï¼Œå…¨éƒ¨çš„å·¥ä½œéƒ½ç”±è°ƒç”¨è€…æ¥å®šä¹‰ã€‚åå°çº¿ç¨‹æœ¬è´¨ä¸Šå±äº UI çº¿ç¨‹çš„åä»£ï¼Œæ‰€ä»¥å®ƒç»§æ‰¿äº†ä¸€éƒ¨åˆ† UI çº¿ç¨‹çš„ç‰¹æ€§ï¼Œæ¯”å¦‚ä¼˜å…ˆçº§ã€‚</p><p>åœ¨ Android åº”ç”¨å±‚ï¼ŒUI çº¿ç¨‹ä¸åå°çº¿ç¨‹å¤„ç†çš„å·¥ä½œæ˜¯å®Œå…¨ä¸åŒçš„ï¼›ä½†æ˜¯åœ¨ Linux ç³»ç»Ÿå±‚é¢ï¼ŒäºŒè€…æ˜¯æ²¡æœ‰ä»»ä½•åŒºåˆ«çš„ã€‚UI ç•Œé¢çš„æ›´æ–°åªèƒ½é€šè¿‡ UI çº¿ç¨‹æ¥è¿›è¡Œï¼Œå¹¶ä¸æ˜¯è¢« Linux é™å®šçš„ï¼Œè€Œæ˜¯é€šè¿‡ Application Framework å±‚çš„ Window Manager æ¥é™åˆ¶çš„ã€‚</p><h3 id="Linux-è¿›ç¨‹ä¸çº¿ç¨‹"><a href="#Linux-è¿›ç¨‹ä¸çº¿ç¨‹" class="headerlink" title="Linux è¿›ç¨‹ä¸çº¿ç¨‹"></a>Linux è¿›ç¨‹ä¸çº¿ç¨‹</h3><p>Android ç³»ç»Ÿæ˜¯åŸºäº Linux å†…æ ¸çš„ï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºå®é™…ä¸Šéƒ½æ˜¯ä¸€ä¸ª Linux ç¨‹åºã€‚Android ç³»ç»Ÿçš„æ¯ä¸ªåº”ç”¨éƒ½æœ‰ä¸€ä¸ªéšè—çš„ Linux è¿›ç¨‹ï¼Œå…¶ fork è‡ª Zygote è¿›ç¨‹ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªå€¼å¾—æ³¨æ„çš„å±æ€§ï¼š</p><ul><li><p>User ID(UID)</p><p>Linux ç³»ç»Ÿæ˜¯å¤šç”¨æˆ·ç³»ç»Ÿï¼Œåœ¨ Android ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªåº”ç”¨å°±ä»£è¡¨ä¸€ä¸ªç”¨æˆ·ï¼Œå½“åº”ç”¨å®‰è£…åˆ°ç³»ç»Ÿä¸­æ—¶ï¼Œä¼šè¢«æŒ‡å®šä¸€ä¸ª User ID</p></li><li><p>Process identifier (PID)</p><p>å½“å‰è¿›ç¨‹çš„å”¯ä¸€æ ‡è¯†</p></li><li><p>Parent process identifier  (PPID)</p><p>ç³»ç»Ÿå¯åŠ¨åï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æ˜¯ä¾é™„äºå…¶ä»–è¿›ç¨‹è€Œåˆ›å»ºçš„ã€‚å› æ­¤ï¼Œæ‰€æœ‰æ­£åœ¨è¿è¡Œä¸­çš„è¿›ç¨‹ä¼šæ„æˆä¸€ä¸ªè¿›ç¨‹æ ‘ï¼Œæ‰€æœ‰æ¯ä¸ªåº”ç”¨éƒ½æœ‰ä¸€ä¸ªçˆ¶äº²è¿›ç¨‹ã€‚å°± Android ç³»ç»Ÿæ¥è®²ï¼Œæ‰€æœ‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹éƒ½æ˜¯ Zygote è¿›ç¨‹</p></li><li><p>Stack</p><p>å­˜å‚¨æœ¬åœ°æ–¹æ³•çš„å˜é‡å’ŒæŒ‡é’ˆ</p></li><li><p>Heap</p><p>å½“å‰è¿›ç¨‹ç§æœ‰åŒ–çš„åœ°å€æ•°æ®ä¿¡æ¯ï¼Œæ— æ³•è¢«å…¶ä»–è¿›ç¨‹è·å–åˆ°</p></li></ul><p>è¿›ç¨‹å’Œçº¿ç¨‹ä¸€ä¸ªå¾ˆé‡è¦çš„åŒºåˆ«å°±æ˜¯ï¼Œä¸åŒè¿›ç¨‹ä¹‹é—´æ— æ³•å…±äº«åœ°å€æ•°æ®ï¼Œä½†æ˜¯åŒä¸€è¿›ç¨‹çš„ä¸åŒçº¿ç¨‹å¯ä»¥å…±äº«æ•°æ®ã€‚è¿™å°±ç›´æ¥å¯¼è‡´äº†ï¼Œçº¿ç¨‹é—´é€šä¿¡é€Ÿåº¦æ¯”è¿›ç¨‹é—´é€šä¿¡é€Ÿåº¦å¿«å¾—å¤šã€‚è¿›ç¨‹é—´é€šä¿¡éœ€è¦è¿›è¡Œä¸€äº›è¿œç¨‹æ“ä½œè°ƒç”¨ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹å¼€é”€æ¯”è¾ƒå¤§ã€‚</p><p>ä¸€èˆ¬æ¥è®²ï¼Œåº”ç”¨å¯åŠ¨ä»¥åï¼Œä¼šåˆ›å»ºä¸è¶…è¿‡åä¸ªçº¿ç¨‹ï¼›ç¬¬ä¸€ä¸ªåˆ›å»ºçš„çº¿ç¨‹ä¾¿æ˜¯æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„ UI çº¿ç¨‹ï¼Œä¹‹åæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ˜¯ UI çº¿ç¨‹ç¹è¡å‡ºæ¥çš„ã€‚å…·ä½“è¡¨ç°åœ¨ï¼ŒUI çº¿ç¨‹çš„ PID æ˜¯ 4257ï¼Œä¹‹åæ‰€æœ‰çº¿ç¨‹çš„ PPID éƒ½æ˜¯ UI çº¿ç¨‹çš„ PIDï¼š</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190321182600.jpg" alt="adb shell ps"></p><h4 id="çº¿ç¨‹çš„è°ƒåº¦"><a href="#çº¿ç¨‹çš„è°ƒåº¦" class="headerlink" title="çº¿ç¨‹çš„è°ƒåº¦"></a>çº¿ç¨‹çš„è°ƒåº¦</h4><p>Linux ä¸­çº¿ç¨‹ä¸ºæœ€å°è°ƒåº¦å•å…ƒï¼Œè€Œå¹¶éè¿›ç¨‹ã€‚ä¸€ä¸ªç¨‹åºä¸­çš„æŸä¸ªçº¿ç¨‹éœ€è¦å’Œå…¶ä»–æ‰€æœ‰çº¿ç¨‹è¿›è¡Œæ‰§è¡Œæœºä¼šçš„äº‰å¤ºï¼Œåœ¨ Android ç¨‹åºä¸­ï¼Œçº¿ç¨‹çš„è°ƒåº¦éƒ½æ˜¯ç›´æ¥äº¤ç»™ Linux å†…æ ¸æ¥å¤„ç†çš„ï¼Œè€Œå¹¶é Dalvik è™šæ‹Ÿæœºï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªçº¿ç¨‹éƒ½è¦å’Œæ•´ä¸ªç³»ç»Ÿä¸­çš„æ‰€æœ‰åº”ç”¨çš„æ‰€æœ‰çº¿ç¨‹åšèµ„æºçš„äº‰å¤ºã€‚</p><p>Linux çš„çº¿ç¨‹è°ƒåº¦å™¨åˆè¢«ç§°ä¸ºå®Œå…¨å…¬å¹³è°ƒåº¦ç¨‹åº <code>completely fair scheduler</code> ï¼ŒåŸå› å°±åœ¨äºå®ƒæ‰§è¡Œè°ƒåº¦æ—¶ä¸åªæ ¹æ®ä¼˜å…ˆçº§ï¼Œè¿˜ä¼šå‚è€ƒå…·ä½“çº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´æ¥åšåˆ¤æ–­ã€‚å¦‚æœæŸä¸ªçº¿ç¨‹ä¹‹å‰å¾ˆå°‘æœ‰æœºä¼šè¢«å¤„ç†å™¨æ‰§è¡Œï¼Œé‚£ä¹ˆå³ä½¿å®ƒä¼˜å…ˆçº§å¾ˆä½ï¼Œé‚£å®ƒä¹Ÿä¼šä¼˜å…ˆå¾—åˆ°æ‰§è¡Œï¼›å¦‚æœæŸä¸ªçº¿ç¨‹å¾ˆå°‘éœ€è¦æ‰§è¡Œï¼Œé‚£ CFS ä¼šé™ä½å®ƒçš„ä¼˜å…ˆçº§ï¼Œä»¥ä¿è¯å®ƒä¸ä¼šè¿‡åˆ†äº‰æŠ¢èµ„æºã€‚</p><p>Linux å¹³å°ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼æ¥å½±å“çº¿ç¨‹çš„è°ƒåº¦ï¼š</p><ol><li>æ›´æ”¹çº¿ç¨‹ä¼˜å…ˆçº§</li><li>æ›´æ”¹ Android ä¸“æœ‰çš„æ§åˆ¶ç»„ <code>control group</code></li></ol><h5 id="ä¼˜å…ˆçº§"><a href="#ä¼˜å…ˆçº§" class="headerlink" title="ä¼˜å…ˆçº§"></a>ä¼˜å…ˆçº§</h5><p>çº¿ç¨‹çš„ä¼˜å…ˆçº§åœ¨ Linux ä¸­è¢«ç§°ä¸ºå‹å–„åº¦ <code>niceness</code> / <code>nicevalue</code> ï¼ŒæŒ‡çš„æ˜¯å½“å‰çº¿ç¨‹å¯¹å…¶ä»–çº¿ç¨‹çš„å‹å–„ç¨‹åº¦ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‹å–„åº¦è¶Šä½ï¼Œå³è¶Šä¸å‹å–„ï¼Œåˆ™ä¼˜å…ˆçº§è¶Šé«˜ã€‚åœ¨ Android ä¸­ï¼ŒLinux çº¿ç¨‹çš„å‹å–„åº¦ä»ä½åˆ°é«˜ä¸º -20 åˆ° 19ï¼Œé»˜è®¤å€¼ä¸º 0ã€‚</p><p>æŸä¸ªçº¿ç¨‹çš„ä¼˜å…ˆçº§ä¸åˆå§‹åŒ–è¯¥çº¿ç¨‹æ‰€åœ¨çš„çº¿ç¨‹ä¼˜å…ˆçº§ç›¸åŒï¼Œé™¤éå…¶è¢«ç³»ç»Ÿæ˜¾å¼ä¿®æ”¹ã€‚ä¸€ä¸ªåº”ç”¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼æ›´æ”¹çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼š</p><ul><li>java.lang.Thread</li></ul><pre><code class="java">// Java çº¿ç¨‹ä¼˜å…ˆçº§ï¼Œä» 0 åˆ° 10 ä¾æ¬¡é€’å¢setPriority(int priority);</code></pre><ul><li>android.os.Process</li></ul><pre><code class="java">Process.setThreadPriority(int priority);Process.setThreadPriority(int threadId, int priority);</code></pre><h5 id="æ§åˆ¶ç»„"><a href="#æ§åˆ¶ç»„" class="headerlink" title="æ§åˆ¶ç»„"></a>æ§åˆ¶ç»„</h5><p>Android å¹³å°ä¸æ˜¯å•çº¯ä¾èµ– Linux çš„ CFS è°ƒåº¦ç³»ç»Ÿçš„ï¼Œè¿˜å¯¹æ‰€æœ‰çš„çº¿ç¨‹è¿›è¡Œæ§åˆ¶ç»„æ§åˆ¶ã€‚æ‰€è°“æ§åˆ¶ç»„ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ª Linux å®¹å™¨ï¼Œè¯¥å®¹å™¨ç”¨æ¥ç®¡ç†å½“å‰å®¹å™¨ä¸­æ‰€æœ‰æ‰§è¡Œçº¿ç¨‹çš„å¤„ç†å™¨æ‰§è¡Œæ—¶é—´ã€‚ä¸€ä¸ªåº”ç”¨ä¸­åˆ›å»ºçš„æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šå±äºæŸä¸€ä¸ªæ§åˆ¶ç»„ã€‚</p><p>Android ç³»ç»Ÿä¸­å®šä¹‰äº†å¾ˆå¤šæ§åˆ¶ç»„ï¼Œä½†æ˜¯æœ€é‡è¦çš„æ˜¯å‰å°ç»„å’Œåå°ç»„ã€‚</p><p>å…¶ä¸­ï¼Œå‰å°ç»„ç›¸è¾ƒäºåå°ç»„ä¼šå¾—åˆ°æ›´å¤šçš„æ‰§è¡Œæœºä¼šï¼Œåå°ç»„ä¸­æ‰€æœ‰çš„çº¿ç¨‹åŠ ä¸€èµ·ï¼Œä¹Ÿå¾—ä¸åˆ°è¶…è¿‡ 10% çš„æ‰§è¡Œæ—¶é—´ï¼ŒAndroid ç³»ç»Ÿå°±æ˜¯åˆ©ç”¨è¿™ä¸ªç‰¹ç‚¹æ¥ä¿è¯å‰å°è¿›ç¨‹ä¼šå¾—åˆ°æ›´å¤šçš„æ‰§è¡Œæœºä¼šï¼Œä»è€Œä¿è¯æ€§èƒ½å’Œæ•ˆæœã€‚</p><p>å…·ä½“æŸä¸ªçº¿ç¨‹æ˜¯å¦å±•ç¤ºåœ¨å‰å°ï¼Œåˆ™ä¸å…¶æ‰€åœ¨è¿›ç¨‹çš„çº§åˆ«å’Œç±»å‹æœ‰å…³ç³»ï¼š</p><p><img src="http://p5zd0id9p.bkt.clouddn.com/18-8-30/70891310.jpg" alt=""></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œå¦‚æœæŸä¸ªè¿›ç¨‹æ‰§è¡Œåœ¨å‰å°é¡µé¢æˆ–è€…å…¶ä»–å‰å°è¿›ç¨‹ä¸­ï¼Œé‚£ä¹ˆè¯¥è¿›ç¨‹åˆ›å»ºçš„çº¿ç¨‹å°±ä¼šå±äºå‰å°ç»„ï¼ŒåŒæ—¶å¾—åˆ°ç»å¤§éƒ¨åˆ†çš„æ‰§è¡Œæ—¶é—´ï¼›è€Œå‰©ä¸‹çš„æ—¶é—´å°±ä¼šè¢«åˆ†é…ç»™åå°ç»„æ¥æ‰§è¡Œä»»åŠ¡ã€‚</p><p>å½“ç”¨æˆ·è¿›è¡Œåº”ç”¨åˆ‡æ¢æ“ä½œæ—¶ï¼ŒæŸä¸ªçº¿ç¨‹çš„æ§åˆ¶ç»„ä¹Ÿä¼šå®æ—¶è·Ÿç€æ›´æ–°ï¼šæŒ‰ä¸‹ Home é”®æ—¶ï¼ŒåŸæœ¬çš„å‰å°è¿›ç¨‹ä¼šé€€å±…åå°ï¼Œå…¶å†…éƒ¨çº¿ç¨‹ä¹Ÿä¼šè¿›å…¥åå°æ§åˆ¶ç»„ï¼›è€ŒåŸæ¥çš„åå°ç»„ä¹Ÿä¼šæ¥åˆ°å‰å°ï¼Œå æ®å¤§éƒ¨åˆ†çš„ cpu æ‰§è¡Œæ—¶é—´ã€‚</p><p>è¿™ç§æ–¹å¼æå¤§çš„æé«˜äº†å‰å°åº”ç”¨çš„æ‰§è¡Œæ•ˆç‡ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¹Ÿé™ä½äº†åå°åº”ç”¨æŠ¢å ç³»ç»Ÿèµ„æºçš„å¯èƒ½æ€§ï¼Œä»è€Œæé«˜åº”ç”¨çš„æ€§èƒ½ã€‚</p><p>å°½ç®¡æ§åˆ¶ç»„å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šé¿å…åå°åº”ç”¨è¿›ç¨‹è¿‡åˆ†æŠ¢å èµ„æºï¼Œä½†æ˜¯ç”¨æˆ·ä»ç„¶å¯ä»¥åœ¨åå°è¿›ç¨‹ä¸­åˆ›å»ºå¤§é‡çº¿ç¨‹æ¥å’Œ UI çº¿ç¨‹æŠ¢å  cpu èµ„æºã€‚ç”±äºå…¶åœ¨ä¸»çº¿ç¨‹åˆ›å»ºï¼Œæ‰€ä»¥é‚£äº›å­çº¿ç¨‹ä¸ UI çº¿ç¨‹æœ‰ç€åŒæ ·çš„ä¼˜å…ˆçº§å’Œæ§åˆ¶ç»„ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†çº¿ç¨‹ä¼šæå¤§çš„å¨èƒåˆ° UI çº¿ç¨‹çš„æ­£ç¡®æ‰§è¡Œã€‚å› æ­¤ï¼Œæœ‰æ—¶å€™ç”¨æˆ·åˆ›å»ºå¤§é‡çš„åå°è¿›ç¨‹æ¥å¤„ç†ä»»åŠ¡ï¼Œæœ¬æ„å¯èƒ½æ˜¯ä¸å½±å“ UI çº¿ç¨‹æ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯å¾ˆæœ‰å¯èƒ½ä¼šé€‚å¾—å…¶åã€‚</p><p>åƒæˆ‘ä»¬ä¹‹å‰è¯´åˆ°çš„ï¼Œå‰å°ç»„å’Œåå°ç»„æ˜¯æ ¹æ®å½“å‰åº”ç”¨æ˜¯å¦å¤„äºç”¨æˆ·å¯è§æ¥ç•Œå®šåˆ’åˆ†çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨æˆ·å¯è§çš„åº”ç”¨ç¨‹åºä¸­çš„åå°çº¿ç¨‹ï¼Œä¹Ÿæ˜¯å±äºå‰å°ç»„çš„ï¼Œä¼šè·å¾—å¤§éƒ¨åˆ†çš„æ‰§è¡Œæœºä¼šã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¤§é‡çš„åå°çº¿ç¨‹å°±ä¼šå½±å“åˆ° UI çº¿ç¨‹çš„å·¥ä½œï¼Œä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡å°†åå°çº¿ç¨‹ä¸å…¶åˆ›å»ºæ—¶çš„æ§åˆ¶ç»„ï¼Œä¹Ÿå°±æ˜¯ UI çº¿ç¨‹æ‰€åœ¨çš„æ§åˆ¶ç»„ï¼Œè¿›è¡Œè§£è€¦åˆ†ç¦»ã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥é€šè¿‡ç»™çº¿ç¨‹è®¾ç½®è¶³å¤Ÿä½çš„ä¼˜å…ˆçº§æ¥å®ç°ï¼Œè¿™æ ·ä¸€æ¥ï¼Œè¿™äº›åå°çº¿ç¨‹ä¼šæ°¸è¿œå±äºåå°æ§åˆ¶ç»„ï¼Œå³ä½¿æ˜¯å…¶æ‰€åœ¨çš„è¿›ç¨‹å½“å‰æ˜¯å¤„äºå‰å°ç•Œé¢å±•ç¤ºçš„ã€‚</p><pre><code class="java">// è¿™ä¸ªæ–¹æ³•ä¸ä½†å¯ä»¥é™ä½ä¼˜å…ˆçº§ï¼›// è¿˜èƒ½ä¿è¯å½“å‰çº¿ç¨‹ä¸è¿›ç¨‹è§£è€¦åˆ†ç¦»ï¼Œä¿è¯å…¶æ°¸è¿œå¤„äºåå°æ§åˆ¶ç»„Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</code></pre><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>Android ç³»ç»Ÿä¸­æ‰€æœ‰çš„çº¿ç¨‹ç±»å‹ï¼šUIï¼Œbinderï¼Œåå°ï¼Œæœ¬è´¨ä¸Šéƒ½å±äº Linux Posix çº¿ç¨‹ã€‚å…¶ä¸­ï¼ŒUI çº¿ç¨‹å’Œ binder çº¿ç¨‹æ˜¯åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºçš„ï¼Œåå°çº¿ç¨‹åˆ™å®Œå…¨æ˜¯å¼€å‘è€…æŒ‰éœ€åˆ›å»ºçš„ã€‚Android ä¸­æ‰€æœ‰çš„ç»„ä»¶ä»»åŠ¡éƒ½æ˜¯é»˜è®¤æ‰§è¡Œåœ¨ UI çº¿ç¨‹çš„ï¼Œä½†æ˜¯ä¸ºäº†é¿å…ç•Œé¢æ•ˆæœå¡é¡¿ä»¥åŠ ANR å¼‚å¸¸ï¼Œé•¿æ—¶é—´çš„è€—æ—¶æ“ä½œåº”è¯¥åœ¨åå°è¿›ç¨‹ä¸­æ‰§è¡Œã€‚å°½ç®¡ UI çº¿ç¨‹æ˜¯æœ€é‡è¦çš„æ‰§è¡Œçº¿ç¨‹ï¼Œä½†æ˜¯ç”±äºç³»ç»Ÿå¹¶ä¸çŸ¥é“è°æ˜¯ UI çº¿ç¨‹ï¼Œæ‰€ä»¥åº”è¯¥åœ¨å¼€å‘æ—¶å°±æ˜ç¡®æ³¨æ„ï¼Œä¸è¦è®©åå°çº¿ç¨‹å–§å®¾å¤ºä¸»ï¼Œæ‰°ä¹± UI çº¿ç¨‹çš„å·¥ä½œã€‚è¿™ä¸ªæ•ˆæœé€šå¸¸æ¥è®²æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼Œä¸€æ˜¯é™ä½ä¼˜å…ˆçº§ï¼ŒäºŒæ˜¯è®©ä¸æ˜¯é‚£ä¹ˆé‡è¦çš„åå°çº¿ç¨‹è¿›å…¥åå°æ§åˆ¶ç»„æ‰§è¡Œã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Efficient.Android.Threading ç¬¬ä¸‰ç« è¯»ä¹¦ç¬”è®°&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="http://joeljt.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Efficient.Android.Threading" scheme="http://joeljt.top/tags/Efficient-Android-Threading/"/>
    
  </entry>
  
  <entry>
    <title>Java ä¸­çš„å¤šçº¿ç¨‹</title>
    <link href="http://joeljt.top/2018/08/25/Efficient-Android-Threading-chapter-2/"/>
    <id>http://joeljt.top/2018/08/25/Efficient-Android-Threading-chapter-2/</id>
    <published>2018-08-24T16:00:00.000Z</published>
    <updated>2019-03-21T10:51:40.270Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Efficient.Android.Threading ç¬¬äºŒç« è¯»ä¹¦ç¬”è®°</p></blockquote><a id="more"></a><p>æ‰€æœ‰ Android åº”ç”¨éƒ½åº”è¯¥è¿›è¡Œå¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œå› ä¸ºå…¶å¯ä»¥å¤§å¹…åº¦çš„æé«˜åº”ç”¨çš„æ€§èƒ½ä»¥åŠå“åº”æ•ˆæœï¼›ä½†æ˜¯ä¹Ÿä¼šç”±æ­¤å¸¦æ¥ä¸€ç³»åˆ—çš„é—®é¢˜ï¼Œå¯¼è‡´ç¼–ç çš„è¿‡ç¨‹æ›´åŠ å¤æ‚ã€‚</p><ul><li>å¤„ç† Java å¹¶å‘</li><li>åœ¨å¤šä¸ªçº¿ç¨‹ä¸­ä¿è¯å…±äº«æ•°æ®çš„ç¨³å®šæ€§</li><li>å®šåˆ¶ä»¥åŠä¼˜åŒ–ä¸åŒçº¿ç¨‹çš„æ‰§è¡Œç­–ç•¥</li></ul><h3 id="çº¿ç¨‹åŸºç¡€"><a href="#çº¿ç¨‹åŸºç¡€" class="headerlink" title="çº¿ç¨‹åŸºç¡€"></a>çº¿ç¨‹åŸºç¡€</h3><p>çº¿ç¨‹ <code>thread</code> æ˜¯ CPU æœ€å°è°ƒåº¦å•å…ƒï¼Œä¸€èˆ¬æ¥è®²ï¼Œä¸€ä¸ªåº”ç”¨ä¸­çš„ä»»åŠ¡ä¼šæŒ‰ä»£ç é¡ºåºæ¥æ‰§è¡Œã€‚çº¿ç¨‹ä¸­å¾…æ‰§è¡Œçš„ä»£ç è¢«ç§°ä½œä»»åŠ¡ <code>task</code>ã€‚ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åªæ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥æŒ‰é¡ºåºæ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚</p><h4 id="çº¿ç¨‹çš„æ‰§è¡Œ"><a href="#çº¿ç¨‹çš„æ‰§è¡Œ" class="headerlink" title="çº¿ç¨‹çš„æ‰§è¡Œ"></a>çº¿ç¨‹çš„æ‰§è¡Œ</h4><p>Android åº”ç”¨ä¸­çš„å¸¸ç”¨çº¿ç¨‹å³ <code>java.lang.Thread</code>ï¼Œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸçš„é•¿åº¦å–å†³äºæ‰§è¡Œä»»åŠ¡çš„å¤§å°ä»¥åŠè€—æ—¶ã€‚</p><p>çº¿ç¨‹æ”¯æŒæ‰§è¡Œå®ç°äº† <code>java.lang.Runnable</code> æ¥å£çš„ä»»åŠ¡ï¼Œå…·ä½“çš„ä»»åŠ¡æ˜¯å®ç°åœ¨ <code>run</code> æ–¹æ³•ä¸­çš„ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><pre><code class="java">private class MyTask implements Runnable {     public void run() {        // åœ¨ run æ–¹æ³•ä¸­ç›´æ¥æˆ–é—´æ¥è°ƒç”¨åˆ°çš„æ‰€æœ‰å±€éƒ¨å˜é‡ï¼Œéƒ½å°†å­˜å‚¨åœ¨è¯¥çº¿ç¨‹æœ¬åœ°å†…å­˜å †æ ˆä¸­        int i = 0;     }}</code></pre><p>é€šè¿‡å®ä¾‹åŒ–å’Œå¯åŠ¨ Thread å¯¹è±¡ï¼Œæ¥å¯åŠ¨ä»»åŠ¡çš„æ‰§è¡Œï¼š</p><pre><code class="java">Thread thread = new Thread(new MyTask());thread.start();</code></pre><p>ä»æ“ä½œç³»ç»Ÿå±‚é¢æ¥è¯´ï¼Œçº¿ç¨‹åŒæ—¶å…·æœ‰æŒ‡ä»¤å’Œå †æ ˆæŒ‡é’ˆã€‚æŒ‡ä»¤æŒ‡é’ˆå¼•ç”¨è¦å¤„ç†çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œå †æ ˆæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªç§æœ‰å†…å­˜åŒºåŸŸï¼ˆå¯¹å…¶ä»–çº¿ç¨‹ä¸å¯è§ï¼‰ï¼Œè¯¥åŒºåŸŸç”¨äºå­˜å‚¨å½“å‰çº¿ç¨‹çš„æ•°æ®ã€‚å½“å‰çº¿ç¨‹çš„æ•°æ® <code>thread local data</code> ä¸€èˆ¬æŒ‡çš„æ˜¯åœ¨ Java æ–¹æ³•ä¸­å®šä¹‰çš„å˜é‡ä¿¡æ¯ã€‚</p><p>ä¸€èˆ¬æ¥è®²ï¼Œç³»ç»Ÿéƒ½å¸Œæœ›èƒ½å°† CPU æœ€å¤§é™åº¦çš„åˆ©ç”¨èµ·æ¥ï¼Œä½†çŸ›ç›¾çš„åœ°æ–¹åœ¨äºï¼ŒåŒä¸€ CPU åœ¨åŒä¸€æ—¶é—´åªèƒ½è¿è¡Œä¸€ä¸ªçº¿ç¨‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ºäº†è®©ç”¨æˆ·æ„ŸçŸ¥ä¸åŒçš„ç¨‹åºæ­£åœ¨åŒæ—¶è¿è¡Œï¼Œå°±å¿…é¡»è®© CPU å¿™èµ·æ¥ï¼Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¹‹é—´æ¥å›åˆ‡æ¢ï¼Œè¿›è¡Œä»»åŠ¡çš„æ‰§è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºçº¿ç¨‹çš„è°ƒåº¦<code>scheduler</code>ã€‚åœ¨ Java ä¸­ï¼Œçº¿ç¨‹è°ƒåº¦çš„åŸºå‡†æ˜¯çº¿ç¨‹çš„ä¼˜å…ˆçº§ <code>priority</code> ï¼Œä¼˜å…ˆçº§é»˜è®¤ä¸º 5ï¼ŒèŒƒå›´ä¸º 1-8 ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœçº¿ç¨‹çš„è°ƒåº¦æ˜¯å®Œå…¨åŸºäºä¼˜å…ˆçº§çš„è¯ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´ä½ä¼˜å…ˆçº§çš„çº¿ç¨‹ä»»åŠ¡æ°¸è¿œå¾—ä¸åˆ°æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„é¥¥é¥¿è‡´æ­»ã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJava è°ƒåº¦å™¨åœ¨æ‰§è¡Œçº¿ç¨‹è°ƒåº¦æ—¶ï¼Œè¿˜ä¼šå°†çº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´åˆ—å…¥è€ƒè™‘çš„èŒƒå›´ã€‚</p><p>æ¯æ¬¡ä¸åŒçº¿ç¨‹çš„åˆ‡æ¢è¢«ç§°ä¸ºä¸Šä¸‹æ–‡åˆ‡æ¢ <code>context switch</code> ã€‚æ¯æ¬¡è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶ï¼ŒCPU ä¼šå…ˆå°†å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹çŠ¶æ€è¿›è¡Œä¿å­˜ï¼Œä»¥æ–¹ä¾¿ä¸‹ä¸€æ¬¡æ¢å¤å½“å‰çº¿ç¨‹çš„æ‰§è¡Œï¼›å…¶åæš‚åœå½“å‰çº¿ç¨‹ï¼ŒåŒæ—¶æ¢å¤å¦ä¸€çº¿ç¨‹çš„æ‰§è¡Œã€‚</p><p>å…·ä½“çš„çº¿ç¨‹è°ƒåº¦å¯ä»¥é€šè¿‡ä¸‹å›¾è¿›è¡Œç†è§£ï¼Œå›¾ä¸­çš„ C å°±æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢çš„è¿‡ç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190321182552.jpg" alt="çº¿ç¨‹è°ƒåº¦ç¤ºä¾‹"></p><h4 id="å•çº¿ç¨‹åº”ç”¨"><a href="#å•çº¿ç¨‹åº”ç”¨" class="headerlink" title="å•çº¿ç¨‹åº”ç”¨"></a>å•çº¿ç¨‹åº”ç”¨</h4><p>æ¯ä¸ªåº”ç”¨è‡³å°‘ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„ä¸»çº¿ç¨‹ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç¼–å†™çš„ä»£ç éƒ½å°†åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­è¿›è¡Œæ‰§è¡Œã€‚</p><p>å•çº¿ç¨‹ç¼–ç¨‹æ˜¯æœ€ç®€å•çš„ç¼–ç æ–¹å¼ï¼Œä½†æ˜¯å¾ˆå¤šæƒ…å†µä¸‹è¿™ç§æ–¹å¼å¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å°±éœ€è¦å°†ä»£ç åˆ†åˆ«è¿è¡Œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­ï¼Œä»è€Œä¿è¯ä»£ç æ‰§è¡Œçš„é«˜æ•ˆæ€§ä»¥åŠç¨‹åºçš„æ€§èƒ½ã€‚</p><h4 id="å¤šçº¿ç¨‹åº”ç”¨"><a href="#å¤šçº¿ç¨‹åº”ç”¨" class="headerlink" title="å¤šçº¿ç¨‹åº”ç”¨"></a>å¤šçº¿ç¨‹åº”ç”¨</h4><p>å¦‚æœæ‰§è¡Œçº¿ç¨‹çš„æ•°é‡è¶…è¿‡å¤„ç†å™¨æ•°é‡ï¼Œåˆ™æ— æ³•å®ç°çœŸæ­£çš„å¹¶å‘ï¼Œä½†è°ƒåº¦ç¨‹åºåœ¨è¦å¤„ç†çš„çº¿ç¨‹ä¹‹é—´å¿«é€Ÿåˆ‡æ¢ï¼Œä»¥ä¾¿å°†æ¯ä¸ªä»£ç è·¯å¾„æ‹†åˆ†ä¸ºæŒ‰é¡ºåºå¤„ç†çš„æ‰§è¡Œé—´éš”ã€‚å°½ç®¡å¤šçº¿ç¨‹ç¼–ç¨‹ä¼šæå¤§çš„æé«˜åº”ç”¨çš„æ€§èƒ½ï¼Œä½†æ˜¯è¿™æ˜¯æœ‰ä¸€å®šä»£ä»·çš„ã€‚å…·ä½“è¡¨ç°ä¸ºï¼šå¤æ‚æ€§çš„æé«˜ï¼Œå†…å­˜å¼€é”€çš„å¢åŠ ï¼Œä¸ç¡®å®šçš„æ‰§è¡Œé¡ºåºç­‰ã€‚</p><h5 id="å¤æ‚æ€§æé«˜ï¼Œä¸ç¡®å®šçš„æ‰§è¡Œé¡ºåº"><a href="#å¤æ‚æ€§æé«˜ï¼Œä¸ç¡®å®šçš„æ‰§è¡Œé¡ºåº" class="headerlink" title="å¤æ‚æ€§æé«˜ï¼Œä¸ç¡®å®šçš„æ‰§è¡Œé¡ºåº"></a>å¤æ‚æ€§æé«˜ï¼Œä¸ç¡®å®šçš„æ‰§è¡Œé¡ºåº</h5><p>åˆ†æå•çº¿ç¨‹åº”ç”¨ç¨‹åºçš„æ‰§è¡Œç›¸å¯¹ç®€å•ï¼Œå› ä¸ºæ‰§è¡Œé¡ºåºæ˜¯å·²çŸ¥çš„ã€‚åœ¨å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºä¸­ï¼Œåˆ†æç¨‹åºå¦‚ä½•æ‰§è¡Œä»¥åŠä»£ç ä»¥ä½•ç§é¡ºåºå¤„ç†è¦å›°éš¾å¾—å¤šã€‚æ‰§è¡Œé¡ºåºåœ¨çº¿ç¨‹ä¹‹é—´æ˜¯ä¸ç¡®å®šçš„ï¼Œå› ä¸ºè°ƒåº¦å™¨å°†å¦‚ä½•åˆ†é…æ‰§è¡Œæ—¶é—´ç»™çº¿ç¨‹æ˜¯æœªçŸ¥çš„ã€‚å› æ­¤ï¼Œå¤šçº¿ç¨‹çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯ä¸ç¡®å®šçš„ã€‚è¿™ç§ä¸ç¡®å®šæ€§ä¸ä»…ä½¿ä»£ç ä¸­çš„é”™è¯¯è°ƒè¯•å˜å¾—æ›´åŠ å›°éš¾ï¼Œè€Œä¸”åè°ƒçº¿ç¨‹çš„è¿‡ç¨‹ä¸­ä¹Ÿæœ‰å¾ˆå¤§å¯èƒ½ä¼šå¼•å…¥æ–°çš„é”™è¯¯ã€‚</p><h5 id="èµ„æºå¼€é”€çš„å¢åŠ "><a href="#èµ„æºå¼€é”€çš„å¢åŠ " class="headerlink" title="èµ„æºå¼€é”€çš„å¢åŠ "></a>èµ„æºå¼€é”€çš„å¢åŠ </h5><p>çº¿ç¨‹åœ¨å†…å­˜å’Œå¤„ç†å™¨ä½¿ç”¨æ–¹é¢å…·æœ‰å¼€é”€ã€‚ä¹‹å‰æåˆ°è¿‡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šç”³è¯·ä¸€å—ç§æœ‰å†…å­˜åŒºåŸŸï¼Œç”¨æ¥å­˜å‚¨çº¿ç¨‹æ•°æ®ã€‚è¿™ç‰‡ç§æœ‰å†…å­˜åœ¨çº¿ç¨‹åˆ›å»ºä¹‹åˆå°±ä¼šç”³è¯·å‡ºæ¥å¤‡ç”¨ï¼Œç›´åˆ°çº¿ç¨‹ç»ˆæ­¢æ‰ä¼šè¢«å›æ”¶å¹¶é‡æ–°åˆ†é…ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œåªè¦å½“å‰çº¿ç¨‹æ˜¯å­˜æ´»çš„ï¼Œå³ä¾¿å®ƒæ˜¯é—²ç½®æˆ–æ˜¯é˜»å¡çŠ¶æ€ï¼Œä¹Ÿä¼šæŒç»­å ç”¨ç³»ç»Ÿèµ„æºã€‚</p><p>å¤„ç†å™¨çš„å¼€é”€ä¸»è¦æ¥è‡ªäºåˆå§‹åŒ–ã€å›æ”¶çº¿ç¨‹ï¼Œä»¥åŠåœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸­å­˜å‚¨å’Œæ¢å¤çº¿ç¨‹ã€‚æ‰§è¡Œçš„çº¿ç¨‹è¶Šå¤šï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å°±è¶Šå¤šï¼Œæ€§èƒ½å°±è¶Šå·®ã€‚</p><h5 id="æ•°æ®ä¸ä¸€è‡´"><a href="#æ•°æ®ä¸ä¸€è‡´" class="headerlink" title="æ•°æ®ä¸ä¸€è‡´"></a>æ•°æ®ä¸ä¸€è‡´</h5><p>å¤šçº¿ç¨‹ç¨‹åºå¯¹èµ„æºçš„è®¿é—®è¿˜ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œå°±æ˜¯æ•°æ®çš„å…±äº«ã€‚å¦‚æœä¸¤ä¸ªæˆ–æ›´å¤šçº¿ç¨‹åŒæ—¶æ“ä½œæŸä¸€ä¸ªæ•°æ®ï¼Œåˆ™æˆ‘ä»¬æ— æ³•ç¡®å®šå“ªä¸ªçº¿ç¨‹æ­£åœ¨å¯¹è¿™ä¸ªæ•°æ®è¿›è¡Œä»€ä¹ˆæ ·çš„æ“ä½œï¼Œè¿™å°±å¯¼è‡´äº†æœ€åæ•°æ®çš„ä¸å¯é æ€§ã€‚</p><p>å› ä¸ºä¸Šä¸‹æ–‡åˆ‡æ¢å¯èƒ½å‘ç”Ÿåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ä¸åº”ä¸­æ–­çš„ä½ç½®(æ¯”å¦‚æ­£åœ¨å¯¹æŸä¸ªå…³é”®æ€§æ•°æ®è¿›è¡Œæ“ä½œæ—¶ï¼‰ï¼Œæ‰€ä»¥å¿…é¡»åˆ›å»ºä»£ç æŒ‡ä»¤çš„åŸå­åŒºåŸŸ <code>atomic region</code>ã€‚å¦‚æœçº¿ç¨‹åœ¨åŸå­åŒºåŸŸä¸­æ‰§è¡Œï¼Œåˆ™å…¶ä»–çº¿ç¨‹å°†è¢«é˜»å¡ï¼Œç›´åˆ°åœ¨åŸå­åŒºåŸŸä¸­æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ‰§è¡Œã€‚å› æ­¤ï¼ŒJavaä¸­çš„åŸå­åŒºè¢«è®¤ä¸ºæ˜¯äº’æ–¥çš„ï¼Œå› ä¸ºå®ƒåªå…è®¸è®¿é—®ä¸€ä¸ªçº¿ç¨‹ã€‚</p><p>å¯ä»¥ç”¨ä¸åŒçš„æ–¹å¼åˆ›å»ºåŸå­åŒºåŸŸ  <code>atomic region</code>ï¼Œä½†æ˜¯æœ€åŸºæœ¬çš„åŒæ­¥æœºåˆ¶æ˜¯ <code>synchronized</code> å…³é”®å­— ï¼š</p><pre><code class="java">synchronized (this) {     sharedResource++;}</code></pre><p>å¦‚æœå¯¹å…±äº«èµ„æºçš„æ¯æ¬¡è®¿é—®éƒ½æ˜¯åŒæ­¥çš„ï¼Œé‚£ä¹ˆå°½ç®¡å¤šçº¿ç¨‹è®¿é—®ï¼Œæ•°æ®ä¹Ÿéƒ½å°†æ˜¯ä¸€è‡´çš„ã€‚</p><h3 id="çº¿ç¨‹å®‰å…¨"><a href="#çº¿ç¨‹å®‰å…¨" class="headerlink" title="çº¿ç¨‹å®‰å…¨"></a>çº¿ç¨‹å®‰å…¨</h3><p>åœ¨å¤šçº¿ç¨‹åº”ç”¨ä¸­ï¼Œå…±äº«èµ„æºæœ‰å¯èƒ½ä¼šè¢«å¤šæ–¹åŒæ—¶è®¿é—®ï¼ŒåŒæ—¶è¯»å†™ï¼Œè¿™å°±å¯¼è‡´äº†æ•°æ®çš„ä¸å¯é æ€§ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦é€šè¿‡ä½¿ç”¨é”å®šæœºåˆ¶æ¥å®ç°åŒæ­¥ã€‚</p><p>Android ä¸­çš„é”å®šæœºåˆ¶ä¸»è¦åŒ…æ‹¬ä¸¤ç§ï¼š</p><ul><li><p>å¯¹è±¡å†…åœ¨é”å®š</p><p><code>synchronized</code> å…³é”®å­—</p></li><li><p>æ˜¾å¼é”</p><p><code>java.util.concurrent.locks.ReentrantLock</code><br><code>java.util.concurrent.locks.ReentrantReadWriteLock</code></p></li></ul><h4 id="å†…åœ¨é”å’ŒJavaç›‘è§†å™¨"><a href="#å†…åœ¨é”å’ŒJavaç›‘è§†å™¨" class="headerlink" title="å†…åœ¨é”å’ŒJavaç›‘è§†å™¨"></a>å†…åœ¨é”å’ŒJavaç›‘è§†å™¨</h4><p><code>synchronized</code> å…³é”®å­—é€‚ç”¨äºæ¯ä¸ª Java å¯¹è±¡ï¼Œå…¶å†…éƒ¨åŒ…å«ä¸€ä¸ªéšå¼å¯ç”¨çš„é”ã€‚å†…éƒ¨é”æ˜¯äº’æ–¥çš„ï¼Œè¿™æ„å‘³ç€åŒæ­¥å…³é”®å­—çš„ä»£ç åŒºåŸŸï¼ˆä¸´ç•ŒåŒºï¼‰ä¸­çš„çº¿ç¨‹æ‰§è¡Œæ˜¯æŸä¸€ä¸ªçº¿ç¨‹ç‹¬å çš„ã€‚å½“ä¸´ç•ŒåŒºè¢«å ç”¨æ—¶ï¼Œå…¶ä»–çº¿ç¨‹åˆ™ä¼šå¤„äºé˜»å¡çŠ¶æ€ï¼Œåœ¨åŒæ­¥é”é‡Šæ”¾å‰ï¼Œè¯¥çº¿ç¨‹ä»£ç æ— æ³•ç»§ç»­æ­£å¸¸æ‰§è¡Œã€‚</p><p>å†…åœ¨é”å……å½“ä¸€ä¸ªç›‘è§†å™¨çš„è§’è‰²ï¼Œè¯¥ç›‘è§†å™¨æœ‰ä¸‰ç§çŠ¶æ€ï¼š</p><ol><li><p>é˜»å¡çŠ¶æ€ <code>Blocked</code></p><p>å½“å‰çº¿ç¨‹è¦ç­‰å¾…æ­£åœ¨è¢«å…¶ä»–çº¿ç¨‹å ç”¨çš„å†…åœ¨é”ï¼Œä»è€Œå¤„äºæŒ‚èµ·çŠ¶æ€ï¼›</p></li><li><p>è¿è¡ŒçŠ¶æ€ <code>Executing</code></p><p>å½“å‰çº¿ç¨‹å”¯ä¸€å æ®å†…éƒ¨é”å¹¶ä¸”æ­£åœ¨ä¸´ç•ŒåŒºå†…æ‰§è¡Œä»£ç ï¼›</p></li><li><p>ç­‰å¾…çŠ¶æ€ <code>Waiting</code></p><p>å½“å‰çº¿ç¨‹åˆšåˆšå°†ä¸´ç•ŒåŒºä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œä¸»åŠ¨é‡Šæ”¾äº†é”ï¼›å¹¶ç­‰å¾…ä¸‹æ¬¡è·å–å†…éƒ¨é”ï¼›</p></li></ol><p><img src="https://raw.githubusercontent.com/Joeljt/BlogImage/master/20190321182549.jpg" alt="Javaç›‘è§†å™¨ç¤ºä¾‹"></p><p>ä¸€ä¸ªå®Œæ•´çš„çº¿ç¨‹é”å·¥ä½œæµå¤§ä½“å¦‚ä¸‹ï¼š</p><ol><li><p><code>Enter the monitor</code></p><p>æŸä¸ªçº¿ç¨‹å°è¯•å»æ“ä½œè¢«åŒæ­¥é”é”ä½çš„çš„ä»£ç ç‰‡æ®µï¼Œæ­¤æ—¶è¯¥çº¿ç¨‹è¿›å…¥ Java ç›‘è§†å™¨ä¸­ï¼Œå¦‚æœå½“å‰åŒæ­¥é”è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œåˆ™å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼›</p></li><li><p><code>Acquire the lock</code></p><p>å¦‚æœå½“å‰åŒæ­¥é”å¤„äºç©ºé—²çŠ¶æ€ï¼Œåˆ™é˜»å¡çŠ¶æ€çš„çº¿ç¨‹åˆ™å¯ä»¥è·å–é”ï¼Œå¹¶è¿›å…¥åŒæ­¥ä»£ç å—å¼€å§‹æ‰§è¡Œã€‚å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œåˆ™ç”±è°ƒåº¦å™¨å†³å®šè°å°†è·å–é”ï¼Œè€Œå¹¶ä¸æ˜¯å…ˆæ¥ååˆ°çš„ï¼›</p></li><li><p><code>Release the lock and wait</code></p><p>æ»¡è¶³æŸç§æ¡ä»¶åï¼ŒæŒæœ‰é”å¯¹è±¡çš„çº¿ç¨‹ä¼šä¸»åŠ¨è°ƒç”¨é”å¯¹è±¡çš„ <code>Object.wait()</code> å°†é”èµ„æºé‡Šæ”¾ï¼Œç„¶åç­‰å¾…æ»¡è¶³æŸç§æ¡ä»¶åï¼Œé‡æ–°è·å–æ‰§è¡Œæƒï¼›</p></li><li><p><code>Acquire the lock after signal</code></p><p>å¦‚æœæŸä¸ªç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹è¢«è°ƒåº¦å™¨é€‰æ‹©ä¸ºä¸‹ä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ï¼Œåˆ™å®ƒä¼šåœ¨å…¶ä»–çº¿ç¨‹è°ƒç”¨ <code>Object.notify()</code> æˆ–è€… <code>Objecct.notifyAll()</code> æ—¶ï¼Œè·å¾—åŒæ­¥é”å¹¶è¿›å…¥åŒæ­¥ä»£ç å—ï¼›éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç­‰å¾…çº¿ç¨‹ç›¸æ¯”è¾ƒäºé˜»å¡çº¿ç¨‹å¹¶æ²¡æœ‰ç»å¯¹çš„ä¼˜å…ˆæƒï¼Œå› ä¸ºäºŒè€…éƒ½æƒ³æ‰§è¡Œè¿™éƒ¨åˆ†åŒæ­¥ä»£ç ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€ç»ˆçš„é€‰æ‹©æƒåœ¨äºè°ƒåº¦å™¨ï¼›</p></li><li><p><code>Release the lock and exit the monitor</code></p><p>åœ¨ä»£ç æ‰§è¡Œå®Œæ¯•åï¼Œçº¿ç¨‹ä¼šé€€å‡ºç›‘è§†å™¨ï¼Œè®©å…¶ä»–çœŸæ­£æœ‰éœ€è¦çš„çº¿ç¨‹åšæ“ä½œã€‚</p></li></ol><p>å…·ä½“çš„åŒæ­¥ä»£ç å—ç¤ºä¾‹ï¼š</p><pre><code class="java">// (1) synchronized (this) {     // Execute code (2)     wait(); // (3)    // Execute code (4)} // (5)</code></pre><h4 id="åŒæ­¥å¯¹å…±äº«èµ„æºçš„è®¿é—®"><a href="#åŒæ­¥å¯¹å…±äº«èµ„æºçš„è®¿é—®" class="headerlink" title="åŒæ­¥å¯¹å…±äº«èµ„æºçš„è®¿é—®"></a>åŒæ­¥å¯¹å…±äº«èµ„æºçš„è®¿é—®</h4><p>åœ¨å¤šçº¿ç¨‹åº”ç”¨ä¸­ï¼Œå…±äº«èµ„æºå¯èƒ½è¢«å¤šæ–¹åŒæ—¶è·å–åŠä¿®æ”¹ï¼Œè¿™ç§æƒ…å†µä¸‹å°±éœ€è¦æœ‰ä¸€ä¸ªæœ‰æ•ˆçš„åŒæ­¥æœºåˆ¶ï¼Œæ¥ä¿è¯å¤šçº¿ç¨‹ä¸‹æ•°æ®çš„ç»Ÿä¸€æ€§ã€‚è¿™ç§æœºåˆ¶å…·ä½“åŒ…æ‹¬åŒæ­¥é”ç±»å‹çš„é€‰æ‹©ï¼Œä»¥åŠåŒæ­¥ä»£ç å—èŒƒå›´çš„è®¾å®šã€‚</p><h5 id="ä½¿ç”¨å†…éƒ¨é”"><a href="#ä½¿ç”¨å†…éƒ¨é”" class="headerlink" title="ä½¿ç”¨å†…éƒ¨é”"></a>ä½¿ç”¨å†…éƒ¨é”</h5><p><code>synchronized</code> å…³é”®å­—æœ‰å¤šç§ä½¿ç”¨æ–¹å¼ï¼š</p><ul><li><p>ä½œç”¨åœ¨æ–¹æ³•ä¸Š</p><pre><code class="java">synchronized void changeState() {     sharedResource++;}</code></pre></li><li><p>åŒæ­¥ä»£ç å—ï¼Œä½¿ç”¨å½“å‰ç±»ä½œä¸ºåŒæ­¥é”</p><pre><code class="java">void changeState() {     synchronized(this) {        sharedResource++;    }}</code></pre></li><li><p>åŒæ­¥ä»£ç å—ï¼Œä½¿ç”¨å…¶ä»–å¯¹è±¡ä½œä¸ºåŒæ­¥é”</p><pre><code class="java">private final Object mLock = new Object();void changeState() {     synchronized(mLock) {        sharedResource++;    } }</code></pre></li><li><p>ä½œç”¨äºé™æ€æ–¹æ³•</p><pre><code class="java">synchronized static void changeState() {     staticSharedResource++;}</code></pre></li><li><p>é™æ€æ–¹æ³•çš„åŒæ­¥ä»£ç å—ï¼Œä½¿ç”¨å½“å‰ç±»ä½œä¸ºåŒæ­¥é”</p><pre><code class="java">static void changeState() {     synchronized(this.getClass()) {        staticSharedResource++;    }}</code></pre></li></ul><p>ä½¿ç”¨ this åœ¨ä»£ç å—å†…ä½œä¸ºåŒæ­¥é”ï¼Œä¸ç›´æ¥åœ¨æ–¹æ³•ä¸ŠåŠ  <code>synchronized</code> å…³é”®å­—æ˜¯ç›¸åŒçš„ã€‚ä½†æ˜¯æ›´å»ºè®®ä½¿ç”¨åŒæ­¥ä»£ç å—ï¼Œå› ä¸ºä¸ä¸€å®šæ–¹æ³•å†…çš„å…¨éƒ¨ä»£ç éƒ½éœ€è¦ä¿è¯åŒæ­¥ï¼Œæ»¥ç”¨åŒæ­¥æœ‰å¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„æ€§èƒ½æŸè€—ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä½œç”¨äºé™æ€æ–¹æ³•çš„åŒæ­¥é”å¯¹è±¡æ˜¯å½“å‰ Class ç±»å¯¹è±¡ï¼Œè€Œå¹¶éå…¶å®ä¾‹å¯¹è±¡ã€‚</p><h5 id="ä½¿ç”¨æ˜¾å¼é”æœºåˆ¶"><a href="#ä½¿ç”¨æ˜¾å¼é”æœºåˆ¶" class="headerlink" title="ä½¿ç”¨æ˜¾å¼é”æœºåˆ¶"></a>ä½¿ç”¨æ˜¾å¼é”æœºåˆ¶</h5><p><code>ReentrantLock</code> å’Œ <code>ReentrantReadWriteLock</code> ç±»å¯ä»¥ç”¨æ¥æ›¿ä»£ <code>synchronized</code> å…³é”®å­—å……å½“ç›‘è§†å™¨ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒåŒæ­¥ä»£ç å—çš„é”å®šå’Œè§£é”éƒ½æ˜¯ç”±è°ƒç”¨è€…æ‰‹åŠ¨è°ƒç”¨çš„ã€‚</p><pre><code class="java">// ReentrantLock æ˜¾å¼é”è°ƒç”¨ç¤ºä¾‹int sharedResource;private ReentrantLock mLock = new ReentrantLock();public void changeState(){    mLock.lock();    try{        sharedResource ++;    }    finally{        mLock.unlock();    }}</code></pre><p><code>ReentrantLock</code> å’Œ <code>synchronized</code> å…³é”®å­—è¯­ä¹‰ç›¸åŒï¼Œéƒ½ä¼šå°†åŒæ­¥ä»£ç å—éš”ç¦»å¼€ï¼Œä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿå¯¹å…¶è¿›è¡Œæ“ä½œã€‚äºŒè€…éƒ½æ˜¯ä¸€ç§é˜²å¾¡æ€§ç­–ç•¥ï¼Œå‡è®¾æ‰€æœ‰å¹¶å‘è®¿é—®éƒ½å­˜åœ¨é—®é¢˜ï¼Œä½†å¤šçº¿ç¨‹åŒæ—¶è¯»å–å…±äº«å˜é‡å¹¶ä¸æ˜¯æœ‰å®³çš„ã€‚å› æ­¤ï¼Œsynchronized å’Œ ReentrantLock å¯èƒ½å­˜åœ¨è¿‡åº¦ä¿æŠ¤ã€‚</p><p><code>ReentrantReadWriteLock</code> åˆ™å…è®¸å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«æ•°æ®åŒæ—¶è¿›è¡Œè¯»å–ï¼Œä½†æ˜¯ä»ç„¶ç¦æ­¢åŒæ—¶è¯»å†™æˆ–è€…åŒæ—¶å†™å…¥ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="java">// ReentrantReadWriteLock æ˜¾å¼é”è°ƒç”¨ç¤ºä¾‹int sharedResource;private ReentrantReadWriteLock mLock = new ReentrantReadWriteLock();public void changeState() {     mLock.writeLock().lock();     try {        sharedResource++;    }    finally{        mLock.unlock();    }}public int readState(){    mLock.readLock().lock();    try{        return sharedResource;    }    finally{        mLock.readLock().unlock();    }}</code></pre><p><code>ReentrantReadWriteLock</code> ç›¸å¯¹å¤æ‚ï¼Œä»è€Œä¼šå¯¹æ€§èƒ½é€ æˆå½±å“ã€‚å› ä¸ºç›¸å¯¹äº <code>ReentrantLock</code> å’Œ <code>synchronized</code> æ¥è®²ï¼Œ<code>ReentrantReadWriteLock</code> è¦èŠ±è´¹æ›´å¤šçš„æ—¶é—´å»åˆ¤æ–­åº”ä¸åº”è¯¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œè¿™ä¹Ÿç›¸å½“äºæ˜¯è®©è¯»å–æ“ä½œåŒæ­¥æ‰§è¡Œçš„ä¸€ç§å¦¥åã€‚å®é™…ä¸Šï¼Œ<code>ReentrantReadWriteLock</code> çš„å…¸å‹åº”ç”¨åº”è¯¥æ˜¯å¤šä¸ªçº¿ç¨‹è¿›è¡Œè¯»å–ï¼Œä½†åªæœ‰å°‘é‡çº¿ç¨‹ä¼šè¿›è¡Œå†™å…¥æ“ä½œã€‚</p><h4 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</h4><p>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ˜¯çº¿ç¨‹åä½œçš„ç»å…¸æ¨¡å‹ï¼Œç”Ÿäº§è€…çº¿ç¨‹å’Œæ¶ˆè´¹è€…çº¿ç¨‹å…±äº«ä¸€ä¸ªåˆ—è¡¨ï¼Œå½“è¯¥åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œç”Ÿäº§è€…çº¿ç¨‹å‘å…¶ä¸­æ·»åŠ å•†å“ï¼›å¦‚æœåˆ—è¡¨ä¸ä¸ºç©ºï¼Œåˆ™æ¶ˆè´¹è€…çº¿ç¨‹ä¼šå°†å•†å“ç§»é™¤ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹åº”è¯¥é˜»å¡ç­‰å¾…ï¼›å½“åˆ—è¡¨å·²æ»¡æ—¶ï¼Œç”Ÿäº§è€…çº¿ç¨‹åº”è¯¥é˜»å¡ç­‰å¾…ã€‚</p><p><code>ComsumerProducer</code> ç±»åŒ…æ‹¬ä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªç”Ÿäº§è€…çº¿ç¨‹ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ï¼ŒäºŒè€…å…±äº«ä¸€ä¸ª LinkedList å¯¹è±¡ï¼Œåˆ†åˆ«å¯¹å…¶è¿›è¡Œå¢åŠ å’Œåˆ é™¤æ“ä½œï¼š</p><pre><code class="java">public class ConsumerProducer{    private LinkedList&lt;Integer&gt; list = new LinkedList&lt;&gt;();    private final int LIMIT = 10;    private Object lock = new Object();    public void produce(){        int value = 0;        while(true){            synchronized(lock){                while(list.size() == LIMIT){                    lock.wait();                }                list.add(value++);                lock.notify();            }        }    }    public void consume(){        int value = 0;        while(true){            synchronized(lock){                while(list.size() == 0){                    lock.wait();                }                list.removeFirst();                lock.notify();            }        }    } }</code></pre><p>ç”Ÿäº§è€…çº¿ç¨‹å’Œæ¶ˆè´¹è€…çº¿ç¨‹å…±ç”¨åŒä¸€æŠŠé”ï¼Œæ¥ä¿è¯å…±äº«æ•°æ® list çš„ä¸€è‡´æ€§ã€‚å½“åˆ—è¡¨ä¸ºæ»¡æ—¶ï¼Œç”Ÿäº§è€…ä¸»åŠ¨æŒ‚èµ·ç­‰å¾…ï¼›å½“åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œæ¶ˆè´¹è€…ä¸»åŠ¨æŒ‚èµ·ç­‰å¾…ã€‚ä¸¤ä¸ªçº¿ç¨‹åœ¨æŒ‚èµ·çš„åŒæ—¶ï¼Œåˆä¼šè°ƒç”¨ <code>lock.notify()</code> ç»™æ­£åœ¨ç­‰å¾…çš„å¯¹æ–¹å‘é€ä¿¡å·ï¼Œé€šçŸ¥å…¶è·å–åŒæ­¥é”å¹¶æ‰§è¡Œä»£ç ï¼Œä»è€Œå®Œæˆå…±äº«æ•°æ®çš„åŒæ­¥ã€‚</p><pre><code class="java">final ConsumerProducer cp = new ConsumerProducer();// producernew Thread(new Runnable(){    @Override    public void run(){        cp.produce();    }}).start();// consumernew Thread(new Runnable(){    @Override    public void run(){        cp.consume();    }}).start();</code></pre><h4 id="ä»»åŠ¡æ‰§è¡Œç­–ç•¥"><a href="#ä»»åŠ¡æ‰§è¡Œç­–ç•¥" class="headerlink" title="ä»»åŠ¡æ‰§è¡Œç­–ç•¥"></a>ä»»åŠ¡æ‰§è¡Œç­–ç•¥</h4><p>ä¸€èˆ¬æ¥è®²ï¼Œä¸¤ç§æç«¯çš„æ‰§è¡Œç­–ç•¥å¦‚ä¸‹ï¼š</p><ol><li>æ‰€æœ‰çš„ä»»åŠ¡éƒ½æ‰§è¡Œåœ¨åŒä¸€çº¿ç¨‹ä¸Š</li><li>æ¯ä¸€ä¸ªä»»åŠ¡éƒ½å¯¹åº”ä¸€ä¸ªçº¿ç¨‹</li></ol><p>å¾ˆæ˜æ˜¾ä¸Šè¿°ä¸¤ç§ç­–ç•¥éƒ½è¿‡äºæç«¯ï¼šå‰è€…æ•ˆç‡è¿‡ä½ï¼Œåè€…å¤§é‡çš„çº¿ç¨‹åˆå§‹åŒ–å’Œå›æ”¶ä¼šé€ æˆå¤§é‡çš„æ€§èƒ½æ¶ˆè€—ã€‚å°½ç®¡å¦‚æ­¤ï¼Œä¸Šè¿°ä¸¤ç§ç­–ç•¥è¿˜æ˜¯ç›®å‰æœ€å¸¸ç”¨çš„ä¸¤ç§æ‰§è¡Œæ–¹å¼ï¼š</p><ol><li><p>é¡ºåºæ‰§è¡Œ</p><p>å„ä¸ªä»»åŠ¡æŒ‰ç…§å…ˆåé¡ºåºè¿›è¡Œæ‰§è¡Œï¼Œå„ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ä¸ä¼šæœ‰é‡å ã€‚è¿™æ ·åšçš„ä¼˜åŠ¿æ˜¯æ•°æ®ç»å¯¹å®‰å…¨ï¼Œè€Œä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œå ç”¨å†…å­˜ä¼šæ¯”å¤šçº¿ç¨‹æ›´å°‘ï¼›ç¼ºç‚¹åœ¨äºååé‡è¿‡ä½ï¼Œä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œä¸å¦å–å†³äºå‰ä¸€ä¸ªä»»åŠ¡èƒ½å¦æˆåŠŸå®Œæˆï¼›</p></li><li><p>å¹¶å‘æ‰§è¡Œ</p><p>æ‰€æœ‰çš„ä»»åŠ¡éƒ½å¹¶è¡Œæ‰§è¡Œï¼Œæœ€å¤§åŒ–åˆ©ç”¨ CPU ï¼Œä½†æ˜¯ä¼šå¸¦æ¥æ•°æ®çš„ä¸å®‰å…¨æ€§ï¼Œéœ€è¦è¿›è¡ŒåŒæ­¥æœºåˆ¶è§„é¿ã€‚</p></li></ol><p>ä¸€ä¸ªå‡ºè‰²çš„æ‰§è¡Œç­–ç•¥åº”è¯¥æ˜¯é¡ºåºæ‰§è¡Œå’Œå¹¶å‘æ‰§è¡Œå¹¶é‡çš„ã€‚ç›¸å¯¹ç‹¬ç«‹çš„ä»»åŠ¡åº”è¯¥å¹¶å‘æ‰§è¡Œä»¥æé«˜æ•ˆç‡ï¼Œä½†æ˜¯æœ‰ç›¸å¯¹ä¸¥æ ¼æ‰§è¡Œé¡ºåºçš„ä»»åŠ¡åˆ™åº”è¯¥æ‰§è¡Œåœ¨å•ä¸€çº¿ç¨‹ä¸­ã€‚</p><h5 id="å¹¶å‘æ‰§è¡Œè®¾è®¡åŸåˆ™"><a href="#å¹¶å‘æ‰§è¡Œè®¾è®¡åŸåˆ™" class="headerlink" title="å¹¶å‘æ‰§è¡Œè®¾è®¡åŸåˆ™"></a>å¹¶å‘æ‰§è¡Œè®¾è®¡åŸåˆ™</h5><ul><li>æ§åˆ¶æ–°çº¿ç¨‹çš„é‡å¤åˆ›å»ºï¼Œè€Œåº”è¯¥æ³¨æ„å¯¹å·²æœ‰çº¿ç¨‹çš„å¤ç”¨ï¼Œä»è€Œé™ä½åˆ›å»ºã€å›æ”¶çº¿ç¨‹çš„é¢‘ç‡</li><li>æé«˜çº¿ç¨‹ä½¿ç”¨æ•ˆç‡ï¼Œå¤šä½™çš„çº¿ç¨‹å¯¹äºå†…å­˜å’Œå¤„ç†å™¨éƒ½æ˜¯ä¸€ç§èµ„æºæµªè´¹</li></ul><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>Androidåº”ç”¨ç¨‹åºåº”è¯¥æ˜¯å¤šçº¿ç¨‹çš„ï¼Œä»¥æé«˜å•å¤„ç†å™¨å’Œå¤šå¤„ç†å™¨å¹³å°çš„æ€§èƒ½ã€‚çº¿ç¨‹å¯ä»¥åœ¨å•ä¸ªå¤„ç†å™¨ä¸Šé¡ºåºæ‰§è¡Œï¼Œæˆ–è€…åœ¨å¤šä¸ªå¤„ç†å™¨å¯ç”¨æ—¶å®ç°çœŸæ­£çš„å¹¶å‘ã€‚æ€§èƒ½çš„æé«˜æ˜¯ä»¥å¢åŠ å¤æ‚æ€§ä¸ºä»£ä»·çš„ï¼ŒåŒæ ·éœ€è¦ç»´æŠ¤åŒæ­¥æœºåˆ¶ï¼Œä»¥ä¿è¯çº¿ç¨‹ä¹‹é—´å…±äº«èµ„æºæ•°æ®çš„ä¸€è‡´æ€§ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Efficient.Android.Threading ç¬¬äºŒç« è¯»ä¹¦ç¬”è®°&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="http://joeljt.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Efficient.Android.Threading" scheme="http://joeljt.top/tags/Efficient-Android-Threading/"/>
    
  </entry>
  
  <entry>
    <title>Android View.post æµ…æ</title>
    <link href="http://joeljt.top/2018/08/14/android-view-post/"/>
    <id>http://joeljt.top/2018/08/14/android-view-post/</id>
    <published>2018-08-13T16:00:00.000Z</published>
    <updated>2019-03-21T10:15:31.549Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ç ”ç©¶è¿™ä¸ªé—®é¢˜çš„å¥‘æœºå¾ˆå¶ç„¶ï¼Œæœ¬æ¥æ˜¯åœ¨ç ”ç©¶ View çš„æµ‹ç»˜æµç¨‹ï¼Œç»“æœä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œå°±è«åå…¶å¦™é’»åˆ°è¿™ä¸ªç‰›è§’å°–é‡Œæ¥äº†â€¦â€¦</p></blockquote><a id="more"></a><h3 id="åº"><a href="#åº" class="headerlink" title="åº"></a>åº</h3><p>ä¹‹å‰çš„æ–‡ç« é‡Œå†™åˆ°è¿‡ï¼Œæˆ‘ä»¬åœ¨ onCreate() å’Œ onResume() æ–¹æ³•ä¸­æ— æ³•è·å– View çš„å®½é«˜ä¿¡æ¯ï¼Œä½†åœ¨å¹³æ—¶å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šç”¨åˆ° View#post æ¥è¿›è¡Œ View å®½é«˜ä¿¡æ¯çš„è·å–ã€‚</p><p>é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œä¸ºä»€ä¹ˆ View#post å°±å¯ä»¥è·å–åˆ°å®½é«˜ä¿¡æ¯ï¼Ÿé‡Œè¾¹é‚£ä¸ª run() æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œçš„ï¼Ÿå…·ä½“å®ç°åŸç†åˆæ˜¯ä»€ä¹ˆï¼Ÿ</p><p>å¸¦ç€è¿™äº›ç–‘é—®ï¼Œæˆ‘æœ€è¿‘ç ”ç©¶äº†ä¸€ä¸‹ View#post çš„æºç ã€‚æœ¬æ¥ä»¥ä¸ºæŒºç®€å•çš„ä¸€ä¸ªä¸œè¥¿ï¼Œä½†æ˜¯æ²¡æƒ³åˆ°å‘è¶ŠæŒ–è¶Šæ·±ï¼Œæœ€è¿‡åˆ†çš„æ˜¯ï¼Œä¸åŒçš„ç‰ˆæœ¬æºç è¿˜ä¸ç›¸åŒï¼Œå®ç°åŸç†ä¹Ÿæœ‰ç»†å¾®çš„å·®åˆ«ã€‚é›†ä¸­æ”»å…‹äº†ä¸€ä¸ªå‘¨æœ«ä»¥åï¼Œæ„Ÿè§‰å¤§æ¦‚ç†è§£äº†ï¼Œç´¢æ€§å†™ä¸‹ç¯‡åšå®¢è¿›è¡Œè®°å½•å¤‡å¿˜ã€‚</p><p>æ–‡ç« å¤§æ¦‚åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ul><li>View#post åŸºæœ¬ä½¿ç”¨</li><li>post() æ‰§è¡Œè¿‡ç¨‹ä»¥åŠæºç åˆ†æ</li><li>post() ä¸­ Runnable#run æ‰§è¡Œçš„æ—¶æœº</li><li>View#post æ•´ä½“æµç¨‹çš„ç®€å•æ€»ç»“</li><li>Android 7.0 é‡Œ View#post çš„å˜åŠ¨ä»¥åŠåŸå› </li><li>è‡´è°¢</li></ul><h3 id="View-post-åŸºæœ¬ä½¿ç”¨"><a href="#View-post-åŸºæœ¬ä½¿ç”¨" class="headerlink" title="View#post åŸºæœ¬ä½¿ç”¨"></a>View#post åŸºæœ¬ä½¿ç”¨</h3><p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="java">@Overrideprotected void onCreate(Bundle savedInstanceState) {    super.onCreate(savedInstanceState);    setContentView(R.layout.activity_main);    View view = findViewById(R.id.test);    view.post(new Runnable() {        @Override        public void run() {            // å¯ä»¥æ­£å¸¸è·å–åˆ° View çš„å®½é«˜ä¿¡æ¯            Log.e(&quot;Test&quot;, &quot;view.post ---- &gt; &quot; + view.getHeight());        }    });}</code></pre><p>è¿™é‡Œæˆ‘ä»¬ä»¥ API 26 ä¸ºä¾‹ï¼Œæ¥å°è¯•è§£ç­”ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚</p><p>å®é™…ä¸Šï¼ŒAndroid ç³»ç»Ÿä»¥ API 24 ä¸ºç•Œï¼Œä¹‹å‰ä¹‹åçš„ç‰ˆæœ¬ï¼Œå¯¹æ­¤å¤„çš„å®ç°æœ‰ç»†å¾®çš„å·®åˆ«ï¼Œå…·ä½“çš„æ”¹åŠ¨ä»¥åŠåŸå› åœ¨åæ–‡ä¼šä¸€ä¸€ç»™å‡ºåˆ†æã€‚</p><h3 id="post-æ‰§è¡Œè¿‡ç¨‹ä»¥åŠæºç åˆ†æ"><a href="#post-æ‰§è¡Œè¿‡ç¨‹ä»¥åŠæºç åˆ†æ" class="headerlink" title="post() æ‰§è¡Œè¿‡ç¨‹ä»¥åŠæºç åˆ†æ"></a>post() æ‰§è¡Œè¿‡ç¨‹ä»¥åŠæºç åˆ†æ</h3><h4 id="1-View-post-å…¥å£"><a href="#1-View-post-å…¥å£" class="headerlink" title="1. View#post å…¥å£"></a>1. View#post å…¥å£</h4><p>å…ˆæ¥çœ‹ View#post æºç ï¼Œé‡ç‚¹æ³¨æ„æ³¨é‡Šï¼š</p><pre><code class="java">/** * Causes the Runnable to be added to the message queue. * The runnable will be run on the user interface thread. * å°† Runnable æ·»åŠ åˆ°æ‰§è¡Œé˜Ÿåˆ—ä¸­ï¼Œå…¶æœ€ç»ˆä¼šåœ¨ UI çº¿ç¨‹ä¸­æ‰§è¡Œ */public boolean post(Runnable action) {    // AttachInfo æ˜¯ View çš„å†…éƒ¨ç±»ï¼Œç”¨æ¥å­˜å‚¨ä¸€äº›åŸºæœ¬ä¿¡æ¯    // æ­¤å¤„å¯ä»¥æš‚æ—¶è®¤ä¸º mAttachInfo ä¸º null    final AttachInfo attachInfo = mAttachInfo;    if (attachInfo != null) {        // attachInfo ä¸ä¸ºç©ºæ—¶ï¼Œè½¬è€Œä½¿ç”¨å…¶å†…éƒ¨çš„ Handler å¯¹è±¡æ“ä½œ        return attachInfo.mHandler.post(action);    }    // Postpone the runnable until we know on which thread it needs to run.    // Assume that the runnable will be successfully placed after attach.    // åœ¨æˆ‘ä»¬ç¡®å®šå½“å‰ Runnable çš„ç›®æ ‡è¿è¡Œçº¿ç¨‹ä¹‹å‰ï¼Œå…ˆå°†å…¶æ¨è¿Ÿæ‰§è¡Œ    // å‡è®¾åœ¨ attach å®Œæˆä¹‹åï¼Œæ­¤ Runnable å¯¹è±¡ä¼šè¢«æˆåŠŸçš„ã€Œplacedã€ï¼ˆæš‚ä¸”ç¿»è¯‘æˆã€Œæ”¾ç½®ã€ï¼‰    // å¥½å¥½ç†è§£ä¸€ä¸‹è¿™ä¸ªæ³¨é‡Šï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹èµ°    getRunQueue().post(action);    return true;}</code></pre><p>é¦–å…ˆï¼Œæ˜ç¡®ä¸€ç‚¹ï¼š<strong>Runnable ä¼šåœ¨ UI çº¿ç¨‹ä¸­æ‰§è¡Œ</strong>ï¼›</p><p>ç„¶åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªçœ‹ä¸Šå»å¾ˆé‡è¦çš„ <strong>mAttachInfo</strong> æ˜¯åœ¨å“ªé‡Œèµ‹å€¼çš„ï¼š</p><pre><code class="java">void dispatchAttachedToWindow(AttachInfo info, int visibility) {    mAttachInfo = info;    // Transfer all pending runnables. è½¬ç§»æ‰€æœ‰å¾…åŠä»»åŠ¡    if (mRunQueue != null) {        mRunQueue.executeActions(info.mHandler);        mRunQueue = null;    }    // å›è°ƒæ–¹æ³•    onAttachedToWindow();}</code></pre><p>å…ˆä¸åœ¨æ„é™¤äº†èµ‹å€¼ä»¥å¤–çš„å…¶ä»–æ“ä½œï¼Œæˆ‘ä»¬ç»§ç»­è¿½è¸ª dispatchAttachedToWindow æ–¹æ³•ï¼Œå‘ç°å…¶æœ€åˆè°ƒç”¨æ˜¯åœ¨ ViewRootImpl#performTraversals æ–¹æ³•ã€‚å¥½äº†ï¼Œè®°ä½è¿™ä¸ªç»“è®ºï¼Œæˆ‘ä»¬å…ˆæŠŠå®ƒæ”¾åœ¨ä¸€æ—ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€çœ‹è¿™ä¸ª <strong>getRunQueue().post()</strong> åˆåšäº†ä»€ä¹ˆï¼š</p><pre><code class="java">/** * è·å–ä¸€ä¸ª RunQueue å¯¹è±¡ï¼Œç”¨æ¥è¿›è¡Œ post æ“ä½œ * Returns the queue of runnable for this view. * æ³¨é‡Šæ˜¯ï¼šä¸ºå½“å‰ View å¯¹è±¡è¿”å›ä¸€ä¸ªæ‰§è¡Œé˜Ÿåˆ—ï¼Œè®°ä½è¿™ä¸ªã€Œå½“å‰ View å¯¹è±¡ã€ */private HandlerActionQueue getRunQueue() {    if (mRunQueue == null) {        mRunQueue = new HandlerActionQueue();    }    return mRunQueue;}</code></pre><h4 id="2-HandlerActionQueue-åˆæ˜¯ä¸ªå•¥"><a href="#2-HandlerActionQueue-åˆæ˜¯ä¸ªå•¥" class="headerlink" title="2. HandlerActionQueue åˆæ˜¯ä¸ªå•¥"></a>2. HandlerActionQueue åˆæ˜¯ä¸ªå•¥</h4><p>å¾ˆæ˜æ˜¾ï¼Œæ‰§è¡Œ post æ–¹æ³•çš„æ˜¯ HandlerActionQueue å¯¹è±¡ï¼Œé‚£è¿™åˆæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼š</p><pre><code class="java">/** * Class used to enqueue pending work from Views when no Handler is attached. * æ­¤ç±»ç”¨äºåœ¨å½“å‰ View æ²¡æœ‰ Handler ä¾é™„çš„æ—¶å€™ï¼Œå°†å…¶å¾…å®Œæˆçš„ä»»åŠ¡å…¥é˜Ÿ */public class HandlerActionQueue {    private HandlerAction[] mActions;    private int mCount;    // è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬åœ¨å¤–è¾¹è°ƒç”¨çš„ post æ–¹æ³•ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° postDelayed æ–¹æ³•    public void post(Runnable action) {        postDelayed(action, 0);    }    // å°†ä¼ å…¥çš„ Runnable å¯¹è±¡å­˜å…¥æ•°ç»„ä¸­ï¼Œç­‰å¾…è°ƒç”¨    public void postDelayed(Runnable action, long delayMillis) {        final HandlerAction handlerAction = new HandlerAction(action, delayMillis);        synchronized (this) {            if (mActions == null) {                mActions = new HandlerAction[4];            }            mActions = GrowingArrayUtils.append(mActions, mCount, handlerAction);            mCount++;        }    }    // è¿™é‡Œæ‰æ˜¯çœŸçš„æ‰§è¡Œæ–¹æ³•    public void executeActions(Handler handler) {        synchronized (this) {            final HandlerAction[] actions = mActions;            for (int i = 0, count = mCount; i &lt; count; i++) {                final HandlerAction handlerAction = actions[i];                handler.postDelayed(handlerAction.action, handlerAction.delay);            }            mActions = null;            mCount = 0;        }    }}</code></pre><p>é€šè¿‡æŸ¥çœ‹ HandlerActionQueue çš„æºç ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼šä¸åŒäºåœ¨ onCreate() ç›´æ¥è·å– View çš„å®½é«˜ï¼Œæˆ‘ä»¬è°ƒç”¨ post æ–¹æ³•ï¼Œå…¶ä¸­çš„ run æ–¹æ³•å¹¶æ²¡æœ‰è¢«é©¬ä¸Šæ‰§è¡Œã€‚</p><p>è¿™æ ·å°±ä¸éš¾è§£é‡Šä¸ºä»€ä¹ˆç”¨è¿™ç§æ–¹å¼å¯ä»¥è·å–åˆ°å®½é«˜äº†ã€‚é‚£æˆ‘ä»¬å¯ä»¥çŒœæµ‹ä¸€ä¸‹ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œä¸€å®šæ˜¯ View å®Œæˆæµ‹é‡åæ‰æ‰§è¡Œäº†è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰å¯ä»¥æ‹¿åˆ°å®½é«˜ä¿¡æ¯ã€‚</p><p>äº‹å®ä¸Šä¹Ÿæ­£æ˜¯è¿™æ ·çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•åˆ°åº•æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œçš„å‘¢ï¼Ÿå¾ˆæ˜æ˜¾ï¼ŒHandlerActionQueue#executeActions æ‰æ˜¯çœŸæ­£å®Œæˆè°ƒç”¨çš„æ–¹æ³•ï¼Œé‚£è¿™ä¸ªæ–¹æ³•åˆåšäº†äº›ä»€ä¹ˆå·¥ä½œå‘¢ï¼Ÿ</p><p><strong>æ ¹æ®ä»£ç å¯çŸ¥ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ª Handlerï¼Œç„¶åä½¿ç”¨è¿™ä¸ª Handler å¯¹å½“å‰é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ Runnable è¿›è¡Œå¤„ç†ï¼Œå³ post åˆ°è¯¥ Handler çš„çº¿ç¨‹ä¸­ï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§å¯¹è¿™äº› Runnable ä¾æ¬¡è¿›è¡Œå¤„ç†ã€‚</strong></p><p><strong>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¼ å…¥çš„ Handler å†³å®šç€è¿™äº› Runnable çš„æ‰§è¡Œçº¿ç¨‹ã€‚</strong></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è¿½è¸ªè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨æƒ…å†µã€‚</p><p><img src="http://upload-images.jianshu.io/upload_images/5419805-e0cf86fbea081bc9.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="executeActions() çš„è°ƒç”¨æƒ…å†µ"></p><p>æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œå¯¹äºè¯¥æ–¹æ³•å‡ºç°äº†ä¸¤æ¬¡è°ƒç”¨ï¼Œä¸€æ¬¡åœ¨ View#dispatchAttachToWindowï¼ˆå°±æ˜¯æˆ‘ä»¬æœ€å¼€å§‹æ‰¾åˆ°çš„é‚£ä¸ªæ–¹æ³•ï¼‰ï¼Œå¦ä¸€æ¬¡æ˜¯åœ¨ ViewRootImpl#performTraversalsã€‚</p><h4 id="3-ä¸‡æ¶ä¹‹æº-performTraversals"><a href="#3-ä¸‡æ¶ä¹‹æº-performTraversals" class="headerlink" title="3. ä¸‡æ¶ä¹‹æº performTraversals()"></a>3. ä¸‡æ¶ä¹‹æº performTraversals()</h4><p>å¾ˆæ˜æ˜¾ï¼Œæ‰€æœ‰çš„è¯æ®éƒ½æŒ‡å‘äº† performTraversals ï¼Œé‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±æ¥é‡ç‚¹åˆ†æä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ã€‚</p><p>å¦‚æœä½ äº†è§£è¿‡ View çš„æµ‹ç»˜æµç¨‹ï¼Œé‚£ä½ å¯¹è¿™ä¸ªæ–¹æ³•ä¸€å®šä¸ä¼šé™Œç”Ÿï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•å°±æ˜¯ View ç»˜åˆ¶æµç¨‹çš„èµ·ç‚¹ã€‚</p><pre><code class="java">private void performTraversals() {    // æ­¤å¤„çš„ host æ˜¯æ ¹å¸ƒå±€ DecorViewï¼Œç”¨é€’å½’çš„æ–¹å¼ä¸€å±‚ä¸€å±‚çš„è°ƒç”¨ dispatchAttachedToWindow    // mAttachInfo æ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿï¼Œå°±æ˜¯æœ€å¼€å§‹ View#post çš„ç¬¬ä¸€å±‚åˆ¤æ–­    // è¿™ä¸ª mAttachInfo åœ¨ ViewRootImpl çš„æ„é€ å™¨ä¸­åˆå§‹åŒ–çš„ï¼Œå…¶æŒæœ‰ ViewRootImpl çš„ Handler å¯¹è±¡    host.dispatchAttachedToWindow(mAttachInfo, 0);    getRunQueue().executeActions(mAttachInfo.mHandler);    // ç»˜åˆ¶æµç¨‹å°±ä»è¿™é‡Œå¼€å§‹    performMeasure();    performLayout();    performDraw();}</code></pre><p>æˆ‘ä»¬å…ˆä» dispatchAttachedToWindow å¼€å§‹ï¼Œæˆ‘ä»¬ä¹‹å‰å·²ç»çœ‹è¿‡è¿™ä¸ªæ–¹æ³•çš„æºç äº†ï¼š</p><pre><code class="java">void dispatchAttachedToWindow(AttachInfo info, int visibility) {    mAttachInfo = info;    // Transfer all pending runnables. è½¬ç§»æ‰€æœ‰å¾…åŠä»»åŠ¡    if (mRunQueue != null) {        mRunQueue.executeActions(info.mHandler);        mRunQueue = null;    }    // å›è°ƒæ–¹æ³•    onAttachedToWindow();}</code></pre><p><strong>ç°åœ¨æ¥è¿›è¡Œåˆ†æï¼š</strong></p><ol><li>æˆ‘ä»¬å·²ç»çŸ¥é“äº†æ­¤æ–¹æ³•æ˜¯ä»æ ¹è§†å›¾å¼€å§‹é€’å½’å‘ä¸‹è°ƒç”¨çš„ï¼Œé‚£ä¹ˆé€’å½’åˆ°æœ€æ·±å¤„ï¼Œå°±ä¼šè½®åˆ°æœ€å¼€å§‹æˆ‘ä»¬è°ƒç”¨ post æ–¹æ³•çš„ View å¯¹è±¡æ¥æ‰§è¡Œè¯¥æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯¥æ–¹æ³•å†…çš„æ‰€æœ‰å±æ€§ï¼Œéƒ½æ˜¯æˆ‘ä»¬ findViewById è·å¾—çš„é‚£ä¸ª View å¯¹è±¡çš„å±æ€§ï¼›</li><li>è€Œä¸”æˆ‘ä»¬ä¹ŸçŸ¥é“ï¼Œç¬¬ä¸€ä¸ªå‚æ•° AttachInfo å°±æ˜¯ ViewRootImpl ä¸­åˆå§‹åŒ–çš„ AttachInfoï¼Œå®ƒæŒæœ‰å½“å‰ ViewRootImpl çš„ Handler å¯¹è±¡å¼•ç”¨ï¼Œå¹¶å°†è¯¥å¼•ç”¨ä¼ ç»™äº† executeActions()ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å†æ¥å›é¡¾ä¸€ä¸‹ <strong>executeActions()</strong> æ–¹æ³•çš„ä½œç”¨ï¼Œ<strong>ä¼ å…¥çš„ Handler å†³å®šç€é˜Ÿåˆ—é‡Œè¿™äº› Runnable çš„æ‰§è¡Œçº¿ç¨‹</strong>ã€‚</li></ol><p>å¾ˆæ˜æ˜¾ï¼Œæ­¤å¤„çš„ mRunQueue å°±æ˜¯æˆ‘ä»¬æœ€å¼€å§‹è°ƒç”¨ post() æ—¶ï¼Œè°ƒç”¨ View#getRunQueue è¿”å›çš„é‚£ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¸­æœ‰å‡†å¤‡è·å–Viewé«˜åº¦çš„ Runnable å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´ <strong>mRunQueue é€šè¿‡è°ƒç”¨ executeActions() å°†å½“å‰ View çš„æ‰€æœ‰ Runnable ï¼Œéƒ½ä¼šè½¬ç”± ViewRootImpl çš„ Handler æ¥å¤„ç†ï¼</strong>è€Œåœ¨å®Œæˆè¿™ä¸ªå·¥ä½œä¹‹åï¼Œå½“å‰ View ä¹Ÿæ˜¾ç¤ºåœ°å°† mRunQueue ç½®ç©ºï¼Œå› ä¸ºæ‰€æœ‰çš„å¾…åŠä»»åŠ¡éƒ½å·²ç»äº¤ç»™ ViewRootImpl å»å¤„ç†äº†ã€‚</p><p>ç°åœ¨å†å›è¿‡å¤´çœ‹ä»£ç çš„æ³¨é‡Šï¼Œå°±å·®ä¸å¤šå¯ä»¥ç†è§£äº†ï¼š</p><pre><code class="java">// Postpone the runnable until we know on which thread it needs to run.// Assume that the runnable will be successfully placed after attach.// æ‰€æœ‰çš„ Runnable éƒ½ä¼šåœ¨ attach ä¹‹åè¢«æ­£ç¡®çš„æ”¾åˆ°å…¶åº”è¯¥è¿è¡Œçš„çº¿ç¨‹ä¸Šå»getRunQueue().post(action);// Transfer all pending runnables.// è½¬ç§»æ‰€æœ‰å¾…åŠä»»åŠ¡(åˆ° ViewRootImpl ä¸­è¿›è¡Œå¤„ç†)if (mRunQueue != null) {    mRunQueue.executeActions(info.mHandler);    mRunQueue = null;}</code></pre><p>dispatch æ–¹æ³•æ‰§è¡Œå®Œäº†ï¼Œæˆ‘ä»¬ç»§ç»­å›æ¥èµ° performTraversals() ï¼Œæ¥ä¸‹æ¥ä¸€å¥æ˜¯ï¼š</p><pre><code class="java">// æœ‰ä¹‹å‰çš„ç»éªŒï¼Œæˆ‘ä»¬çŸ¥é“è¿™å¥è¯çš„æ„æ€æ˜¯// ä½¿ç”¨ mAttachInfo.mHandler æ¥å¤„ç† getRunQueue() ä¸­çš„ Runnable ä»»åŠ¡getRunQueue().executeActions(mAttachInfo.mHandler);</code></pre><p>è¦æ˜ç¡®çš„ä¸€ç‚¹æ˜¯ï¼Œæ­¤æ—¶æˆ‘ä»¬å¤„åœ¨ ViewRootImpl ç±»ä¸­ï¼Œæ­¤å¤„çš„ getRunQueue() æ–¹æ³•æœ‰åˆ«äº View#postï¼š</p><pre><code class="java">// ViewRootImpl#getRunQueue// ä½¿ç”¨ ThreadLocal æ¥å­˜å‚¨æ¯ä¸ªçº¿ç¨‹è‡ªèº«çš„æ‰§è¡Œé˜Ÿåˆ— HandlerActionQueuestatic HandlerActionQueue getRunQueue() {    // sRunQueues æ˜¯ ThreadLocal&lt;HandlerActionQueue&gt; å¯¹è±¡    HandlerActionQueue rq = sRunQueues.get();    if (rq != null) {        return rq;    }    rq = new HandlerActionQueue();    sRunQueues.set(rq);    return rq;}// View#post// ä¸ºå½“å‰ View è¿”å›ä¸€ä¸ªæ‰§è¡Œé˜Ÿåˆ—ï¼Œä½†æ˜¯åœ¨ dispatchAttachToWindow æ—¶è½¬åˆ° UI çº¿ç¨‹å»private HandlerActionQueue getRunQueue() {    if (mRunQueue == null) {        mRunQueue = new HandlerActionQueue();    }    return mRunQueue;}</code></pre><p>è¯´å› performTraversals() ï¼Œå¾ˆæ˜æ˜¾ getRunQueue() æ˜¯ UI çº¿ç¨‹æ‰§è¡Œé˜Ÿåˆ—çš„ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰è¿™ä¸ªä»»åŠ¡é˜Ÿåˆ—é‡Œå¹¶æ²¡æœ‰å¾…æ‰§è¡Œä»»åŠ¡ï¼</p><p>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>å½“å‰æ²¡æœ‰æ‰§è¡Œä»»åŠ¡ï¼ˆ</strong>HandlerActionQueue<strong>ï¼‰ï¼Œä¸ä»£è¡¨ Handler æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯</strong>ï¼Œè¿™æ˜¯ä¸¤ä¸ªæ¦‚å¿µï¼Œéœ€è¦æ³¨æ„åŒºåˆ†å¼€ã€‚</p><p>æ€»ç»“ä¸€ä¸‹ï¼š</p><ol><li>View#post æ–¹æ³•è°ƒç”¨æ—¶ï¼Œä¼šä¸ºå½“å‰ View å¯¹è±¡åˆå§‹åŒ–ä¸€ä¸ª HandlerActionQueue ï¼Œå¹¶å°† Runnable å…¥é˜Ÿå­˜å‚¨ï¼›</li><li>ç­‰åœ¨ ViewRootImpl#performTraversals ä¸­é€’å½’è°ƒç”¨åˆ° View#dispatchAttachedToWindow æ—¶ï¼Œä¼šå°† ViewRootImpl çš„ Handler å¯¹è±¡ä¼ ä¸‹æ¥ï¼Œç„¶åé€šè¿‡è¿™ä¸ª Handler å°†æœ€åˆçš„ Runnable å‘é€åˆ° UI çº¿ç¨‹ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼‰ç­‰å¾…æ‰§è¡Œï¼Œå¹¶å°† View çš„ HandlerActionQueue å¯¹è±¡ç½®ç©ºï¼Œæ–¹ä¾¿å›æ”¶ï¼›</li><li>ViewRootImpl#performTraversals ç»§ç»­æ‰§è¡Œï¼Œæ‰ä¼šä¸º UI çº¿ç¨‹é¦–æ¬¡åˆå§‹åŒ– HandlerActionQueue å¯¹è±¡ï¼Œå¹¶é€šè¿‡ ThreadLocal è¿›è¡Œå­˜å‚¨ï¼Œæ–¹ä¾¿ä¹‹åçš„å¤ç”¨ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤å¤„åˆå§‹åŒ–çš„é˜Ÿåˆ—ä¸­æ˜¯æ²¡æœ‰ä»»ä½• Runnable å¯¹è±¡çš„ï¼›</li><li>ç„¶å ViewRootImpl#performTraversals ç»§ç»­æ‰§è¡Œï¼Œå¼€å§‹ View çš„æµ‹é‡æµç¨‹ã€‚</li></ol><h3 id="View-post-ä¸­-Runnable-run-æ‰§è¡Œçš„æ—¶æœº"><a href="#View-post-ä¸­-Runnable-run-æ‰§è¡Œçš„æ—¶æœº" class="headerlink" title="View#post ä¸­ Runnable#run æ‰§è¡Œçš„æ—¶æœº"></a>View#post ä¸­ Runnable#run æ‰§è¡Œçš„æ—¶æœº</h3><p>ä½†ç°åœ¨çš„é—®é¢˜æ˜¯ï¼Œæ— è®ºæ€ä¹ˆè¯´ï¼Œ<strong>HandlerActionQueue#executeActions éƒ½æ˜¯å…ˆäº View æµ‹ç»˜æµç¨‹çš„</strong>ï¼Œä¸ºä»€ä¹ˆåœ¨è¿˜æ²¡æœ‰å®Œæˆæµ‹é‡çš„æ—¶å€™ï¼Œå°±å¯ä»¥æ‹¿åˆ°å®½é«˜ä¿¡æ¯ï¼Ÿ</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒAndroid ç³»ç»Ÿæ˜¯åŸºäºæ¶ˆæ¯æœºåˆ¶è¿è¡Œçš„ï¼Œæ‰€æœ‰çš„äº‹ä»¶ã€è¡Œä¸ºï¼Œéƒ½æ˜¯åŸºäº Handler æ¶ˆæ¯æœºåˆ¶åœ¨è¿è¡Œçš„ã€‚æ‰€ä»¥ï¼Œå½“ ViewRootImpl#performTraversals åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œä¹Ÿä¸€å®šæ˜¯åŸºäºæŸä¸ªæ¶ˆæ¯çš„ã€‚è€Œä¸”ï¼ŒHandlerActionQueue#executeActions æ‰§è¡Œçš„æ—¶å€™ï¼Œä¹Ÿåªæ˜¯é€šè¿‡ Handler å°† Runnable post åˆ°äº† UI çº¿ç¨‹ç­‰å¾…æ‰§è¡Œï¼ˆè¿˜è®°å¾— View#post çš„æ³¨é‡Šå—ï¼Ÿï¼‰ã€‚</p><p>ä¸å‡ºæ„å¤–çš„è¯ï¼Œæ­¤æ—¶ UI çº¿ç¨‹æ­£å¿™ç€æ‰§è¡Œ ViewRootImpl#performTraversal ï¼Œç­‰è¯¥æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼ŒView å·²ç»å®Œæˆäº†æµ‹é‡æµç¨‹ï¼Œæ­¤æ—¶å†å»æ‰§è¡Œ Runnable#run ï¼Œä¹Ÿå°±è‡ªç„¶å¯ä»¥è·å–åˆ° View çš„å®½é«˜ä¿¡æ¯äº†ã€‚</p><p>ä¸‹é¢ç”¨å…·ä½“çš„å®ä¾‹ä½è¯ä¸€ä¸‹æˆ‘ä»¬çš„çŒœæƒ³ã€‚</p><pre><code class="JAVA">@Overrideprotected void onCreate(Bundle savedInstanceState) {    super.onCreate(savedInstanceState);    setContentView(R.layout.activity_main);    final ViewGroup viewGroup = (ViewGroup) getWindow().getDecorView();    // ç­‰å¾… Add åˆ°çˆ¶å¸ƒå±€ä¸­    view = new View(this) {        @Override        protected void onLayout( ... ... ) {            super.onLayout(changed, left, top, right, bottom);            Log.e(&quot;Test&quot;, &quot;æ‰§è¡Œäº†onLayout()&quot;);        }    };    // è‡ªå·±å£°æ˜çš„ Handler     mHandler.post(new Runnable() {        @Override        public void run() {            Log.e(&quot;Test&quot;, &quot;mHandler.post ---- &gt; &quot; + view.getHeight());        }    });    // onCreate() ä¸­ mAttachInfo è¿˜æœªè¢«èµ‹å€¼ï¼Œè¿™é‡Œä¼šäº¤ç»™ ViewRootImpl çš„ Handler æ¥å¤„ç†    // å³åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç­‰å¾…æ‰§è¡Œ    view.post(new Runnable() {        @Override        public void run() {            Log.e(&quot;Test&quot;, &quot;view.post ---- &gt; &quot; + view.getHeight());        }    });    viewGroup.addView(view);}</code></pre><p>æœ€ç»ˆæ‰“å°æ—¥å¿—å¦‚ä¸‹ï¼š</p><p><img src="http://upload-images.jianshu.io/upload_images/5419805-ec13fe6929791de9.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image"></p><p>ä¹Ÿå°±æ˜¯è¯´ï¼š</p><ol><li>Handler#post é¦–å…ˆæ‰§è¡Œï¼Œå…¶ post çš„æ—¶é—´ç‚¹åœ¨ onCreate() æ–¹æ³•å†…ï¼Œåœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä½ç½®ä¸€å®šæ¯” performTraversals() é å‰ï¼›</li><li>ViewRootImpl#performTraversal æ‰§è¡Œï¼Œè¿‡ç¨‹ä¸­æ‰§è¡Œäº† View#dispatchAttachedToWindow æ–¹æ³•ï¼Œå°†æœ€åˆçš„ Runnable å…¥é˜Ÿåè¿›è¡Œæµ‹é‡æµç¨‹ï¼Œå®Œæˆäº† layout è¿‡ç¨‹ï¼›</li><li>ä¹‹åæ‰æ‰§è¡Œäº†æœ€åˆçš„ View#post æ–¹æ³•ï¼Œä¹Ÿå°±è¯´æ˜äº†ï¼Œåœ¨ View#dispatchAttachedToWindow ä¸­ä½¿ç”¨ ViewRootImpl çš„ Handler postDelay çš„ Runnable å¯¹è±¡ï¼Œåœ¨ä¸»çº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç¡®å®æ˜¯æ’åœ¨ ViewRootImpl#performTraversal ä¹‹åçš„</li></ol><h3 id="View-post-æ•´ä½“æµç¨‹çš„ç®€å•æ€»ç»“"><a href="#View-post-æ•´ä½“æµç¨‹çš„ç®€å•æ€»ç»“" class="headerlink" title="View#post æ•´ä½“æµç¨‹çš„ç®€å•æ€»ç»“"></a>View#post æ•´ä½“æµç¨‹çš„ç®€å•æ€»ç»“</h3><p>æœ€åå¤§æ¦‚æ€»ç»“ä¸€ä¸‹ï¼š</p><p>å½“æˆ‘ä»¬ä½¿ç”¨ View#post æ—¶ï¼Œä¼šæœ‰ä¸¤ç§æƒ…å†µï¼š</p><ol><li>åœ¨å½“å‰ View attach åˆ° Window ä¹‹å‰ï¼Œä¼šè‡ªå·±å…ˆç»´æŠ¤ä¸€ä¸ª HandlerActionQueue å¯¹è±¡ï¼Œç”¨æ¥å­˜å‚¨å½“å‰çš„ Runnable å¯¹è±¡ï¼Œç„¶åç­‰åˆ° Attach åˆ° Window çš„æ—¶å€™ (ä¹Ÿå°±æ˜¯ ViewRootImpl æ‰§è¡Œåˆ° performTraversal æ–¹æ³•æ—¶) ï¼Œä¼šç»Ÿä¸€å°† Runnable è½¬äº¤ç»™ ViewRootImpl å¤„ç†ï¼›</li><li>è€Œåœ¨ View#dispatchAttachedToWindow æ—¶ï¼Œä¹Ÿä¼šä¸ºå½“å‰ View åˆå§‹åŒ–ä¸€ä¸ª AttachInfo å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æŒæœ‰ ViewRootImpl çš„å¼•ç”¨ï¼Œå½“ View æœ‰æ­¤å¯¹è±¡åï¼Œåç»­çš„æ‰€æœ‰ Runnable éƒ½å°†ç›´æ¥äº¤ç»™ ViewRootImpl å¤„ç†ï¼›</li><li>è€Œ ViewRootImpl ä¹Ÿä¼šåœ¨æ‰§è¡Œ performTraversal æ–¹æ³•ï¼Œä¹Ÿä¼šè°ƒç”¨ ViewRootImpl#getRunQueue ï¼Œåˆ©ç”¨ ThreadLocal æ¥ä¸ºä¸»çº¿ç¨‹ç»´æŠ¤ä¸€ä¸ª HandlerActionQueue å¯¹è±¡ï¼Œè‡³æ­¤ï¼ŒViewRootImpl å†…éƒ¨éƒ½å°†ä½¿ç”¨è¯¥é˜Ÿåˆ—æ¥è¿›è¡Œ Runnable ä»»åŠ¡çš„çŸ­æœŸç»´æŠ¤ï¼›</li><li>ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå„ä¸ª View è°ƒç”¨çš„ post æ–¹æ³•ï¼Œä»ç„¶æ˜¯ç”±å„è‡ªçš„ HandlerActionQueue å¯¹è±¡æ¥å…¥é˜Ÿä»»åŠ¡çš„ï¼Œç„¶ååœ¨ View#dispatchAttachedToWindow çš„æ—¶å€™è½¬ç§»ç»™ ViewRootImpl å»å¤„ç†ã€‚</li></ol><h3 id="Android-7-0-é‡Œ-View-post-çš„å˜åŠ¨ä»¥åŠåŸå› "><a href="#Android-7-0-é‡Œ-View-post-çš„å˜åŠ¨ä»¥åŠåŸå› " class="headerlink" title="Android 7.0 é‡Œ View#post çš„å˜åŠ¨ä»¥åŠåŸå› "></a>Android 7.0 é‡Œ View#post çš„å˜åŠ¨ä»¥åŠåŸå› </h3><p>View#post è¯´åˆ°è¿™é‡Œå¤§æ¦‚å°±å·®ä¸å¤šäº†ï¼Œæ–‡ç« å¼€ç¯‡çš„æ—¶å€™è¯´åˆ°ï¼š</p><blockquote><p>Android ç³»ç»Ÿä»¥ API 24 ä¸ºç•Œï¼Œä¹‹å‰ä¹‹åçš„ç‰ˆæœ¬ï¼Œå¯¹æ­¤å¤„çš„å®ç°æœ‰ç»†å¾®çš„å·®åˆ«</p></blockquote><p>ä¸‹é¢æ¥ç®€å•å¯¹æ¯”ä¸€ä¸‹å…·ä½“çš„å·®åˆ«ï¼Œé¡ºä¾¿åˆ†æä¸€ä¸‹å…·ä½“ä¸ºä»€ä¹ˆè¦è¿™æ ·æ”¹åŠ¨ã€‚</p><p>å®é™…ä¸Šè¿™ä¸ªæ–¹æ³•çš„æ”¹åŠ¨ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä¸€ä¸ª bugï¼Œè¿™ä¸ª bug å°±æ˜¯ï¼š<strong>åœ¨ View è¢« attach åˆ° window ä¹‹å‰ï¼Œä»å­çº¿ç¨‹è°ƒç”¨çš„ View#post ï¼Œæ°¸è¿œæ— æ³•å¾—åˆ°æ‰§è¡Œã€‚</strong></p><p>å…·ä½“åŸå› ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ API23 ç‰ˆæœ¬çš„ View#postï¼Œå°±å¤§æ¦‚éƒ½æ˜ç™½äº†ï¼š</p><pre><code class="java">// Android API23 View#postpublic boolean post(Runnable action) {    final AttachInfo attachInfo = mAttachInfo;    if (attachInfo != null) {        return attachInfo.mHandler.post(action);    }    // Assume that post will succeed later    // æ³¨æ„æ­¤å¤„ï¼Œä¸åŒäºæˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„ï¼Œè¿™é‡Œæ˜¯ç›´æ¥ä½¿ç”¨ ViewRootImpl#getRunQueue æ¥å…¥é˜Ÿä»»åŠ¡çš„    ViewRootImpl.getRunQueue().post(action);    return true;}</code></pre><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸åŒäºæˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„ï¼ŒAPI23 ç‰ˆæœ¬ä¸­ï¼ŒView#post åœ¨æ²¡æœ‰ attach åˆ° window ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯ mAttachInfo æ˜¯ null çš„æ—¶å€™ï¼Œä¸æ˜¯è‡ªå·±ç»´æŠ¤ä»»åŠ¡é˜Ÿåˆ—ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ ViewRootImpl#getRunQueue æ¥å…¥é˜Ÿä»»åŠ¡çš„ã€‚</p><p>å†æ¥çœ‹ä¸€ä¸‹ ViewRootImpl#getRunQueue æ–¹æ³•ï¼Œæˆ‘ä»¬å°±ä¼šå‘ç°é—®é¢˜å‡ºåœ¨å“ªé‡Œäº†ï¼š</p><pre><code class="java">static final ThreadLocal&lt;RunQueue&gt; sRunQueues = new ThreadLocal&lt;RunQueue&gt;();static RunQueue getRunQueue() {    RunQueue rq = sRunQueues.get();    if (rq != null) {        return rq;    }    rq = new RunQueue();    sRunQueues.set(rq);    return rq;}</code></pre><p>æ²¡é”™ï¼Œè¿™ä¸ªé˜Ÿåˆ—çš„ä¿å­˜ä¸è·å–ï¼Œæ˜¯é€šè¿‡ä»¥çº¿ç¨‹ä¸º key å€¼æ¥å­˜å–å¯¹è±¡ ThreadLocal æ¥ç»´æŠ¤çš„ã€‚è€Œåœ¨è¿™ä¸ªç‰ˆæœ¬çš„æºç ä¸­ï¼ŒexecuteActions() æ–¹æ³•çš„æ‰§è¡Œï¼Œåªæœ‰ä¸€æ¬¡è°ƒç”¨ï¼Œé‚£å°±æ˜¯ ViewRootImpl#performTraversal ä¸­ï¼ˆæ„Ÿå…´è¶£çš„å¯ä»¥å» 23 ç‰ˆæœ¬çš„æºç ä¸­æŸ¥çœ‹ï¼Œè¿™é‡Œå°±ä¸è´´å›¾äº†ï¼‰ï¼Œä¸æ­¤åŒæ—¶ï¼Œè¯¥æ–¹æ³•è‚¯å®šæ˜¯æ‰§è¡Œåœ¨ä¸»çº¿ç¨‹ä¸­çš„ã€‚</p><p>ç°åœ¨çš„é—®é¢˜å°±å˜æˆäº†ï¼š<strong>æˆ‘åœ¨å­çº¿ç¨‹ä¸­ post äº†ä¸€ä¸ª runnableï¼Œå¹¶ä¸”ç³»ç»Ÿä»¥è¯¥å­çº¿ç¨‹ä¸º key å°†é˜Ÿåˆ—å­˜äº†èµ·æ¥ç­‰å¾…æ‰§è¡Œï¼›ä½†æ˜¯åœ¨å…·ä½“æ‰§è¡Œçš„æ—¶å€™ï¼Œç³»ç»Ÿå´æ˜¯å»ä¸»çº¿ç¨‹ä¸­å¯»æ‰¾å¾…æ‰§è¡Œçš„ Runnableï¼Œé‚£ä¹ˆå½“ç„¶æ˜¯æ°¸è¿œéƒ½å¾—ä¸åˆ°æ‰§è¡Œçš„äº†ã€‚</strong></p><p>è€Œåœ¨<strong>å…·ä½“ attach åˆ° window ä¹‹å</strong>ï¼ŒView çš„ mAttachInfo æŒæœ‰ ViewRootImpl å¼•ç”¨ï¼Œä¼šç›´æ¥å°†æ‰€æœ‰çš„ Runnable è½¬äº¤ç»™ ViewRootImpl çš„ Handler å¤„ç†ï¼Œä¹Ÿ<strong>å°±éƒ½èƒ½å¾—åˆ°å¦¥å–„å¤„ç†ï¼Œå°±ä¸çº¿ç¨‹æ— å…³äº†ã€‚</strong></p><p>é™¤æ­¤ä»¥å¤–ï¼ŒViewRootImpl ä½¿ç”¨ ThreadLocal æ¥å­˜å‚¨é˜Ÿåˆ—ä¿¡æ¯ï¼Œåœ¨æŸäº›æƒ…å¢ƒä¸‹ï¼Œè¿˜ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒï¼š<a href="https://blog.csdn.net/a740169405/article/details/69668957" target="_blank" rel="noopener">https://blog.csdn.net/a740169405/article/details/69668957</a></p><p>æ‰€ä»¥ï¼Œ<strong>Google å·¥ç¨‹å¸ˆä¸ºäº†è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ï¼ˆå†…å­˜æ³„æ¼çš„é—®é¢˜æ›´ä¸¥é‡ä¸€äº›ï¼‰ï¼Œå°±åœ¨ View#post æ–¹æ³•ä¸­ä½¿ç”¨ View å¯¹è±¡æ¥è¿›è¡Œé˜Ÿåˆ—çš„å­˜å‚¨ï¼Œç„¶ååœ¨ attach åˆ° window çš„æ—¶å€™ï¼Œé€šè¿‡æŒæœ‰ ViewRootImpl å¼•ç”¨çš„ AttachInfo å¯¹è±¡ç›´æ¥å°† View å¯¹è±¡çš„ Runnable å¤„ç†æ‰ï¼Œå°±å®Œç¾è§£å†³äº†è¿™äº›é—®é¢˜ã€‚</strong></p><h3 id="è‡´è°¢"><a href="#è‡´è°¢" class="headerlink" title="è‡´è°¢"></a>è‡´è°¢</h3><p>ä¸‹è¾¹æ˜¯è‡ªå·±ç ”ç©¶çš„æ—¶å€™å…·ä½“å‚è€ƒè¿‡çš„æ–‡ç« ï¼Œç»™å„ä½å‰è¾ˆåŠ ä¸ªé¸¡è…¿ï¼š</p><h5 id="https-blog-csdn-net-a740169405-article-details-69668957"><a href="#https-blog-csdn-net-a740169405-article-details-69668957" class="headerlink" title="https://blog.csdn.net/a740169405/article/details/69668957"></a><a href="https://blog.csdn.net/a740169405/article/details/69668957" target="_blank" rel="noopener">https://blog.csdn.net/a740169405/article/details/69668957</a></h5><h5 id="https-blog-csdn-net-scnuxisan225-article-details-49815269"><a href="#https-blog-csdn-net-scnuxisan225-article-details-49815269" class="headerlink" title="https://blog.csdn.net/scnuxisan225/article/details/49815269"></a><a href="https://blog.csdn.net/scnuxisan225/article/details/49815269" target="_blank" rel="noopener">https://blog.csdn.net/scnuxisan225/article/details/49815269</a></h5><h5 id="https-www-cnblogs-com-plokmju-p-7481727-html"><a href="#https-www-cnblogs-com-plokmju-p-7481727-html" class="headerlink" title="https://www.cnblogs.com/plokmju/p/7481727.html"></a><a href="https://www.cnblogs.com/plokmju/p/7481727.html" target="_blank" rel="noopener">https://www.cnblogs.com/plokmju/p/7481727.html</a></h5>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ç ”ç©¶è¿™ä¸ªé—®é¢˜çš„å¥‘æœºå¾ˆå¶ç„¶ï¼Œæœ¬æ¥æ˜¯åœ¨ç ”ç©¶ View çš„æµ‹ç»˜æµç¨‹ï¼Œç»“æœä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œå°±è«åå…¶å¦™é’»åˆ°è¿™ä¸ªç‰›è§’å°–é‡Œæ¥äº†â€¦â€¦&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://joeljt.top/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>ä¸ºä½• Android åœ¨ onCreate ä¸­è·å–ä¸åˆ°å®½é«˜</title>
    <link href="http://joeljt.top/2018/08/13/can-not-get-height-in-onCreate/"/>
    <id>http://joeljt.top/2018/08/13/can-not-get-height-in-onCreate/</id>
    <published>2018-08-12T16:00:00.000Z</published>
    <updated>2019-03-21T10:50:48.542Z</updated>
    
    <content type="html"><![CDATA[<p>ç»å†è¿‡ä¸€æ®µæ—¶é—´çš„å¼€å‘ä»¥åï¼Œæˆ‘ä»¬éƒ½ä¼šå‘ç° onCreate() å’Œ onResume() é‡Œæ— æ³•è·å–åˆ° View çš„å®½é«˜ä¿¡æ¯ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ˜æ˜ setContentView äº†ä¸æ˜¯å—ï¼Ÿä»Šå¤©æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚</p><a id="more"></a><p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="java">public class MainActivity extends AppCompatActivity {    @BindView(R.id.tv_test)    private TextView mTextView;    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.activity_main);        mTv.getHeight(); // 0    }    @Override    protected void onResume() {        super.onResume();        mTv.getHeight(); // 0    }}</code></pre><p>è¦å¼„æ¸…è¿™ä¸ªé—®é¢˜ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“ä»£ç ä¸­æ¶‰åŠåˆ°çš„æ–¹æ³•å…·ä½“åšäº†ä»€ä¹ˆå·¥ä½œï¼Œä»¥åŠå…·ä½“ View æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™å®Œæˆæµ‹é‡çš„ã€‚</p><h3 id="setContentView"><a href="#setContentView" class="headerlink" title="setContentView()"></a>setContentView()</h3><p>å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬åœ¨ onCreate() æ–¹æ³•ä¸­è°ƒç”¨äº† setContentView() æ–¹æ³•ï¼Œè€Œ<strong>è®¾ç½®å¸ƒå±€</strong>è¿™ä¸ªåŠ¨ä½œä¼šç»™ä½ ä¸€ç§å¯ä»¥è·å–åˆ°å®½é«˜çš„é”™è§‰ï¼›é‚£ä¹ˆæˆ‘ä»¬ä»æºç çš„è§’åº¦æ¥çœ‹çœ‹ï¼ŒsetContentView() åˆ°åº•å¹²äº†ç‚¹ä»€ä¹ˆã€‚</p><pre><code class="java">// 1. AppCompatDelegate çš„æŠ½è±¡æ–¹æ³•ï¼Œæ ¹æ®æ³¨é‡Šï¼Œä¼šè°ƒç”¨åˆ° Activity çš„å®ç°æ–¹æ³•ä¸­public abstract void setContentView(@LayoutRes int resId);// 2. Activity çš„å®ç°æ–¹æ³•public void setContentView(@LayoutRes int layoutResID) {    // Window æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…¶å”¯ä¸€å®ç°ç±»æ˜¯ PhoneWindow    getWindow().setContentView(layoutResID);    initWindowDecorActionBar();}@Overridepublic void setContentView(int layoutResID) {    if (mContentParent == null) {        // 3. åˆå§‹åŒ– DecorView        installDecor();    } else if (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) {        mContentParent.removeAllViews();    }    ... ...}private void installDecor() {    mForceDecorInstall = false;    if (mDecor == null) {        // 4. ç¬¬ä¸€æ¬¡åŠ è½½çª—å£ï¼ŒmDecor ä¸ºç©ºæ—¶ï¼Œç”Ÿæˆä¸€ä¸ª DecorView å¯¹è±¡        // generateDecor(-1) : return new DecorView()        mDecor = generateDecor(-1);        ... ...    } else {        mDecor.setWindow(this);    }    if (mContentParent == null) {        // 5. åˆå§‹åŒ–çˆ¶å¸ƒå±€        mContentParent = generateLayout(mDecor);    }}// ç»§ç»­è·Ÿè¸ªåˆ° generateLayout(mDecor) æ–¹æ³•å†…éƒ¨protected ViewGroup generateLayout(DecorView decor) {    // æ­¤å¤„æ ¹æ®è®¾ç½®çš„ä¸»é¢˜è¿›è¡Œä¸€äº›åŸºç¡€è®¾ç½®ï¼Œæ²¡ä»€ä¹ˆå†³å®šæ€§ä½œç”¨    TypedArray a = getWindowStyle();    ... ...    // æ¥ä¸‹æ¥çš„ä¸€å¤§æ®µä»£ç æ˜¯æ ¹æ®å„ç§ä¸»é¢˜è®¾ç½®é»˜è®¤å¸ƒå±€ï¼Œç¯‡å¹…åŸå› ï¼Œæ­¤å¤„æœ‰å¤§é‡æºç åˆ å‡    int layoutResource;    int features = getLocalFeatures();    if ((features &amp; (1 &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != 0) {        layoutResource = R.layout.screen_swipe_dismiss;        setCloseOnSwipeEnabled(true);    } else if ((features &amp; (1 &lt;&lt; FEATURE_NO_TITLE)) == 0) {        if (mIsFloating) {            TypedValue res = new TypedValue();            getContext().getTheme().resolveAttribute(                R.attr.dialogTitleDecorLayout, res, true);            layoutResource = res.resourceId;        } else if ((features &amp; (1 &lt;&lt; FEATURE_ACTION_BAR)) != 0) {            layoutResource = a.getResourceId(                R.styleable.Window_windowActionBarFullscreenDecorLayout,                R.layout.screen_action_bar);        } else {            layoutResource = R.layout.screen_title;        }    } else {        // é»˜è®¤å¸ƒå±€æ ·å¼        layoutResource = R.layout.screen_simple;    }    // 6. é‡ç‚¹æ¥äº†ï¼šå°†å¯¹åº”çš„å¸ƒå±€åŠ è½½åˆ° DecorView ä¸­    mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);    return contentParent;}void onResourcesLoaded(LayoutInflater inflater, int layoutResource) {    // åŠ è½½èµ„æºæ–‡ä»¶    final View root = inflater.inflate(layoutResource, null);    ... ...    // 7. å°† View åŠ è½½åˆ°å½“å‰ DecorView ä¸­    addView(root, 0, new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));}public void addView(View child, int index, LayoutParams params) {    // é¡µé¢å‘ç”Ÿå˜åŒ–çš„è¯ï¼Œè¯·æ±‚é‡æ–°æ‘†æ”¾å¸ƒå±€ä»¥åŠé‡æ–°ç»˜åˆ¶    // æ³¨æ„ï¼Œæ­¤å¤„çš„ requestLayout æ˜¯ View çš„æ–¹æ³•    requestLayout();    invalidate(true);    addViewInner(child, index, params, false);}</code></pre><p>è¯´å‡ºæ¥ä½ å¯èƒ½ä¸ä¿¡ï¼Œä½†æ˜¯ setContentView() åˆ°è¿™é‡Œå°±å·®ä¸å¤šç»“æŸäº†ã€‚</p><p>å¾ˆæ˜æ˜¾ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰å‘ç°ä»»ä½•å…³äº View çš„æµ‹é‡çš„ä»£ç ï¼Œæœ€åçš„ requestLayout() å’Œ invalidate() ä¹Ÿå’Œ View çš„ measure() å…³ç³»ä¸å¤§ï¼Œæ¯•ç«Ÿè¿˜æ²¡æµ‹é‡ï¼Œå“ªé‡Œè°ˆå¾—ä¸Š layout å’Œ draw å‘¢ï¼Ÿ</p><p>æ‰€ä»¥ï¼Œ setContentView() å’Œ View çš„æµ‹é‡æ²¡å•¥å…³ç³»ï¼Œé‚£ä¹ˆåœ¨å…¶ä¹‹åä¹Ÿå°±è‡ªç„¶è·å–ä¸åˆ° View å®½é«˜çš„å€¼äº†ã€‚</p><h3 id="æµ‹é‡æµç¨‹åˆ°åº•æ˜¯ä»å“ªé‡Œå¼€å§‹çš„"><a href="#æµ‹é‡æµç¨‹åˆ°åº•æ˜¯ä»å“ªé‡Œå¼€å§‹çš„" class="headerlink" title="æµ‹é‡æµç¨‹åˆ°åº•æ˜¯ä»å“ªé‡Œå¼€å§‹çš„"></a>æµ‹é‡æµç¨‹åˆ°åº•æ˜¯ä»å“ªé‡Œå¼€å§‹çš„</h3><p>æœ‰äº†ä¸Šé¢çš„ç»éªŒï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼ŒsetContentView() å¹¶ä¸ä¼šè§¦å‘ View çš„æµ‹é‡ï¼Œè€Œåªæ˜¯ä¸º DecorView æŒ‡å®šäº†å¸ƒå±€ï¼›é‚£ä¹ˆæ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯ï¼Œæµ‹é‡æµç¨‹åˆ°åº•æ˜¯ä»å“ªé‡Œå¼€å§‹çš„å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬ç®€å•å›é¡¾ä¸€ä¸‹ Activity çš„å¯åŠ¨æµç¨‹ï¼Œç„¶åæ¥æ‰¾åˆ°è¿™ä¸ªç­”æ¡ˆã€‚</p><pre><code class="java">public void handleMessage(Message msg) {    switch (msg.what) {        case LAUNCH_ACTIVITY: {            // 1. ActivityThread å†…éƒ¨ç±» Hï¼Œå¤„ç† LAUNCH_ACTIVITY çš„æ¶ˆæ¯            handleLaunchActivity(r, null, &quot;LAUNCH_ACTIVITY&quot;);        } break; }// 2. ç›´æ¥ä» ActivityThread çš„ handleLaunchActivity() å¼€å§‹äº†private void handleLaunchActivity(ActivityClientRecord r, Intent customIntent, String reason) {    // 3. æ‰§è¡Œ performLaunchActivity() æ–¹æ³•    Activity a = performLaunchActivity(r, customIntent);    if (a != null) {        r.createdConfig = new Configuration(mConfiguration);        reportSizeConfigurations(r);        Bundle oldState = r.state;        // 4. æ‰§è¡Œ handleResumeActivity() æ–¹æ³•        handleResumeActivity(r.token, false, r.isForward,                             !r.activity.mFinished &amp;&amp; !r.startsNotResumed,                             r.lastProcessedSeq, reason);    }}// 3. performLaunchActivity()private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) {    // åŸºäºåå°„ï¼Œåˆ©ç”¨ Instrumentation å¯¹è±¡åˆ›å»ºå½“å‰ Activity çš„å®ä¾‹    Activity activity = null;    try {        java.lang.ClassLoader cl = appContext.getClassLoader();        activity = mInstrumentation.newActivity(            cl, component.getClassName(), r.intent);        StrictMode.incrementExpectedActivityCount(activity.getClass());        r.intent.setExtrasClassLoader(cl);        r.intent.prepareToEnterProcess();        if (r.state != null) {            r.state.setClassLoader(cl);        }    }    try {        if (activity != null) {            // attach() æ–¹æ³•åšäº†ä¸€ç³»åˆ—æœ€åŸºæœ¬çš„åˆå§‹åŒ–            activity.attach(appContext, this, getInstrumentation(), r.token,                            r.ident, app, r.intent, r.activityInfo, title, r.parent,                            r.embeddedID, r.lastNonConfigurationInstances, config,                            r.referrer, r.voiceInteractor, window, r.configCallback);            activity.mCalled = false;            // 3.1 ä¾ç„¶ä½¿ç”¨ Instrumentation å¯¹è±¡è°ƒç”¨ Activity çš„ onCreate() æ–¹æ³•            if (r.isPersistable()) {                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);            } else {                mInstrumentation.callActivityOnCreate(activity, r.state);            }            // å¼ºåˆ¶æ ¡éªŒ super è°ƒç”¨            if (!activity.mCalled) {                throw new SuperNotCalledException(                    &quot;Activity &quot; + r.intent.getComponent().toShortString() +                    &quot; did not call through to super.onCreate()&quot;);            }        }    }    return activity;}public void callActivityOnCreate(Activity activity, Bundle icicle,PersistableBundle persistentState) {    prePerformCreate(activity);    // 3.2 è°ƒç”¨ Activity çš„ performCreate() æ–¹æ³•    activity.performCreate(icicle, persistentState);    postPerformCreate(activity);}// 3.3 æœ€ç»ˆå¾—ä»¥è°ƒç”¨åˆ°å®é™…å®ç°çš„ onCreate()final void performCreate(Bundle icicle, PersistableBundle persistentState) {    restoreHasCurrentPermissionRequest(icicle);    onCreate(icicle, persistentState);    mActivityTransitionState.readState(icicle);    performCreateCommon();}// 4 performLaunchActivity() æ‰§è¡Œå®Œæ¯•åï¼Œæ ¹æ®ä»£ç æ¥çœ‹ï¼Œä¼šç»§ç»­æ‰§è¡Œ handleResumeActivity()// åŒæ ·çš„ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè°ƒç”¨åˆ°ä¸€ä¸ª performResumeActivity()ï¼Œåœ¨è¯¥æ–¹æ³•å†…éƒ¨ä¹Ÿä¼šæœ€ç»ˆæ‰§è¡Œåˆ° onResume() final void handleResumeActivity( ... ... ) {     // æœ€ç»ˆä¼šæ‰§è¡Œåˆ° onResume()ï¼Œä¸æ˜¯é‡ç‚¹     r = performResumeActivity(token, clearHide, reason);     if (r != null) {         final Activity a = r.activity;         if (r.window == null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) {             r.window = r.activity.getWindow();             View decor = r.window.getDecorView();             ViewManager wm = a.getWindowManager();             // 5. æ‰§è¡Œåˆ° WindowManagerImpl çš„ addView()             // ç„¶åä¼šè·³è½¬åˆ° WindowManagerGlobal çš„ addView()             if (a.mVisibleFromClient) {                 if (!a.mWindowAdded) {                     a.mWindowAdded = true;                     wm.addView(decor, l);                 }             }         }     } }public void addView( ... ... ) {     ViewRootImpl root;     synchronized (mLock) {         // åˆå§‹åŒ–ä¸€ä¸ª ViewRootImpl çš„å®ä¾‹         root = new ViewRootImpl(view.getContext(), display);         try {             // è°ƒç”¨ setViewï¼Œä¸º root å¸ƒå±€ setView             // å…¶ä¸­ view ä¸ºä¼ ä¸‹æ¥çš„ DecorView å¯¹è±¡             // ä¹Ÿå°±æ˜¯è¯´ï¼Œå®é™…ä¸Šæ ¹å¸ƒå±€å¹¶ä¸æ˜¯æˆ‘ä»¬è®¤ä¸ºçš„ DecorViewï¼Œè€Œæ˜¯ ViewRootImpl             root.setView(view, wparams, panelParentView);         }     }}// 6. å°† DecorView åŠ è½½åˆ° WindowManager, View çš„ç»˜åˆ¶æµç¨‹ä»æ­¤åˆ»æ‰å¼€å§‹public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) {    // è¯·æ±‚å¯¹ View è¿›è¡Œæµ‹é‡å’Œç»˜åˆ¶    // ä¸ setContentView() ä¸åŒï¼Œæ­¤å¤„çš„æ–¹æ³•æ˜¯ ViewRootImpl çš„æ–¹æ³•    requestLayout();}@Overridepublic void requestLayout() {    if (!mHandlingLayoutInLayoutRequest) {        checkThread();        mLayoutRequested = true;        // 7. æ­¤æ–¹æ³•å†…éƒ¨æœ‰ä¸€ä¸ª post äº†ä¸€ä¸ª Runnable å¯¹è±¡        // åœ¨å…¶ä¸­åˆè°ƒç”¨ä¸€ä¸ª doTraversal() æ–¹æ³•ï¼›        // å†ä¹‹ååˆä¼šè°ƒç”¨åˆ° performTraversals() æ–¹æ³•ï¼Œç„¶å View çš„æµ‹ç»˜æµç¨‹å°±ä»æ­¤å¤„å¼€å§‹äº†        scheduleTraversals();    }}private void performTraversals() {    ... ...    // Ask host how big it wants to be    performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);    ... ...    performLayout(lp, mWidth, mHeight);    ... ...    performDraw();    ... ...}</code></pre><p>é—®é¢˜åˆ°è¿™é‡Œå°±å·®ä¸å¤šå¾—åˆ°äº†è§£ç­”ï¼ŒView çš„æµ‹ç»˜æµç¨‹æ˜¯åœ¨ performTraversals() æ‰å¼€å§‹çš„ï¼›è€Œè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨æ˜¯åœ¨ onResume() æ–¹æ³•ä¹‹åï¼Œæ‰€ä»¥åœ¨ onCreate() å’Œ onResume() æ–¹æ³•ä¸­æ‹¿ä¸åˆ° View çš„å®½é«˜ä¿¡æ¯ä¹Ÿå°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç»å†è¿‡ä¸€æ®µæ—¶é—´çš„å¼€å‘ä»¥åï¼Œæˆ‘ä»¬éƒ½ä¼šå‘ç° onCreate() å’Œ onResume() é‡Œæ— æ³•è·å–åˆ° View çš„å®½é«˜ä¿¡æ¯ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ˜æ˜ setContentView äº†ä¸æ˜¯å—ï¼Ÿä»Šå¤©æˆ‘ä»¬å°±æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://joeljt.top/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Android å­—ä½“å˜è‰²</title>
    <link href="http://joeljt.top/2018/08/12/color-track-textview/"/>
    <id>http://joeljt.top/2018/08/12/color-track-textview/</id>
    <published>2018-08-11T16:00:00.000Z</published>
    <updated>2019-03-21T10:33:43.994Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><blockquote><p>ä¸»è¦æŠ€æœ¯ç‚¹ï¼šCanvas.clipRect()</p></blockquote><p>å®é™…ä¸Šï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥ç†è§£æˆè£å‰ªç”»å¸ƒï¼›</p><p>æ–¹æ³•æ¥æ”¶ä¸€ä¸ª Rect å¯¹è±¡ï¼Œè€Œ Rect å¯¹è±¡åŒæ ·æ¥æ”¶å·¦ä¸Šé¡¶ç‚¹å’Œå³ä¸‹é¡¶ç‚¹ä¸¤ä¸ªåæ ‡ä½œä¸ºå‚æ•°ï¼Œç”¨äºç¡®è®¤ä¸€å—åŒºåŸŸï¼›</p><p>è€Œè¿™å—åŒºåŸŸï¼Œå°±æ˜¯æ¥ä¸‹æ¥å°†è¦è¿›è¡Œç»˜åˆ¶çš„åŒºåŸŸã€‚</p><p>é€šè¿‡å¯¹ç”»å¸ƒè¿›è¡Œä¸æ–­çš„è£å‰ªï¼ŒåŒæ—¶å¯¹å·¦å³ä¸¤ä¾§ä½¿ç”¨ä¸åŒé¢œè‰²çš„ç”»ç¬”å¯¹ç›¸åŒçš„æ–‡å­—è¿›è¡Œç»˜åˆ¶ï¼Œæ¥å®ç°ä¸€ä¸ªæ–‡æœ¬ä¸¤ç§é¢œè‰²çš„æ•ˆæœã€‚</p><pre><code class="java">@Overrideprotected void onDraw(Canvas canvas) {    // ç»˜åˆ¶å‰ä¸€åŠå†…å®¹    drawText(canvas, mChangePaint, 0, getWidth()/2);    // ä½¿ç”¨å¦ä¸€é¢œè‰²çš„ç”»ç¬”ç»˜åˆ¶åä¸€åŠå†…å®¹    drawText(canvas, mOriginPaint, getWidth() / 2, getWidth());}private void drawText(Canvas canvas, Paint paint, int start, int end) {    paint.setTextSize(getTextSize());    // ä¿å­˜å½“å‰ç”»å¸ƒçŠ¶æ€    canvas.save();    // ä½¿ç”¨ .clipRect() æ–¹æ³•åˆ‡å‰²ç”»å¸ƒï¼Œç„¶åä½¿ç”¨ä¸åŒé¢œè‰²çš„ç”»ç¬”å¯¹ç›®æ ‡æ–‡å­—è¿›è¡Œç»˜åˆ¶    Rect rect = new Rect(start, 0, end, getHeight());    canvas.clipRect(rect);    // è·å–æ–‡å­—çš„åŸºæœ¬å®½é«˜ä¿¡æ¯    String text = getText().toString();    Rect textBounds = new Rect();    paint.getTextBounds(text, 0, text.length(), textBounds);    Paint.FontMetricsInt metrics = paint.getFontMetricsInt();    // è·å–èµ·å§‹ä½ç½®    int x = getWidth() / 2 - textBounds.width() / 2;    int y = getHeight() / 2 + (metrics.bottom - metrics.top) / 2 - metrics.bottom;    canvas.drawText(text, x, y, paint);    // æ¸…ç©ºç”»å¸ƒå±æ€§ï¼Œæ–¹ä¾¿æ¥ä¸‹æ¥ç»˜åˆ¶å˜è‰²çš„éƒ¨åˆ†    canvas.restore();}</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;blockquote&gt;
&lt;p&gt;ä¸»è¦æŠ€æœ¯ç‚¹ï¼šCanvas.clipRect()&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å®é™…ä¸Šï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥ç†è§£æˆè£å‰ªç”»å¸ƒï¼›&lt;/p&gt;
&lt;p&gt;æ–¹æ³•æ¥æ”¶ä¸€ä¸ª Rect å¯¹è±¡ï¼Œè€Œ Rect å¯¹è±¡åŒæ ·æ¥æ”¶å·¦ä¸Šé¡¶ç‚¹å’Œå³ä¸‹
      
    
    </summary>
    
    
      <category term="Android" scheme="http://joeljt.top/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>Canvas.drawPath() ç®€å•ä½¿ç”¨è®°å½•</title>
    <link href="http://joeljt.top/2018/05/28/Canvas.drawPath()/"/>
    <id>http://joeljt.top/2018/05/28/Canvas.drawPath()/</id>
    <published>2018-05-27T16:00:00.000Z</published>
    <updated>2019-03-21T10:55:48.335Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><blockquote><p>Pathç±»å°†å¤šç§å¤åˆè·¯å¾„ï¼ˆå¤šä¸ªè½®å»“ï¼Œå¦‚ç›´çº¿æ®µã€äºŒæ¬¡æ›²çº¿ã€ç«‹æ–¹æ›²çº¿ï¼‰å°è£…åœ¨å…¶å†…éƒ¨çš„å‡ ä½•è·¯å¾„ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ drawPath() æ¥ç»˜åˆ¶ä¸€ä¸ªå¤šè¾¹å½¢æˆ–è€…ä¸è§„åˆ™å›¾å½¢ã€‚</p></blockquote><p>ä¸‹é¢ä»¥ç­‰è¾¹ä¸‰è§’å½¢ä¸ºä¾‹ï¼š</p><pre><code class="java">// å‡è®¾åœ¨å›ºå®šå¤§å°å†…ç»˜åˆ¶ä¸€ä¸ªç­‰è¾¹ä¸‰è§’å½¢private void drawTriangle(Canvas canvas, Paint paint) {    Path mPath = new Path();    // moveTo ç§»åŠ¨åˆ°æŸä¸€ç‚¹ï¼Œç”¨äºç¡®å®šä¸‹ç¬”åæ ‡    mPath.moveTo(getWidth() / 2, 0);    // è¿çº¿åˆ°æŸä¸€ç‚¹ï¼Œå¼€å§‹ç»˜åˆ¶ï¼Œç›®æ ‡ç‚¹ y åæ ‡æ˜¯é•¿ç›´è§’è¾¹çš„é•¿åº¦    // ç­‰è¾¹ä¸‰è§’å½¢ï¼Œä»é¡¶ç‚¹å‘ä¸‹åšé«˜ï¼ŒçŸ­ç›´è§’è¾¹:æ–œè¾¹:é•¿ç›´è§’è¾¹ = 1:2:âˆš3    mPath.lineTo(0, getWidth() / 2 * Math.sqrt(3)));    mPath.lineTo(getWidth(), getWidth() / 2 * Math.sqrt(3)));    // é—­åˆå¤šè¾¹å½¢ï¼Œå³è¿çº¿å›åˆ°èµ·å§‹ç‚¹ï¼Œå®Œæˆç»˜åˆ¶    mPath.close();    canvas.drawPath(mPath, mPaint);}</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;
&lt;blockquote&gt;
&lt;p&gt;Pathç±»å°†å¤šç§å¤åˆè·¯å¾„ï¼ˆå¤šä¸ªè½®å»“ï¼Œå¦‚ç›´çº¿æ®µã€äºŒæ¬¡æ›²çº¿ã€ç«‹æ–¹æ›²çº¿ï¼‰å°è£…åœ¨å…¶å†…éƒ¨çš„å‡ ä½•è·¯å¾„ã€‚&lt;/p&gt;
&lt;p&gt;ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ drawPath() æ¥ç»˜åˆ¶ä¸€ä¸ªå¤šè¾¹å½¢æˆ–è€…ä¸è§„åˆ™å›¾å½¢ã€‚&lt;/p&gt;
&lt;/blockqu
      
    
    </summary>
    
    
      <category term="Android" scheme="http://joeljt.top/tags/Android/"/>
    
  </entry>
  
  <entry>
    <title>è§£å†³å¯è§†åŒ–å·¥å…·å¯¹äº MySQL 8.0 + æ— æ³•è¿æ¥çš„é—®é¢˜</title>
    <link href="http://joeljt.top/2018/05/28/bug-of-mysql/"/>
    <id>http://joeljt.top/2018/05/28/bug-of-mysql/</id>
    <published>2018-05-27T16:00:00.000Z</published>
    <updated>2018-08-14T10:11:51.791Z</updated>
    
    <content type="html"><![CDATA[<p>MySQL 8.0 ç‰ˆæœ¬å»é™¤äº† password å­—æ®µï¼Œæ”¹ç”¨ authentication_string å­—æ®µï¼Œå¯¼è‡´ç½‘ä¸Šå¯ä»¥æœåˆ°çš„å„ç§é—®é¢˜çš„å„ç§è§£å†³æ–¹æ³•å®Œå…¨æ²¡æœ‰æ•ˆæœã€‚</p><a id="more"></a><p>åŒæ—¶è¿˜æ›´æ”¹äº†åŠ å¯†æ–¹å¼ï¼Œä¹‹å‰ç‰ˆæœ¬çš„åŠ å¯†æ–¹å¼æ˜¯ã€Œmysql_native_passwordã€ï¼Œ8.0 ä¹‹åçš„åŠ å¯†è§„åˆ™æ›´æ”¹ä¸ºã€Œcaching_sha2_password ã€ï¼Œè¿™é‡Œéœ€è¦æŠŠç”¨æˆ·å¯†ç åŠ å¯†è§„åˆ™æ›´æ”¹ä¸ºåŸæ¥çš„åŠ å¯†æ–¹å¼å³å¯ã€‚</p><p>å…·ä½“æ–¹æ³•æ­¥éª¤å¦‚ä¸‹ï¼Œè®°å½•å¤‡å¿˜ï¼š</p><blockquote><p> æ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥å‘½ä»¤</p></blockquote><pre><code class="mysql">mysql -u root -p</code></pre><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒMySQL è®¾ç½®çš„å¯†ç ä¸­å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ªå¤§å†™å­—æ¯ã€ä¸€ä¸ªå°å†™å­—æ¯ã€ä¸€ä¸ªç‰¹æ®Šç¬¦å·ã€ä¸€ä¸ªæ•°å­—ï¼Œè‡³å°‘ 8 ä¸ªå­—ç¬¦ï¼›å¯†ç æ˜¯åœ¨æœ€å¼€å§‹å®‰è£… MySQL çš„æ—¶å€™è®¾ç½®çš„ï¼Œå¦‚æœå¿˜è®°äº†ï¼Œä¸Šç½‘æŸ¥è¯¢è§£å†³æ–¹æ³•ã€‚</p></blockquote><blockquote><p>è¾“å…¥å¯†ç åï¼Œè¿›å…¥ &gt;mysql çš„å‘½ä»¤è¡Œæ¨¡å¼</p></blockquote><pre><code class="mysql"># åˆ‡æ¢åˆ° mysql æ•°æ®åº“use mysql;# è®¾ç½®ç”¨æˆ·å¯†ç æ°¸ä¸è¿‡æœŸalter user &#39;root&#39;@&#39;localhost&#39; identified by &#39;your pwd&#39; password expire never;# ç”¨ã€Œmysql_native_passwordã€åŠ å¯†æ–¹å¼æ›´æ–° root ç”¨æˆ·å¯†ç alter user &#39;root&#39;@&#39;localhost&#39; identified with mysql_native_password by &#39;your pwd&#39;;# åˆ·æ–°flush privileges;</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;MySQL 8.0 ç‰ˆæœ¬å»é™¤äº† password å­—æ®µï¼Œæ”¹ç”¨ authentication_string å­—æ®µï¼Œå¯¼è‡´ç½‘ä¸Šå¯ä»¥æœåˆ°çš„å„ç§é—®é¢˜çš„å„ç§è§£å†³æ–¹æ³•å®Œå…¨æ²¡æœ‰æ•ˆæœã€‚&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Android Paint .measureText() VS .getTextBounds()</title>
    <link href="http://joeljt.top/2018/03/29/Android%20Paint-%20.measureText()%20VS%20.getTextBounds()/"/>
    <id>http://joeljt.top/2018/03/29/Android Paint- .measureText() VS .getTextBounds()/</id>
    <published>2018-03-28T16:00:00.000Z</published>
    <updated>2018-11-26T10:43:06.981Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸¤ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥æµ‹é‡æ–‡å­—å®½é«˜ä¿¡æ¯çš„ï¼Œåªä¸è¿‡ <strong>.getTextBounds()</strong> è¿˜å¯ä»¥è·å¾—é«˜åº¦ä¿¡æ¯ï¼Œå› ä¸ºå…¶ä½¿ç”¨ä¸€ä¸ª Rect å¯¹è±¡å¯¹å®½é«˜ä¿¡æ¯è¿›è¡Œå­˜å‚¨ï¼›è€Œ <strong>.measureText()</strong> åˆ™åªæ˜¯è¿”å›å®½åº¦ä¿¡æ¯ã€‚</p><a id="more"></a><p>å…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p><pre><code class="java">final String someText = &quot;Hello. I&#39;m some text!&quot;;Paint mPaint = new Paint();// .measureText()float measuredWidth = mPaint.measureText(someText);// .getTextBounds()Rect mBounds = new Rect();mPaint.getTextBounds(someText, 0, someText.length, mBounds);int measuredWidth = mBounds.width();int measuredHeight = mBounds.height();</code></pre><p>ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬æŠŠä¸¤ä¸ªç»“æœæ‰“å°å‡ºæ¥ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œå¯¹äºåŒä¸€ä¸ªæ–‡æœ¬ä¿¡æ¯ï¼Œä½¿ç”¨ä¸¤ä¸ªæ–¹æ³•å¾—åˆ°çš„å®½åº¦æ˜¯ä¸åŒçš„ï¼š</p><pre><code class="java">// æ‰“å°å®½åº¦ä¿¡æ¯Log.d(&quot;Test&quot;, String.format(        &quot;Text is &#39;%s&#39;, measureText %f, getTextBounds %d&quot;,        someText,        measuredWidth,        mBounds.width())    );// æ‰“å°ç»“æœå¦‚ä¸‹// Text is &#39;Hello. I&#39;m some text!&#39;, measureText 115.000000, getTextBounds 105</code></pre><p>ç»è¿‡ä¸€ç³»åˆ—çš„æ¢ç©¶å’Œèµ„æ–™æŸ¥çœ‹ï¼Œæœ€åå¾—åˆ°çš„ç»“è®ºæ˜¯ï¼š</p><blockquote><p>äºŒè€…è¿”å›ç»“æœç¡®å®ä¸åŒï¼Œä¸” measureText() è¿”å›ç»“æœä¼šç•¥å¾®å¤§äº getTextBounds() æ‰€å¾—åˆ°çš„å®½åº¦ä¿¡æ¯</p><p>measureText() ä¼šåœ¨æ–‡æœ¬çš„å·¦å³ä¸¤ä¾§åŠ ä¸Šä¸€äº›é¢å¤–çš„å®½åº¦ï¼Œè¿™éƒ¨åˆ†é¢å¤–çš„å®½åº¦å«åš Glyphâ€™s AdvanceX ï¼ˆå…·ä½“åº”è¯¥æ˜¯å±äºå­—å‹æ–¹é¢çš„èŒƒç•´ï¼Œæˆ‘çŒœæµ‹è¿™éƒ¨åˆ†å®½åº¦æ˜¯ç±»ä¼¼å­—é—´è·ä¹‹ç±»çš„ä¸œè¥¿ï¼‰</p><p>getTextBounds() è¿”å›çš„åˆ™æ˜¯å½“å‰æ–‡æœ¬æ‰€éœ€è¦çš„æœ€å°å®½åº¦ï¼Œä¹Ÿå°±æ˜¯æ•´ä¸ªæ–‡æœ¬å¤–åˆ‡çŸ©å½¢çš„å®½åº¦</p></blockquote><p>å®é™…ä¸Šï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åœ¨å…·ä½“è°ƒç”¨æ—¶è™½ç„¶éƒ½æ˜¯ä¸åŒçš„æ–¹æ³•ï¼Œä½†åœ¨ native å±‚çš„æµ‹é‡ç®—æ³•éƒ½æ˜¯ä¸€è‡´çš„ï¼Œåªä¸è¿‡åœ¨æœ€åè¿”å›æ—¶ï¼ŒmeasureText() ä¼šåœ¨å·¦å³ä¸¤ä¾§åŠ ä¸Šä¸€äº›é¢å¤–çš„å®½åº¦å€¼ï¼Œè€Œ getTextBounds() åˆ™æ˜¯è¿”å›éœ€è¦çš„æœ€å°å®½åº¦è€Œå·²ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸¤ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥æµ‹é‡æ–‡å­—å®½é«˜ä¿¡æ¯çš„ï¼Œåªä¸è¿‡ &lt;strong&gt;.getTextBounds()&lt;/strong&gt; è¿˜å¯ä»¥è·å¾—é«˜åº¦ä¿¡æ¯ï¼Œå› ä¸ºå…¶ä½¿ç”¨ä¸€ä¸ª Rect å¯¹è±¡å¯¹å®½é«˜ä¿¡æ¯è¿›è¡Œå­˜å‚¨ï¼›è€Œ &lt;strong&gt;.measureText()&lt;/strong&gt; åˆ™åªæ˜¯è¿”å›å®½åº¦ä¿¡æ¯ã€‚&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>å­—ä½“å˜è‰²æ•ˆæœå®ç°åˆ†æ</title>
    <link href="http://joeljt.top/2018/03/19/TrackColorTextView/"/>
    <id>http://joeljt.top/2018/03/19/TrackColorTextView/</id>
    <published>2018-03-18T16:00:00.000Z</published>
    <updated>2018-11-26T10:40:37.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä¸»è¦æŠ€æœ¯ç‚¹ï¼šCanvas.clipRect()</p></blockquote><p>å®é™…ä¸Šï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥ç†è§£æˆè£å‰ªç”»å¸ƒï¼›</p><p>æ–¹æ³•æ¥æ”¶ä¸€ä¸ª Rect å¯¹è±¡ï¼Œè€Œ Rect å¯¹è±¡åŒæ ·æ¥æ”¶å·¦ä¸Šé¡¶ç‚¹å’Œå³ä¸‹é¡¶ç‚¹ä¸¤ä¸ªåæ ‡ä½œä¸ºå‚æ•°ï¼Œç”¨äºç¡®è®¤ä¸€å—åŒºåŸŸï¼›</p><p>è€Œè¿™å—åŒºåŸŸï¼Œå°±æ˜¯æ¥ä¸‹æ¥å°†è¦è¿›è¡Œç»˜åˆ¶çš„åŒºåŸŸã€‚</p><p>é€šè¿‡å¯¹ç”»å¸ƒè¿›è¡Œä¸æ–­çš„è£å‰ªï¼ŒåŒæ—¶å¯¹å·¦å³ä¸¤ä¾§ä½¿ç”¨ä¸åŒé¢œè‰²çš„ç”»ç¬”å¯¹ç›¸åŒçš„æ–‡å­—è¿›è¡Œç»˜åˆ¶ï¼Œæ¥å®ç°ä¸€ä¸ªæ–‡æœ¬ä¸¤ç§é¢œè‰²çš„æ•ˆæœã€‚</p><pre><code class="java">@Overrideprotected void onDraw(Canvas canvas) {    // ç»˜åˆ¶å‰ä¸€åŠå†…å®¹    drawText(canvas, mChangePaint, 0, getWidth()/2);    // ä½¿ç”¨å¦ä¸€é¢œè‰²çš„ç”»ç¬”ç»˜åˆ¶åä¸€åŠå†…å®¹    drawText(canvas, mOriginPaint, getWidth() / 2, getWidth());}private void drawText(Canvas canvas, Paint paint, int start, int end) {    paint.setTextSize(getTextSize());    // ä¿å­˜å½“å‰ç”»å¸ƒçŠ¶æ€    canvas.save();    // ä½¿ç”¨ .clipRect() æ–¹æ³•åˆ‡å‰²ç”»å¸ƒï¼Œç„¶åä½¿ç”¨ä¸åŒé¢œè‰²çš„ç”»ç¬”å¯¹ç›®æ ‡æ–‡å­—è¿›è¡Œç»˜åˆ¶    Rect rect = new Rect(start, 0, end, getHeight());    canvas.clipRect(rect);    // è·å–æ–‡å­—çš„åŸºæœ¬å®½é«˜ä¿¡æ¯    String text = getText().toString();    Rect textBounds = new Rect();    paint.getTextBounds(text, 0, text.length(), textBounds);    Paint.FontMetricsInt metrics = paint.getFontMetricsInt();    // è·å–èµ·å§‹ä½ç½®    int x = getWidth() / 2 - textBounds.width() / 2;    int y = getHeight() / 2 + (metrics.bottom - metrics.top) / 2 - metrics.bottom;    canvas.drawText(text, x, y, paint);    // æ¸…ç©ºç”»å¸ƒå±æ€§ï¼Œæ–¹ä¾¿æ¥ä¸‹æ¥ç»˜åˆ¶å˜è‰²çš„éƒ¨åˆ†    canvas.restore();}</code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;ä¸»è¦æŠ€æœ¯ç‚¹ï¼šCanvas.clipRect()&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å®é™…ä¸Šï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥ç†è§£æˆè£å‰ªç”»å¸ƒï¼›&lt;/p&gt;
&lt;p&gt;æ–¹æ³•æ¥æ”¶ä¸€ä¸ª Rect å¯¹è±¡ï¼Œè€Œ Rect å¯¹è±¡åŒæ ·æ¥æ”¶å·¦ä¸Šé¡¶ç‚¹å’Œå³ä¸‹é¡¶ç‚¹ä¸¤ä¸ªåæ ‡ä½œä¸ºå‚æ•°ï¼Œç”¨äºç¡®è®¤ä¸€å—åŒº
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>javaä¸­å¤šæ€çš„å…·ä½“åº”ç”¨</title>
    <link href="http://joeljt.top/2018/03/09/polymorphism-of-java/"/>
    <id>http://joeljt.top/2018/03/09/polymorphism-of-java/</id>
    <published>2018-03-08T16:00:00.000Z</published>
    <updated>2018-08-14T10:11:51.791Z</updated>
    
    <content type="html"><![CDATA[<p>å®é™…ä½¿ç”¨å¤šæ€æ—¶ï¼Œå…³äºæˆå‘˜å˜é‡å’Œæˆå‘˜å‡½æ•°çš„è°ƒç”¨ï¼Œåœ¨ç¼–è¯‘æœŸå’Œè¿è¡Œæ—¶æœ‰æ‰€ä¸åŒï¼Œå…·ä½“ä»£ç ç¤ºä¾‹</p><pre><code>// çˆ¶ç±»public class Parent {    public int aInt = -1;    public void func1() {        System.err.print(&quot; Parent func1 &quot;);    }    public void func2() {        System.err.print(&quot; Parent func2 &quot;);    }}</code></pre><pre><code>// å­ç±»public class Child extends Parent {    public int aInt = 1;    public void func1() {        System.err.print(&quot; Child func1 &quot;);    }    public void func3() {        System.err.print(&quot; Child func3 &quot;);    }}</code></pre><h4 id="æˆå‘˜å‡½æ•°"><a href="#æˆå‘˜å‡½æ•°" class="headerlink" title="æˆå‘˜å‡½æ•°"></a>æˆå‘˜å‡½æ•°</h4><pre><code>// test main()public static void main(String[] args) {    Child child = new Child();    child.func1();    child.func2();    child.func3();    Parent parent = new Child();    parent.func1();    parent.func2();    parent.func3();}</code></pre><p>å¦‚ä¸Šæ‰€ç¤ºï¼Œå°†å¯¹è±¡å£°æ˜ä¸ºChildå¯¹è±¡æ—¶ï¼Œä¸‰ä¸ªæ–¹æ³•éƒ½ç¼–è¯‘é€šè¿‡ï¼Œä¸”è¾“å…¥ç»“æœå¦‚ä¸‹ï¼š</p><pre><code>Child func1Parent func2Child func3</code></pre><p>Childç±»é‡å†™äº†çˆ¶ç±»çš„func1()æ–¹æ³•ï¼Œåˆ™åœ¨è¿è¡Œæ—¶åŒ¹é…äº†å­ç±»è‡ªèº«çš„é‡å†™æ–¹æ³•ï¼Œå³ï¼Œã€Œè¿è¡Œæ—¶éµå¾ªå³ä¾§å£°æ˜ã€ã€‚<br>ä½†æ˜¯ï¼Œå¦‚æœå°†å¯¹è±¡å£°æ˜ä¸ºParentå¯¹è±¡æ—¶ï¼Œparent.fun3()åˆ™ä¼šæŠ¥é”™ï¼Œå› ä¸ºã€Œç¼–è¯‘æœŸéµå¾ªå·¦ä¾§å®ä¾‹ã€ï¼Œå½“å‰å¯¹è±¡è¢«å£°æ˜ä¸ºParentå®ä¾‹ï¼Œè€ŒParentä¸­æ²¡æœ‰func3()æ–¹æ³•ï¼Œæ‰€ä»¥ç¼–è¯‘ä¸é€šè¿‡ã€‚åŒæ—¶ä¹Ÿæ­£å› ä¸ºã€Œè¿è¡Œæ—¶éµå¾ªå³ä¾§å£°æ˜ã€ï¼Œæ‰€ä»¥å…¶è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><pre><code>Child func1 // å°½ç®¡å£°æ˜ä¸ºParentå®ä¾‹ï¼Œä½†å®é™…è°ƒç”¨Childçš„æ–¹æ³•Parent func2</code></pre><p>ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨å¤šæ€ä½¿ç”¨æ—¶ï¼Œæˆå‘˜å‡½æ•°éµå¾ªä¸¤ä¸ªåŸåˆ™ï¼Œå³ã€Œç¼–è¯‘æœŸéµå¾ªå·¦ä¾§å®ä¾‹ï¼Œè¿è¡Œæ—¶éµå¾ªå³ä¾§å£°æ˜ã€</p><h4 id="æˆå‘˜å˜é‡"><a href="#æˆå‘˜å˜é‡" class="headerlink" title="æˆå‘˜å˜é‡"></a>æˆå‘˜å˜é‡</h4><pre><code>// test main()public static void main(String[] args) {    Parent parent = new Child();    Child child = new Child();    System.err.println(parent.aInt);    System.err.println(child.aInt);}</code></pre><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><pre><code>-11</code></pre><p>å¯ä»¥å‘ç°ï¼Œæ‰“å°ç»“æœä¸æˆå‘˜å‡½æ•°æœ‰æ‰€ä¸åŒã€‚å› ä¸ºå¦‚æœæ˜¯æˆå‘˜å‡½æ•°ï¼Œè¿è¡Œæ—¶éµå¾ªå³ä¾§å£°æ˜çš„è¯ï¼Œæ‰“å°ç»“æœåº”è¯¥ç›¸ç­‰ï¼ŒåŒä¸º1æ‰å¯¹ã€‚å› æ­¤ï¼Œæˆå‘˜å˜é‡åœ¨å¤šæ€æƒ…å¢ƒä¸‹çš„ä½¿ç”¨ï¼Œæ— è®ºç¼–è¯‘è¿˜æ˜¯è¿è¡Œï¼Œé€šé€šéµå¾ªå·¦ä¾§å®ä¾‹ã€‚</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ul><li>æˆå‘˜å‡½æ•°<br>ç¼–è¯‘æ—¶éµå¾ªå·¦ä¾§å®ä¾‹ï¼Œè¿è¡Œæ—¶éµå¾ªå³ä¾§å£°æ˜</li><li>æˆå‘˜å˜é‡<br>ç¼–è¯‘æˆ–è€…è¿è¡Œä¸€å¾‹éµå¾ªå·¦ä¾§å®ä¾‹</li></ul><p>å…¶å®ä¹Ÿæ¯”è¾ƒå¥½ç†è§£ï¼Œç¼–è¯‘æœŸé—´ï¼Œå½“å‰ç±»ä¸‹ä¸å­˜åœ¨çš„æˆå‘˜å‡½æ•°æˆ–æˆå‘˜å˜é‡ï¼Œè‚¯å®šæ˜¯æ— æ³•è¢«å®ä¾‹å¯¹è±¡è·å–åˆ°çš„ï¼›<br>è€Œåœ¨è¿è¡Œæ—¶ï¼Œjavaä¸­å­ç±»å¯ä»¥é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œå› æ­¤æˆå‘˜å‡½æ•°è¿è¡Œæ—¶ä¼šæ­£ç¡®æŒ‡å‘å­ç±»çš„æ–¹æ³•ï¼Œä½†æ˜¯ï¼Œå­ç±»å¹¶ä¸å¯ä»¥é‡å†™çˆ¶ç±»çš„å˜é‡ï¼Œå½“å­ç±»ä¸çˆ¶ç±»æœ‰åŒåå˜é‡æ—¶ï¼Œéœ€è¦ä½¿ç”¨thiså’Œsuperå…³é”®å­—è¿›è¡ŒåŒºåˆ†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆå‘˜å˜é‡çš„è®¿é—®åˆ™ä¸å¯èƒ½åƒæ–¹æ³•ä¸€æ ·ä½¿ç”¨å¤šæ€è®¿é—®ï¼Œå› æ­¤åªèƒ½æ˜¯éµå¾ªå·¦ä¾§çš„å®ä¾‹äº†ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å®é™…ä½¿ç”¨å¤šæ€æ—¶ï¼Œå…³äºæˆå‘˜å˜é‡å’Œæˆå‘˜å‡½æ•°çš„è°ƒç”¨ï¼Œåœ¨ç¼–è¯‘æœŸå’Œè¿è¡Œæ—¶æœ‰æ‰€ä¸åŒï¼Œå…·ä½“ä»£ç ç¤ºä¾‹&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;// çˆ¶ç±»
public class Parent {
    public int aInt = -1;
    public void func1() {
      
    
    </summary>
    
    
      <category term="javaåŸºç¡€" scheme="http://joeljt.top/tags/java%E5%9F%BA%E7%A1%80/"/>
    
  </entry>
  
  <entry>
    <title>æŠ½è±¡ç±»å’Œæ¥å£çš„åŒºåˆ«</title>
    <link href="http://joeljt.top/2018/03/09/differ-of-abstract-interface/"/>
    <id>http://joeljt.top/2018/03/09/differ-of-abstract-interface/</id>
    <published>2018-03-08T16:00:00.000Z</published>
    <updated>2018-08-14T10:11:51.791Z</updated>
    
    <content type="html"><![CDATA[<p>å…ˆæ¥ä¸€ä¸ªé—®é¢˜ï¼Œjavaä¸­å…è®¸å¤šç»§æ‰¿å—ï¼Ÿ</p><h2 id="æŠ½è±¡ç±»-å•ç»§æ‰¿"><a href="#æŠ½è±¡ç±»-å•ç»§æ‰¿" class="headerlink" title="æŠ½è±¡ç±» - å•ç»§æ‰¿"></a>æŠ½è±¡ç±» - å•ç»§æ‰¿</h2><ul><li>å…³é”®å­—ä¸ºabstract, extends, è¢«ç±»æ‰€ç»§æ‰¿</li><li>ä¸å¯ä»¥è¢«finalä¿®é¥°</li><li>æŠ½è±¡æ–¹æ³•ä¸å¯ä»¥è¢«privateä¿®é¥°ï¼Œä½†å…¶ä»–ä¸‰ä¸ªä¸å—é™åˆ¶</li><li>æŠ½è±¡æ–¹æ³•ä¸€å®šå­˜åœ¨äºæŠ½è±¡ç±»ä¸­ï¼Œä½†æ˜¯æŠ½è±¡ç±»ä¸­ä¸ä¸€å®šæœ‰æŠ½è±¡æ–¹æ³•</li><li>æŠ½è±¡ç±»çš„å­ç±»å¿…é¡»å…¨éƒ¨é‡å†™æŠ½è±¡æ–¹æ³•ï¼Œå¦‚æœåªé‡å†™éƒ¨åˆ†æŠ½è±¡æ–¹æ³•ï¼Œåˆ™è¯¥å­ç±»åŒæ ·ä¸ºæŠ½è±¡æ–¹æ³•</li><li>æŠ½è±¡ç±»ä¸­ä¸ä¸€å®šå…¨éƒ¨éƒ½æ˜¯æŠ½è±¡æ–¹æ³•ï¼Œæ–¹æ³•å¯ä»¥æœ‰æ–¹æ³•ä½“</li><li>æŠ½è±¡ç±»ä¸å¯ä»¥å®ä¾‹åŒ–å¯¹è±¡</li><li>æŠ½è±¡ç±»å¯ä»¥å®ç°æ¥å£ï¼Œå› ä¸ºæ¥å£çš„å†…å®¹ä¹Ÿéƒ½æ˜¯æŠ½è±¡çš„</li></ul><h2 id="æ¥å£-å¤šå®ç°"><a href="#æ¥å£-å¤šå®ç°" class="headerlink" title="æ¥å£ - å¤šå®ç°"></a>æ¥å£ - å¤šå®ç°</h2><ul><li>å…³é”®å­—ä¸ºinterface, implements, è¢«ç±»æ‰€å®ç°</li><li>åŒæ ·ä¸å¯ä»¥è¢«finalä¿®é¥°</li><li>æ¥å£åªå…è®¸ä¸‰ç§æˆå‘˜å­˜åœ¨ï¼š<ol><li>å…¬å…±çš„é™æ€å¸¸é‡ public final static</li><li>å…¬å…±çš„æŠ½è±¡æ–¹æ³• public abstract</li><li>é™æ€å†…éƒ¨ç±» static class</li></ol></li><li>ç”±ä¸Šå¯çŸ¥ï¼Œæ¥å£çš„ä½œç”¨åŸŸå¿…é¡»ä¸ºpublic</li><li>æ¥å£çš„æŠ½è±¡æ–¹æ³•ä¹Ÿå¿…é¡»å…¨éƒ¨è¢«å®ç°ç±»æ‰€é‡å†™ï¼Œå¦åˆ™å®ç°ç±»ä¸ºæŠ½è±¡ç±»</li><li>ä¸åŒçš„æ¥å£ä¹‹é—´ä¸ºç»§æ‰¿å…³ç³»ï¼Œè€Œä¸”å¯ä»¥å¤šç»§æ‰¿</li><li>æ¥å£ä¸å¯ä»¥å®ä¾‹åŒ–å¯¹è±¡</li><li>æ¥å£ä¸å¯ä»¥ç»§æ‰¿æŠ½è±¡ç±»ï¼Œå› ä¸ºæŠ½è±¡ç±»ä¸­æœ‰å¯èƒ½å­˜åœ¨éæŠ½è±¡æ–¹æ³•ï¼Œä¸æ¥å£çš„æ¦‚å¿µç›¸æ‚–</li></ul><h2 id="äºŒè€…åŒºåˆ«"><a href="#äºŒè€…åŒºåˆ«" class="headerlink" title="äºŒè€…åŒºåˆ«"></a>äºŒè€…åŒºåˆ«</h2><ul><li>æ¯ä¸ªç±»åªèƒ½ç»§æ‰¿ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä½†æ˜¯å¯ä»¥å®ç°å¤šä¸ªæ¥å£</li><li>æŠ½è±¡ç±»å¯ä»¥æœ‰éæŠ½è±¡æ–¹æ³•ï¼Œæ¥å£å…¨éƒ¨ä¸ºæŠ½è±¡æ–¹æ³•</li><li>ä»ä½œç”¨åŸŸè§’åº¦çœ‹ï¼ŒæŠ½è±¡ç±»ä¸­æŠ½è±¡æ–¹æ³•ä¸èƒ½ä¸ºprivateï¼Œè€Œæ¥å£å¼ºåˆ¶ä¸ºpublic abstract</li><li>æŠ½è±¡ç±»å¯ä»¥å®ç°æ¥å£ï¼Œä½†æ˜¯æ¥å£ä¸èƒ½ç»§æ‰¿æŠ½è±¡ç±»</li><li>ä¸åŒçš„æ¥å£å¯ä»¥å¤šç»§æ‰¿ï¼Œä½†æ˜¯ä¸åŒçš„æŠ½è±¡ç±»åªèƒ½å•ç»§æ‰¿</li></ul><p>ä»¥ä¸Šã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å…ˆæ¥ä¸€ä¸ªé—®é¢˜ï¼Œjavaä¸­å…è®¸å¤šç»§æ‰¿å—ï¼Ÿ&lt;/p&gt;
&lt;h2 id=&quot;æŠ½è±¡ç±»-å•ç»§æ‰¿&quot;&gt;&lt;a href=&quot;#æŠ½è±¡ç±»-å•ç»§æ‰¿&quot; class=&quot;headerlink&quot; title=&quot;æŠ½è±¡ç±» - å•ç»§æ‰¿&quot;&gt;&lt;/a&gt;æŠ½è±¡ç±» - å•ç»§æ‰¿&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;å…³é”®å­—ä¸ºabstract,
      
    
    </summary>
    
    
      <category term="javaåŸºç¡€" scheme="http://joeljt.top/tags/java%E5%9F%BA%E7%A1%80/"/>
    
  </entry>
  
  <entry>
    <title>è‡ªå®šä¹‰ TextView</title>
    <link href="http://joeljt.top/2018/03/07/TextView/"/>
    <id>http://joeljt.top/2018/03/07/TextView/</id>
    <published>2018-03-06T16:00:00.000Z</published>
    <updated>2018-11-26T10:42:37.807Z</updated>
    
    <content type="html"><![CDATA[<h3 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h3><ul><li><p>ä¸€ä¸ªå‚æ•°</p><p>åœ¨ä»£ç ä¸­åˆå§‹åŒ–æ—¶ä½¿ç”¨</p></li><li><p>ä¸¤ä¸ªå‚æ•°</p><p>åœ¨å¸ƒå±€æ–‡ä»¶ä¸­ä½¿ç”¨æ—¶ï¼Œä¼šç»è¿‡è¿™ä¸ªæ–¹æ³•ï¼›ç¬¬äºŒä¸ªå‚æ•° <strong>attrs</strong> å°±æ˜¯ä¼ å…¥çš„è‡ªå®šä¹‰å±æ€§</p></li><li><p>ä¸‰ä¸ªå‚æ•°</p><p>åŒæ ·æ˜¯åœ¨å¸ƒå±€æ–‡ä»¶ä¸­ä½¿ç”¨ï¼Œä½†æ˜¯å½“æ–‡ä»¶ä¸­ä½¿ç”¨åˆ° style æ–‡ä»¶æ—¶æ‰ä¼šä½¿ç”¨ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ style æ–‡ä»¶</p></li></ul><h3 id="æµ‹é‡è§„æ ¼"><a href="#æµ‹é‡è§„æ ¼" class="headerlink" title="æµ‹é‡è§„æ ¼"></a>æµ‹é‡è§„æ ¼</h3><p>MeasureSpec æ˜¯ä¸€ä¸ª 32 ä½çš„ int å€¼ï¼Œå‰ 2 ä½è¡¨ç¤º SpecModeï¼Œå 30 ä½è¡¨ç¤º SpecSizeã€‚</p><p>MeasureSpec é€šè¿‡å°† SpecMode å’Œ SpecSize æ‰“åŒ…æˆä¸€ä¸ª int å€¼æ¥é¿å…è¿‡å¤šçš„å¯¹è±¡å†…å­˜åˆ†é…ï¼ŒåŒæ ·åœ¨ä½¿ç”¨åˆ°å…·ä½“çš„å±æ€§æ—¶ï¼Œå¯ä»¥é€šè¿‡è§£åŒ…çš„æ–¹å¼æ¥è·å–åŸå§‹å€¼ã€‚</p><pre><code> @Override    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {        // å…·ä½“åœ¨æµ‹é‡æ§ä»¶å¤§å°æ—¶ï¼Œå®½é«˜çš„ MeasureSpec éƒ½æ˜¯ç”±çˆ¶å¸ƒå±€ä¸€å±‚å±‚ä¼ é€’ä¸‹æ¥çš„        // MeasureSpec å¯ä»¥ç†è§£ä¸ºæ˜¯çˆ¶ View å¯¹å­ View çš„çš„æµ‹é‡è¦æ±‚        super.onMeasure(widthMeasureSpec, heightMeasureSpec);    }</code></pre><ul><li><p>MeasureSpec çš„ä¸‰ç§æƒ…å†µ</p><ul><li><p>AT_MOST</p><p>çˆ¶å®¹å™¨æŒ‡å®šäº†ä¸€ä¸ªå¯ç”¨å¤§å°ï¼Œå³ SpecSizeï¼Œå½“å‰å­ View å¤§å°ä¸èƒ½è¶…è¿‡è¿™ä¸ªå€¼</p><p>å¯¹åº”å¸ƒå±€æ–‡ä»¶ä¸­çš„ wrap_content</p></li><li><p>EXACTLY</p><p>çˆ¶å®¹å™¨å·²ç»æµ‹é‡å‡º View æ‰€éœ€è¦çš„ç²¾ç¡®å¤§å°ï¼Œå­ View æœ€ç»ˆçš„å¤§å°å°±æ˜¯æµ‹é‡åˆ°çš„å€¼</p><p>å¯¹åº”å¸ƒå±€æ–‡ä»¶ä¸­çš„ match_parent æˆ–è€…å›ºå®šæ•°å€¼</p></li><li><p>UNSECIFIED</p><p>ä¸€èˆ¬ç³»ç»Ÿçš„æ§ä»¶æ‰ä¼šä½¿ç”¨åˆ°è¿™ä¸ªï¼Œè‡ªå·±è‡ªå®šä¹‰ View çš„è¯ï¼Œå¾ˆå°‘ç”¨åˆ°</p></li></ul></li><li><p>ScrollView åµŒå¥— ListView çš„è§£å†³æ–¹æ³•çš„åŸç†</p><pre><code>public class ListViewForScrollView extends ListView {    public ListViewForScrollView(Context context) {        super(context);    }    public ListViewForScrollView(Context context, AttributeSet attrs) {        super(context, attrs);    }    public ListViewForScrollView(Context context, AttributeSet attrs,        int defStyle) {        super(context, attrs, defStyle);    }    @Override    /**     * é‡å†™è¯¥æ–¹æ³•ï¼Œè¾¾åˆ°ä½¿ListViewé€‚åº”ScrollViewçš„æ•ˆæœ     */    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {        // æ‰“åŒ…æ–¹æ³•ï¼Œé‡æ–°æ„é€  heightMeasureSpec        int expandSpec = MeasureSpec.makeMeasureSpec(Integer.MAX_VALUE &gt;&gt; 2,        MeasureSpec.AT_MOST);        super.onMeasure(widthMeasureSpec, expandSpec);    }}</code></pre><p>æˆ‘ä»¬çŸ¥é“ï¼ŒAndroid çš„æµ‹ç»˜æœºåˆ¶æ˜¯ä¸€ä¸ªé€’å½’çš„æµç¨‹ï¼Œä»æœ€é¡¶å±‚çš„å¼€å§‹ï¼Œä¾æ¬¡é€’å½’å‘ä¸‹æµ‹é‡å­ View ï¼Œå³è°ƒç”¨ measureChild() æ–¹æ³•ï¼Œä¸€å±‚å±‚æµ‹é‡åï¼Œæœ€åå†æµ‹é‡æœ€å¤–å±‚çš„ ViewGroup .</p><p>æŸ¥çœ‹ ScrollView çš„æºç ï¼š</p><pre><code>@Override    protected void measureChild(View child, int parentWidthMeasureSpec,            int parentHeightMeasureSpec) {        ViewGroup.LayoutParams lp = child.getLayoutParams();        int childWidthMeasureSpec;        int childHeightMeasureSpec;        childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec, mPaddingLeft                + mPaddingRight, lp.width);        final int verticalPadding = mPaddingTop + mPaddingBottom;        // ScrollView åœ¨å…·ä½“æµ‹é‡å­ View æ—¶ï¼Œå‘ä¸‹ä¼ é€’çš„æµ‹é‡è§„æ ¼ä¸º MeasureSpec.UNSPECIFIED        childHeightMeasureSpec = MeasureSpec.makeSafeMeasureSpec(                Math.max(0, MeasureSpec.getSize(parentHeightMeasureSpec) - verticalPadding),                MeasureSpec.UNSPECIFIED);        child.measure(childWidthMeasureSpec, childHeightMeasureSpec);    }</code></pre><p>ç†è®ºä¸Šè®²ï¼Œè¿™æ—¶å€™ä»£ç ä¼šèµ°åˆ° ListView çš„ onMeasure() æ–¹æ³•ä¸­ï¼š</p><pre><code>@Override    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {        super.onMeasure(widthMeasureSpec, heightMeasureSpec);        final int heightMode = MeasureSpec.getMode(heightMeasureSpec);        int heightSize = MeasureSpec.getSize(heightMeasureSpec);        int childHeight = 0;        ... ...        // è·å– ListView çš„é«˜åº¦ï¼Œæ­¤æ—¶åº”è¯¥åªæœ‰ä¸€ä¸ªæ¡ç›®çš„é«˜åº¦        childHeight = child.getMeasuredHeight();         ... ...        // é‡ç‚¹å°±åœ¨è¿™é‡Œ        // å¦‚æœæµ‹é‡æ¨¡å¼ä¸º MeasureSpec.UNSPECIFIEDï¼Œåˆ™æœ€ç»ˆçš„é«˜åº¦å°±æ˜¯å·²æµ‹é‡çš„é«˜åº¦ + padding        if (heightMode == MeasureSpec.UNSPECIFIED) {            heightSize = mListPadding.top + mListPadding.bottom + childHeight +                    getVerticalFadingEdgeLength() * 2;        }        // å¦‚æœä¸º AT_MOST ï¼Œåˆ™ä¼šè°ƒç”¨ measureHeightOfChildren() æ–¹æ³•ï¼Œé‡æ–°è®¡ç®— View é«˜åº¦        if (heightMode == MeasureSpec.AT_MOST) {            heightSize = measureHeightOfChildren(widthMeasureSpec, 0, NO_POSITION, heightSize, -1);        }        setMeasuredDimension(widthSize, heightSize);    }</code></pre><p>è€Œè‡³äº Integer.MAX_VALUE &gt;&gt; 2ï¼Œåˆ™æ˜¯å› ä¸º SpecSize æ˜¯ä¸€ä¸ª 30 ä½çš„å€¼ï¼Œä½¿ç”¨ Integer.MAX_VALUE æ˜¯å¸Œæœ›è¿™ä¸ªå€¼å°½å¯èƒ½çš„å¤§ï¼Œåœ¨åç»­ä¸ºå„ä¸ªæ¡ç›®æŒ‡å®šæµ‹é‡æ¨¡å¼æ—¶ï¼Œå› ä¸ºä¼ ä¸‹æ¥çš„æ˜¯ AT_MOST, å› æ­¤ resultSize å³ä¸ºä¼ ä¸‹æ¥çš„ Integer.MAX_VALUE &gt;&gt; 2ï¼Œä¿è¯æ¯ä¸ªæ¡ç›®çš„é«˜åº¦è‡ªé€‚åº”ã€‚</p><pre><code class="java">public static int getChildMeasureSpec(int spec, int padding, int childDimension) {        int specMode = MeasureSpec.getMode(spec);        int specSize = MeasureSpec.getSize(spec);        int size = Math.max(0, specSize - padding);        int resultSize = 0;        int resultMode = 0;        switch (specMode) {                 // Parent has imposed a maximum size on us            case MeasureSpec.AT_MOST:                if (childDimension &gt;= 0) {                    // Child wants a specific size... so be it                    resultSize = childDimension;                    resultMode = MeasureSpec.EXACTLY;                } else if (childDimension == LayoutParams.MATCH_PARENT) {                    // Child wants to be our size, but our size is not fixed.                    // Constrain child to not be bigger than us.                    resultSize = size;                    resultMode = MeasureSpec.AT_MOST;                } else if (childDimension == LayoutParams.WRAP_CONTENT) {                    // Child wants to determine its own size. It can&#39;t be                    // bigger than us.                    resultSize = size;                    resultMode = MeasureSpec.AT_MOST;                }                break;        }        //noinspection ResourceType        return MeasureSpec.makeMeasureSpec(resultSize, resultMode);}</code></pre><p>â€‹</p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;æ„é€ æ–¹æ³•&quot;&gt;&lt;a href=&quot;#æ„é€ æ–¹æ³•&quot; class=&quot;headerlink&quot; title=&quot;æ„é€ æ–¹æ³•&quot;&gt;&lt;/a&gt;æ„é€ æ–¹æ³•&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;ä¸€ä¸ªå‚æ•°&lt;/p&gt;
&lt;p&gt;åœ¨ä»£ç ä¸­åˆå§‹åŒ–æ—¶ä½¿ç”¨&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ä¸¤ä¸ªå‚æ•°&lt;/p&gt;
&lt;p&gt;åœ¨
      
    
    </summary>
    
    
      <category term="android" scheme="http://joeljt.top/tags/android/"/>
    
  </entry>
  
</feed>
